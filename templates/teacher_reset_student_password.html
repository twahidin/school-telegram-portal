{% extends "base.html" %}

{% block title %}Reset Student Password - Teacher Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark teacher-nav">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('teacher_dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>Teacher Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_dashboard') }}">
                        <i class="bi bi-speedometer2 me-1"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_assignments') }}">
                        <i class="bi bi-journal-text me-1"></i>Assignments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_submissions') }}">
                        <i class="bi bi-inbox me-1"></i>Submissions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_messages') }}">
                        <i class="bi bi-chat-dots me-1"></i>Messages
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('teacher_reset_student_password_page') }}">
                        <i class="bi bi-key me-1"></i>Reset Student Password
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_settings') }}">
                        <i class="bi bi-gear me-1"></i>Settings
                    </a>
                </li>
            </ul>
            <div class="navbar-nav">
                <span class="navbar-text me-3"><i class="bi bi-person-workspace me-1"></i>{{ teacher.name }}</span>
                <a class="nav-link" href="{{ url_for('teacher_logout') }}">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="page-header mb-4">
        <h1><i class="bi bi-key me-2"></i>Reset Student Password</h1>
        <p class="text-muted">Search for a student who forgot their password, then reset it for them.</p>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <label for="search-input" class="form-label">Search by student ID or name</label>
            <div class="input-group">
                <input type="text" class="form-control" id="search-input" placeholder="e.g. S1A2B3C4 or John" autocomplete="off">
                <button class="btn btn-primary" type="button" id="search-btn">
                    <i class="bi bi-search me-1"></i>Search
                </button>
            </div>
        </div>
    </div>

    <div id="search-results-section" class="card" style="display: none;">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-people me-2"></i>Results</h6>
        </div>
        <div class="card-body p-0">
            <div id="search-results-empty" class="text-muted text-center py-4" style="display: none;">
                No students found. Try a different search.
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="results-table" style="display: none;">
                    <thead class="table-light">
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <p class="text-muted small mt-3">
        <i class="bi bi-info-circle me-1"></i>Only students you teach (by class, teaching group, or assignment) appear in search. Click a student to reset their password.
    </p>
</div>

<!-- Reset password modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">
                    <i class="bi bi-key me-2"></i>Reset Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="reset-student-info" class="mb-3"></p>
                <div class="mb-3">
                    <label for="reset-custom-password" class="form-label">New password (optional)</label>
                    <input type="text" class="form-control" id="reset-custom-password" placeholder="Leave blank to use default: student123">
                    <small class="text-muted">Min 6 characters, must include letters and numbers.</small>
                </div>
                <p class="small text-muted mb-0">The student will be asked to change their password on next login.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="reset-confirm-btn">
                    <i class="bi bi-key me-1"></i>Reset Password
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    <div id="toast" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-message"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const resultsSection = document.getElementById('search-results-section');
    const resultsEmpty = document.getElementById('search-results-empty');
    const resultsTable = document.getElementById('results-table');
    const resultsTbody = document.getElementById('results-tbody');
    const resetModal = document.getElementById('resetModal');
    const resetStudentInfo = document.getElementById('reset-student-info');
    const resetCustomPassword = document.getElementById('reset-custom-password');
    const resetConfirmBtn = document.getElementById('reset-confirm-btn');

    let selectedStudent = null;

    function showToast(title, message) {
        document.getElementById('toast-title').textContent = title;
        document.getElementById('toast-message').textContent = message;
        new bootstrap.Toast(document.getElementById('toast')).show();
    }

    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') doSearch();
    });

    async function doSearch() {
        const q = searchInput.value.trim();
        if (!q) {
            showToast('Search', 'Enter a student ID or name.');
            return;
        }
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Searching...';
        try {
            const r = await fetch('/teacher/api/students/search?q=' + encodeURIComponent(q));
            const data = await r.json();
            const students = data.students || [];
            resultsSection.style.display = 'block';
            if (students.length === 0) {
                resultsEmpty.style.display = 'block';
                resultsTable.style.display = 'none';
            } else {
                resultsEmpty.style.display = 'none';
                resultsTable.style.display = 'table';
                resultsTbody.innerHTML = students.map(function(s) {
                    return '<tr class="student-row" data-id="' + (s.student_id || '').replace(/"/g, '&quot;') + '" data-name="' + (s.name || '').replace(/"/g, '&quot;') + '" data-class="' + (s.class || '').replace(/"/g, '&quot;') + '">' +
                        '<td>' + (s.student_id || '') + '</td>' +
                        '<td>' + (s.name || '') + '</td>' +
                        '<td>' + (s.class || '') + '</td>' +
                        '<td><button type="button" class="btn btn-sm btn-outline-primary reset-row-btn">Reset password</button></td></tr>';
                }).join('');
                resultsTbody.querySelectorAll('.student-row, .reset-row-btn').forEach(function(el) {
                    var row = el.classList.contains('student-row') ? el : el.closest('.student-row');
                    if (row) {
                        (el.classList.contains('reset-row-btn') ? el : row).addEventListener('click', function() {
                            openResetModal({
                                student_id: row.dataset.id,
                                name: row.dataset.name || row.dataset.id,
                                class: row.dataset.class || ''
                            });
                        });
                    }
                });
            }
        } catch (e) {
            showToast('Error', 'Search failed.');
        }
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<i class="bi bi-search me-1"></i>Search';
    }

    function openResetModal(student) {
        selectedStudent = student;
        resetStudentInfo.textContent = 'Reset password for ' + (student.name || student.student_id) + ' (' + student.student_id + ')?';
        resetCustomPassword.value = '';
        new bootstrap.Modal(resetModal).show();
    }

    resetConfirmBtn.addEventListener('click', async function() {
        if (!selectedStudent) return;
        const customPassword = resetCustomPassword.value.trim();
        resetConfirmBtn.disabled = true;
        resetConfirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Resetting...';
        try {
            const r = await fetch('/teacher/reset_student_passwords', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_ids: [selectedStudent.student_id],
                    password: customPassword || undefined
                })
            });
            const data = await r.json();
            if (data.success) {
                bootstrap.Modal.getInstance(resetModal).hide();
                showToast('Success', data.message + (data.password ? ' New password: ' + data.password : ''));
            } else {
                showToast('Error', data.error || 'Reset failed.');
            }
        } catch (e) {
            showToast('Error', 'Reset failed.');
        }
        resetConfirmBtn.disabled = false;
        resetConfirmBtn.innerHTML = '<i class="bi bi-key me-1"></i>Reset Password';
    });
})();
</script>
{% endblock %}
