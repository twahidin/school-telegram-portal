{% extends "base.html" %}

{% block title %}My Submissions - School Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>School Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('dashboard') }}">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('assignments_list') }}">
                        <i class="bi bi-journal-text me-1"></i>Assignments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('student_submissions') }}">
                        <i class="bi bi-check2-square me-1"></i>Submissions
                    </a>
                </li>
            </ul>
            <div class="navbar-nav">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-circle me-1"></i>{{ session.student_name }}
                </span>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="page-header mb-4">
        <h1><i class="bi bi-check2-square me-2"></i>My Submissions</h1>
        <p class="text-muted">Track your assignment submissions and feedback</p>
    </div>
    
    {% if submissions %}
    <div class="submissions-list">
        {% for submission in submissions %}
        <div class="submission-card">
            <div class="submission-status">
                {% set feedback_sent = submission.get('feedback_sent', False) %}
                {% if feedback_sent and submission.status == 'ai_reviewed' %}
                <span class="status-icon info"><i class="bi bi-robot"></i></span>
                {% elif submission.status == 'approved' or submission.status == 'reviewed' or feedback_sent %}
                <span class="status-icon success"><i class="bi bi-check-circle-fill"></i></span>
                {% elif submission.status in ['submitted', 'ai_reviewed'] %}
                <span class="status-icon warning"><i class="bi bi-hourglass-split"></i></span>
                {% else %}
                <span class="status-icon info"><i class="bi bi-pencil-fill"></i></span>
                {% endif %}
            </div>
            
            <div class="submission-info">
                <h5>{{ submission.assignment.title if submission.assignment else 'Unknown Assignment' }}{% if submission.get('version') %} <span class="text-muted">(Version {{ submission.version }})</span>{% endif %}</h5>
                <div class="submission-meta">
                    <span><i class="bi bi-journal me-1"></i>{{ submission.assignment.subject if submission.assignment else 'N/A' }}</span>
                    {% if submission.submitted_at %}
                    <span><i class="bi bi-clock me-1"></i>Submitted: {{ (submission.submitted_at|sgt).strftime('%d %b %Y, %H:%M') }} SGT</span>
                    {% endif %}
                    {% if submission.get('final_marks') is not none %}
                    <span class="score"><i class="bi bi-star-fill me-1"></i>Score: {{ submission.get('final_marks', 0) }}/{{ submission.assignment.total_marks if submission.assignment else '?' }}</span>
                    {% elif submission.teacher_review and submission.teacher_review.final_score is defined %}
                    <span class="score"><i class="bi bi-star-fill me-1"></i>Score: {{ submission.teacher_review.final_score }}/{{ submission.assignment.total_marks if submission.assignment else '?' }}</span>
                    {% endif %}
                </div>
                
                <div class="status-text mt-2">
                    {% set feedback_sent = submission.get('feedback_sent', False) %}
                    {% if feedback_sent and submission.status == 'ai_reviewed' %}
                    <span class="text-info"><i class="bi bi-robot me-1"></i>AI Feedback Received</span>
                    {% elif submission.status == 'approved' or submission.status == 'reviewed' or feedback_sent %}
                    <span class="text-success"><i class="bi bi-check-circle me-1"></i>Feedback received</span>
                    {% elif submission.status == 'ai_reviewed' %}
                    <span class="text-info"><i class="bi bi-robot me-1"></i>AI reviewed - awaiting teacher</span>
                    {% elif submission.status == 'submitted' %}
                    <span class="text-warning"><i class="bi bi-clock-history me-1"></i>Submitted - awaiting review</span>
                    {% else %}
                    <span class="text-muted"><i class="bi bi-pencil me-1"></i>Draft</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="submission-actions">
                <a href="{{ url_for('view_submission', submission_id=submission.submission_id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-eye me-1"></i>View
                </a>
                {% set feedback_sent = submission.get('feedback_sent', False) %}
                {% if submission.status == 'approved' or submission.status == 'reviewed' or feedback_sent %}
                <a href="{{ url_for('download_submission_pdf', submission_id=submission.submission_id) }}" class="btn btn-outline-success">
                    <i class="bi bi-download me-1"></i>PDF
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h4>No Submissions Yet</h4>
        <p>You haven't submitted any assignments yet.</p>
        <a href="{{ url_for('assignments_list') }}" class="btn btn-primary">
            <i class="bi bi-journal-text me-1"></i>Browse Assignments
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
