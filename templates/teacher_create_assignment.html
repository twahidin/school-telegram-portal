{% extends "base.html" %}

{% block title %}Create Assignment - Teacher Portal{% endblock %}

{% block navbar %}
{% set active_nav = 'assignments' %}
{% include 'partials/teacher_navbar.html' %}
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('teacher_assignments') }}">Assignments</a></li>
            <li class="breadcrumb-item active">Create New</li>
        </ol>
    </nav>
    
    <div class="page-header mb-4">
        <h1><i class="bi bi-plus-circle me-2"></i>Create Assignment</h1>
        <p class="text-muted">Upload your question paper and answer key PDFs</p>
    </div>
    
    {% if error %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-circle me-2"></i>{{ error }}
    </div>
    {% endif %}
    
    {% if success %}
    <div class="alert alert-success">
        <i class="bi bi-check-circle me-2"></i>{{ success }}
    </div>
    {% endif %}
    
    <form method="POST" enctype="multipart/form-data" id="create-assignment-form">
        <div class="row">
            <div class="col-lg-8">
                <!-- Basic Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">Assignment Title *</label>
                            <input type="text" class="form-control" id="title" name="title" required 
                                   placeholder="e.g., Chapter 5 Assessment">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="subject" class="form-label">Subject *</label>
                                <input type="text" class="form-control" id="subject" name="subject" required
                                       placeholder="e.g., Mathematics" list="subjects-list">
                                <datalist id="subjects-list">
                                    {% if teacher.subjects %}
                                    {% for subj in teacher.subjects %}
                                    <option value="{{ subj }}">
                                    {% endfor %}
                                    {% endif %}
                                </datalist>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="due_date" class="form-label">Due Date (optional)</label>
                                <input type="date" class="form-control" id="due_date" name="due_date">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="total_marks" class="form-label">Total Marks *</label>
                                <input type="number" class="form-control" id="total_marks" name="total_marks" 
                                       min="1" value="100" required placeholder="e.g., 100">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Assignment Type *</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="marking_type" id="marking_standard" value="standard" checked>
                                    <label class="form-check-label" for="marking_standard">
                                        <i class="bi bi-list-ol me-1"></i>Standard (Question-based)
                                    </label>
                                    <small class="text-muted d-block ms-4">For worksheets, quizzes, and tests with specific questions and answers</small>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio" name="marking_type" id="marking_rubric" value="rubric">
                                    <label class="form-check-label" for="marking_rubric">
                                        <i class="bi bi-file-text me-1"></i>Rubric-based (Essay)
                                    </label>
                                    <small class="text-muted d-block ms-4">For essays and written compositions graded using rubric criteria</small>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio" name="marking_type" id="marking_spreadsheet" value="spreadsheet">
                                    <label class="form-check-label" for="marking_spreadsheet">
                                        <i class="bi bi-file-earmark-excel me-1"></i>Spreadsheet assignment
                                    </label>
                                    <small class="text-muted d-block ms-4">For Excel-based tasks; students submit a spreadsheet and receive a PDF report and commented Excel with feedback</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Award marks vs Correct/Partial/Incorrect (Standard only; rubric always uses marks) -->
                        <div class="mb-3" id="award-marks-container">
                            <label class="form-label">Grading display (Standard only)</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="award_marks" id="award_marks_yes" value="on" checked>
                                <label class="form-check-label" for="award_marks_yes">
                                    <i class="bi bi-star me-1"></i>Award marks
                                </label>
                                <small class="text-muted d-block ms-4">Students see marks per question and total score</small>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="award_marks" id="award_marks_no" value="off">
                                <label class="form-check-label" for="award_marks_no">
                                    <i class="bi bi-check2-all me-1"></i>No marks (Correct / Partial correct / Incorrect)
                                </label>
                                <small class="text-muted d-block ms-4">Students see only result per question: Correct, Partial correct, or Incorrect</small>
                            </div>
                        </div>
                        
                        <!-- When to send feedback to student -->
                        <div class="mb-3">
                            <label class="form-label">When to send feedback to student</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="send_ai_feedback_immediately" id="feedback_teacher_first" value="off" checked>
                                <label class="form-check-label" for="feedback_teacher_first">
                                    <i class="bi bi-person-check me-1"></i>Teacher reviews first (default)
                                </label>
                                <small class="text-muted d-block ms-4">AI generates feedback but students only see it after you review and send</small>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="send_ai_feedback_immediately" id="feedback_ai_straightaway" value="on">
                                <label class="form-check-label" for="feedback_ai_straightaway">
                                    <i class="bi bi-robot me-1"></i>Send AI feedback to student straight away
                                </label>
                                <small class="text-muted d-block ms-4">Students see AI feedback as soon as they submit (you can still review and add comments later)</small>
                            </div>
                        </div>
                        
                        <!-- Release answer key PDF to students after they submit (standard/rubric only) -->
                        <div class="mb-3" id="release-answer-key-container">
                            <label class="form-label">Answer key visibility</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="release_answer_key_pdf" id="release_answer_key_pdf" value="on">
                                <label class="form-check-label" for="release_answer_key_pdf">
                                    <i class="bi bi-file-pdf me-1"></i>Release answer key PDF to students after they submit
                                </label>
                                <small class="text-muted d-block ms-4">When enabled, students can download the answer key PDF once they have submitted (while AI or teacher is reviewing, and after feedback). Only applies to assignments with an answer key PDF.</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="instructions" class="form-label">Instructions (optional)</label>
                            <textarea class="form-control" id="instructions" name="instructions" rows="3"
                                      placeholder="Add any special instructions for students..."></textarea>
                        </div>
                        {% if teacher_modules is defined and teacher_modules %}
                        <div class="mb-3">
                            <label for="linked_module_id" class="form-label">Link to module (optional)</label>
                            <select class="form-select" id="linked_module_id" name="linked_module_id">
                                <option value="">— No link —</option>
                                {% for mod in teacher_modules %}
                                <option value="{{ mod.module_id }}">{{ mod.title }} ({{ mod.subject }}{% if mod.year_level %} · {{ mod.year_level }}{% endif %})</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Linking to a module updates the student's mastery and learning profile when feedback is sent. You can link to draft (unpublished) modules.</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Upload Documents - Moved here between Basic Info and Assign To -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-file-pdf me-2"></i>Upload Documents</h5>
                        {% if teacher.google_drive_source_folder_id %}
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleDriveBrowser()">
                            <i class="bi bi-google-drive me-1"></i>Browse Google Drive
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if teacher.google_drive_source_folder_id %}
                        <div id="drive-browser" style="display: none;" class="mb-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="bi bi-google-drive me-2"></i>Select from Google Drive</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Select File Type First:</label>
                                        <select class="form-select mb-2" id="drive-file-type-select" onchange="setDriveFileType(this.value)">
                                            <option value="">-- Choose which file to select --</option>
                                            <option value="question">Question Paper</option>
                                            <option value="answer">Answer Key</option>
                                            <option value="reference">Reference Materials</option>
                                            <option value="rubrics">Rubrics</option>
                                        </select>
                                        <label class="form-label">Then Select File:</label>
                                        <select class="form-select" id="drive-file-select" onchange="selectDriveFile(this.value, this)" disabled>
                                            <option value="">-- Select file type first --</option>
                                        </select>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-primary" onclick="loadDriveFiles()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleDriveBrowser()">
                                            Cancel
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mt-2">
                                        <i class="bi bi-info-circle me-1"></i>You can select PDFs, Google Docs, or Google Sheets. They will be converted to PDF automatically.
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <!-- Standard/Rubric uploads (question paper + answer key or rubrics) -->
                        <div id="upload-docs-standard-rubric" class="row">
                            <!-- Question Paper -->
                            <div class="col-md-6 mb-3">
                                <div class="upload-zone" id="question-zone">
                                    <input type="file" class="form-control d-none" id="question_paper" name="question_paper" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'question')">
                                    <input type="hidden" id="question_paper_drive_id" name="question_paper_drive_id">
                                    <label for="question_paper" class="upload-label">
                                        <div class="upload-icon">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </div>
                                        <h6>Question Paper *</h6>
                                        <p class="text-muted small mb-0">Empty paper for students</p>
                                        <span class="file-name" id="question-filename">Click to upload PDF</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Answer Key -->
                            <div class="col-md-6 mb-3" id="answer-key-container">
                                <div class="upload-zone" id="answer-zone">
                                    <input type="file" class="form-control d-none" id="answer_key" name="answer_key" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'answer')">
                                    <input type="hidden" id="answer_key_drive_id" name="answer_key_drive_id">
                                    <label for="answer_key" class="upload-label">
                                        <div class="upload-icon answer">
                                            <i class="bi bi-file-earmark-check"></i>
                                        </div>
                                        <h6 id="answer-key-title">Answer Key *</h6>
                                        <p class="text-muted small mb-0" id="answer-key-desc">Questions with answers</p>
                                        <span class="file-name" id="answer-filename">Click to upload PDF</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Spreadsheet assignment: Excel template, Excel answer key, Question paper PDF -->
                        <div id="upload-docs-spreadsheet" class="row" style="display: none;">
                            <div class="col-md-4 mb-3">
                                <div class="upload-zone" id="spreadsheet_template-zone">
                                    <input type="file" class="form-control d-none" id="spreadsheet_student_template" name="spreadsheet_student_template" 
                                           accept=".xlsx,.xls" onchange="handleFileSelect(this, 'spreadsheet_template')">
                                    <label for="spreadsheet_student_template" class="upload-label">
                                        <div class="upload-icon spreadsheet">
                                            <i class="bi bi-file-earmark-excel"></i>
                                        </div>
                                        <h6>Excel student template *</h6>
                                        <p class="text-muted small mb-0">Blank template for students</p>
                                        <span class="file-name" id="spreadsheet_template-filename">Click to upload .xlsx</span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="upload-zone" id="spreadsheet_answer-zone">
                                    <input type="file" class="form-control d-none" id="spreadsheet_answer_key" name="spreadsheet_answer_key" 
                                           accept=".xlsx,.xls" onchange="handleFileSelect(this, 'spreadsheet_answer')">
                                    <label for="spreadsheet_answer_key" class="upload-label">
                                        <div class="upload-icon answer">
                                            <i class="bi bi-file-earmark-excel"></i>
                                        </div>
                                        <h6>Excel answer key *</h6>
                                        <p class="text-muted small mb-0">Template with correct answers</p>
                                        <span class="file-name" id="spreadsheet_answer-filename">Click to upload .xlsx</span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="upload-zone" id="spreadsheet_question-zone">
                                    <input type="file" class="form-control d-none" id="spreadsheet_question_paper" name="spreadsheet_question_paper" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'spreadsheet_question')">
                                    <label for="spreadsheet_question_paper" class="upload-label">
                                        <div class="upload-icon">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </div>
                                        <h6>Question paper (PDF) *</h6>
                                        <p class="text-muted small mb-0">Instructions / questions</p>
                                        <span class="file-name" id="spreadsheet_question-filename">Click to upload PDF</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Reference Materials -->
                            <div class="col-md-6 mb-3">
                                <div class="upload-zone" id="reference-zone">
                                    <input type="file" class="form-control d-none" id="reference_materials" name="reference_materials" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'reference')">
                                    <input type="hidden" id="reference_materials_drive_id" name="reference_materials_drive_id">
                                    <label for="reference_materials" class="upload-label">
                                        <div class="upload-icon reference">
                                            <i class="bi bi-book"></i>
                                        </div>
                                        <h6>Reference Materials</h6>
                                        <p class="text-muted small mb-0">Literature, history content, etc.</p>
                                        <span class="file-name" id="reference-filename">Click to upload PDF (optional)</span>
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-1">Upload textual content, passages, or source materials the AI should reference when grading.</small>
                            </div>
                            
                            <!-- Rubrics -->
                            <div class="col-md-6 mb-3" id="rubrics-container">
                                <div class="upload-zone" id="rubrics-zone">
                                    <input type="file" class="form-control d-none" id="rubrics" name="rubrics" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'rubrics')">
                                    <input type="hidden" id="rubrics_drive_id" name="rubrics_drive_id">
                                    <label for="rubrics" class="upload-label">
                                        <div class="upload-icon rubrics">
                                            <i class="bi bi-list-check"></i>
                                        </div>
                                        <h6 id="rubrics-title">Rubrics</h6>
                                        <p class="text-muted small mb-0" id="rubrics-desc">Grading criteria for essays</p>
                                        <span class="file-name" id="rubrics-filename">Click to upload PDF (optional)</span>
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-1" id="rubrics-help">Upload grading rubrics for essays, literature, or subjective answers where there's no single correct answer.</small>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Note:</strong> The answer key PDF should contain both the questions and the correct answers. 
                            Reference materials and rubrics help the AI understand context for subjects like English/Literature where answers may vary.
                            <br><small class="mt-1 d-block"><i class="bi bi-check-circle me-1"></i>Answer key uses full PDF vision for maximum accuracy. Reference materials &amp; rubrics use text extraction for efficiency.</small>
                            <br><small class="mt-1 d-block"><i class="bi bi-google-drive me-1"></i><strong>Google Drive files:</strong> Files selected from Google Drive are referenced directly (not copied). They remain in your Drive folder and are fetched on-demand when needed.</small>
                        </div>
                    </div>
                </div>
                
                <!-- Assignment Target (Class or Teaching Group) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Assign To</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Choose whether to assign this to an entire class or a specific teaching group.</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Assignment Target *</label>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="target_type" id="target_class" value="class" checked>
                                        <label class="form-check-label" for="target_class">
                                            <i class="bi bi-collection me-1"></i>Entire Class
                                        </label>
                                    </div>
                                    <select class="form-select mt-2" id="target_class_id" name="target_class_id">
                                        <option value="">Select a class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="target_type" id="target_group" value="teaching_group">
                                        <label class="form-check-label" for="target_group">
                                            <i class="bi bi-diagram-3 me-1"></i>Teaching Group
                                        </label>
                                    </div>
                                    <select class="form-select mt-2" id="target_group_id" name="target_group_id" disabled>
                                        <option value="">Select a teaching group...</option>
                                        {% for g in teaching_groups %}
                                        <option value="{{ g.group_id }}">{{ g.name }} ({{ g.class_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <small class="text-muted">Leave empty to make the assignment available to all your students.</small>
                        </div>
                    </div>
                </div>
                
                <!-- AI Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Marking Configuration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Configure which AI model to use for reviewing and grading this assignment, and provide additional instructions for feedback and grading.</p>
                        
                        <div class="mb-3">
                            <label for="ai_model" class="form-label">AI Model for This Assignment *</label>
                            {% set default_model = teacher.get('default_ai_model', 'anthropic') %}
                            <select class="form-select" id="ai_model" name="ai_model" required>
                                <option value="anthropic" {% if default_model == 'anthropic' %}selected{% endif %}>Anthropic (Claude)</option>
                                <option value="openai" {% if default_model == 'openai' %}selected{% endif %}>OpenAI (GPT)</option>
                                <option value="deepseek" {% if default_model == 'deepseek' %}selected{% endif %}>DeepSeek</option>
                                <option value="google" {% if default_model == 'google' %}selected{% endif %}>Google Gemini</option>
                            </select>
                            <small class="text-muted">Your default model: <strong>{{ default_model|title }}</strong></small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="feedback_instructions" class="form-label">Additional Instructions for Feedback (optional)</label>
                            <textarea class="form-control" id="feedback_instructions" name="feedback_instructions" rows="3"
                                      placeholder="e.g., Focus on explaining common mistakes, provide step-by-step guidance, emphasize conceptual understanding..."></textarea>
                            <small class="text-muted">These instructions will guide the AI when providing feedback to students.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="grading_instructions" class="form-label">Additional Instructions for Grading (optional)</label>
                            <textarea class="form-control" id="grading_instructions" name="grading_instructions" rows="3"
                                      placeholder="e.g., Be strict with calculation errors, award partial credit for showing work, deduct points for missing units..."></textarea>
                            <small class="text-muted">These instructions will guide the AI when grading student submissions.</small>
                        </div>
                    </div>
                </div>
                
                <!-- Student AI Help Limits -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Student AI Help Limits</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Control how many times students can request AI help for this assignment. This helps manage API costs.</p>
                        
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Note:</strong> Students will see alerts on their dashboard about remaining help requests.
                        </div>
                        
                        <div class="row">
                            <!-- Overall Review Settings -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable_overall_review" name="enable_overall_review" checked>
                                            <label class="form-check-label fw-bold" for="enable_overall_review">
                                                <i class="bi bi-eye me-1"></i>Enable Overall Review
                                            </label>
                                        </div>
                                        <p class="text-muted small mb-2">Students can request AI to review their entire submission before final submit.</p>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">Max reviews</span>
                                            <input type="number" class="form-control" id="overall_review_limit" name="overall_review_limit" 
                                                   value="1" min="0" max="10">
                                            <span class="input-group-text">times</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Question Help Settings -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable_question_help" name="enable_question_help" checked>
                                            <label class="form-check-label fw-bold" for="enable_question_help">
                                                <i class="bi bi-question-circle me-1"></i>Enable Question Help
                                            </label>
                                        </div>
                                        <p class="text-muted small mb-2">Students can ask AI for hints and guidance on specific questions.</p>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">Max questions</span>
                                            <input type="number" class="form-control" id="question_help_limit" name="question_help_limit" 
                                                   value="5" min="0" max="50">
                                            <span class="input-group-text">times</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- Summary & Actions -->
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="summary-item">
                            <span>Question Paper:</span>
                            <strong id="summary-question"><span class="text-danger">Not uploaded</span></strong>
                        </div>
                        <div class="summary-item">
                            <span>Answer Key:</span>
                            <strong id="summary-answer"><span class="text-danger">Not uploaded</span></strong>
                        </div>
                        <div class="summary-item">
                            <span>Reference Materials:</span>
                            <strong id="summary-reference"><span class="text-muted">Optional</span></strong>
                        </div>
                        <div class="summary-item">
                            <span>Rubrics:</span>
                            <strong id="summary-rubrics"><span class="text-muted">Optional</span></strong>
                        </div>
                        <div id="summary-spreadsheet_template-row" class="summary-item" style="display: none;">
                            <span>Excel template:</span>
                            <strong id="summary-spreadsheet_template"><span class="text-danger">Not uploaded</span></strong>
                        </div>
                        <div id="summary-spreadsheet_answer-row" class="summary-item" style="display: none;">
                            <span>Excel answer key:</span>
                            <strong id="summary-spreadsheet_answer"><span class="text-danger">Not uploaded</span></strong>
                        </div>
                        <div id="summary-spreadsheet_question-row" class="summary-item" style="display: none;">
                            <span>Question paper (PDF):</span>
                            <strong id="summary-spreadsheet_question"><span class="text-danger">Not uploaded</span></strong>
                        </div>
                        <div class="summary-item">
                            <span>Marking Type:</span>
                            <strong id="summary-marking-type"><span class="text-primary">Standard</span></strong>
                        </div>
                        <div class="summary-item">
                            <span>Total Marks:</span>
                            <strong id="summary-marks">100</strong>
                        </div>
                        <div class="summary-item" id="summary-award-marks-row">
                            <span>Grading display:</span>
                            <strong id="summary-award-marks">Marks</strong>
                        </div>
                        
                        <hr>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="publish" name="publish" checked>
                            <label class="form-check-label" for="publish">
                                Publish immediately
                            </label>
                            <small class="d-block text-muted">If unchecked, assignment will be saved as draft</small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="bi bi-save me-2"></i>Save Assignment
                            </button>
                            <a href="{{ url_for('teacher_assignments') }}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    background: #fafafa;
}

.upload-zone:hover,
.upload-zone.dragover {
    border-color: var(--teacher-primary);
    background: #f0f7ff;
}

.upload-zone.has-file {
    border-color: #28a745;
    background: #f0fff4;
}

.upload-label {
    cursor: pointer;
    display: block;
    margin: 0;
}

.upload-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #0d6efd, #0a58ca);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
}

.upload-icon.answer {
    background: linear-gradient(135deg, #198754, #146c43);
}

.upload-icon.reference {
    background: linear-gradient(135deg, #6f42c1, #5a32a3);
}

.upload-icon.rubrics {
    background: linear-gradient(135deg, #fd7e14, #dc6a10);
}

.upload-icon.spreadsheet {
    background: linear-gradient(135deg, #217346, #1d6b3c);
}

.upload-icon i {
    font-size: 28px;
    color: white;
}

.file-name {
    display: block;
    margin-top: 10px;
    padding: 8px 12px;
    background: white;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #6c757d;
    word-break: break-all;
}

.upload-zone.has-file .file-name {
    color: #28a745;
    font-weight: 500;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.summary-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    function handleFileSelect(input, type) {
        const zone = document.getElementById(type + '-zone');
        const filename = document.getElementById(type + '-filename');
        const summary = document.getElementById('summary-' + type);
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            zone.classList.add('has-file');
            filename.textContent = file.name;
            summary.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Uploaded</span>';
        } else {
            zone.classList.remove('has-file');
            filename.textContent = 'Click to upload PDF';
            summary.innerHTML = '<span class="text-danger">Not uploaded</span>';
        }
        
        validateForm();
    }
    
    // Update marks summary
    document.getElementById('total_marks').addEventListener('input', function() {
        document.getElementById('summary-marks').textContent = this.value || '0';
    });
    
    // Drag and drop
    ['question-zone', 'answer-zone', 'reference-zone', 'rubrics-zone'].forEach(zoneId => {
        const zone = document.getElementById(zoneId);
        const input = zone.querySelector('input[type="file"]');
        
        ['dragenter', 'dragover'].forEach(eventName => {
            zone.addEventListener(eventName, (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
            });
        });
        
        zone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length && files[0].type === 'application/pdf') {
                input.files = files;
                input.dispatchEvent(new Event('change'));
            }
        });
    });
    
    function validateForm() {
        const questionPaper = document.getElementById('question_paper').files.length > 0 || 
                             document.getElementById('question_paper_drive_id').value;
        const answerKey = document.getElementById('answer_key').files.length > 0 || 
                         document.getElementById('answer_key_drive_id').value;
        const rubrics = document.getElementById('rubrics').files.length > 0 || 
                       document.getElementById('rubrics_drive_id').value;
        const spreadsheetTemplate = document.getElementById('spreadsheet_student_template').files.length > 0;
        const spreadsheetAnswer = document.getElementById('spreadsheet_answer_key').files.length > 0;
        const spreadsheetQuestion = document.getElementById('spreadsheet_question_paper').files.length > 0;
        const markingType = document.querySelector('input[name="marking_type"]:checked').value;
        const submitBtn = document.getElementById('submit-btn');
        
        if (markingType === 'spreadsheet') {
            submitBtn.disabled = !(spreadsheetTemplate && spreadsheetAnswer && spreadsheetQuestion);
        } else if (markingType === 'rubric') {
            submitBtn.disabled = !(questionPaper && rubrics);
        } else {
            submitBtn.disabled = !(questionPaper && answerKey);
        }
    }
    
    // Form validation
    document.getElementById('create-assignment-form').addEventListener('submit', function(e) {
        const questionPaper = document.getElementById('question_paper').files.length > 0 || 
                             document.getElementById('question_paper_drive_id').value;
        const answerKey = document.getElementById('answer_key').files.length > 0 || 
                         document.getElementById('answer_key_drive_id').value;
        const rubrics = document.getElementById('rubrics').files.length > 0 || 
                       document.getElementById('rubrics_drive_id').value;
        const spreadsheetTemplate = document.getElementById('spreadsheet_student_template').files.length > 0;
        const spreadsheetAnswer = document.getElementById('spreadsheet_answer_key').files.length > 0;
        const spreadsheetQuestion = document.getElementById('spreadsheet_question_paper').files.length > 0;
        const markingType = document.querySelector('input[name="marking_type"]:checked').value;
        
        if (markingType === 'spreadsheet') {
            if (!spreadsheetTemplate || !spreadsheetAnswer || !spreadsheetQuestion) {
                e.preventDefault();
                alert('For spreadsheet assignments please upload: Excel student template, Excel answer key, and Question paper (PDF).');
                return false;
            }
        } else if (markingType === 'rubric') {
            if (!questionPaper || !rubrics) {
                e.preventDefault();
                alert('Please upload or select from Google Drive both the question paper and rubrics PDFs for rubric-based marking.');
                return false;
            }
        } else {
            if (!questionPaper || !answerKey) {
                e.preventDefault();
                alert('Please upload or select from Google Drive both the question paper and answer key PDFs.');
                return false;
            }
        }
    });
    
    // Handle marking type toggle
    document.querySelectorAll('input[name="marking_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const isRubric = this.value === 'rubric';
            const isSpreadsheet = this.value === 'spreadsheet';
            updateMarkingTypeUI(isRubric, isSpreadsheet);
            validateForm();
        });
    });
    
    function updateMarkingTypeUI(isRubric, isSpreadsheet) {
        isSpreadsheet = !!isSpreadsheet;
        const uploadStandard = document.getElementById('upload-docs-standard-rubric');
        const uploadSpreadsheet = document.getElementById('upload-docs-spreadsheet');
        if (uploadStandard) uploadStandard.style.display = isSpreadsheet ? 'none' : 'flex';
        if (uploadSpreadsheet) uploadSpreadsheet.style.display = isSpreadsheet ? 'flex' : 'none';
        ['spreadsheet_template', 'spreadsheet_answer', 'spreadsheet_question'].forEach(function(t) {
            const row = document.getElementById('summary-' + t + '-row');
            if (row) row.style.display = isSpreadsheet ? 'flex' : 'none';
        });
        const questionSummaryRow = document.querySelector('.summary-item:has(#summary-question)');
        const answerSummaryRow = document.querySelector('.summary-item:has(#summary-answer)');
        if (questionSummaryRow) questionSummaryRow.style.display = isSpreadsheet ? 'none' : 'flex';
        if (answerSummaryRow) answerSummaryRow.style.display = isSpreadsheet ? 'none' : 'flex';
        const awardMarksContainer = document.getElementById('award-marks-container');
        if (awardMarksContainer) {
            awardMarksContainer.style.display = (isRubric || isSpreadsheet) ? 'none' : 'block';
            if (isRubric) document.getElementById('award_marks_yes').checked = true;
        }
        const releaseAnswerKeyContainer = document.getElementById('release-answer-key-container');
        if (releaseAnswerKeyContainer) releaseAnswerKeyContainer.style.display = isSpreadsheet ? 'none' : 'block';
        // Update answer key section
        const answerKeyTitle = document.getElementById('answer-key-title');
        const answerKeyDesc = document.getElementById('answer-key-desc');
        const answerFilename = document.getElementById('answer-filename');
        const summaryAnswer = document.getElementById('summary-answer');
        
        // Update rubrics section
        const rubricsTitle = document.getElementById('rubrics-title');
        const rubricsDesc = document.getElementById('rubrics-desc');
        const rubricsFilename = document.getElementById('rubrics-filename');
        const rubricsHelp = document.getElementById('rubrics-help');
        const summaryRubrics = document.getElementById('summary-rubrics');
        
        // Update marking type summary
        const summaryMarkingType = document.getElementById('summary-marking-type');
        if (isSpreadsheet && summaryMarkingType) {
            summaryMarkingType.innerHTML = '<span class="text-success">Spreadsheet</span>';
        } else if (isRubric) {
            // Rubric-based marking: answer key optional, rubrics required
            answerKeyTitle.innerHTML = 'Answer Key';
            answerKeyDesc.textContent = 'Optional model essay/answer';
            if (!document.getElementById('answer_key').files.length) {
                answerFilename.textContent = 'Click to upload PDF (optional)';
                summaryAnswer.innerHTML = '<span class="text-muted">Optional</span>';
            }
            
            rubricsTitle.innerHTML = 'Rubrics *';
            rubricsDesc.textContent = 'Required grading criteria';
            rubricsHelp.innerHTML = '<strong>Required:</strong> Upload the rubrics document containing the criteria for grading this essay.';
            if (!document.getElementById('rubrics').files.length) {
                rubricsFilename.textContent = 'Click to upload PDF';
                summaryRubrics.innerHTML = '<span class="text-danger">Not uploaded</span>';
            }
            
            summaryMarkingType.innerHTML = '<span class="text-warning">Rubric (Essay)</span>';
        } else {
            // Standard marking: answer key required, rubrics optional
            answerKeyTitle.innerHTML = 'Answer Key *';
            answerKeyDesc.textContent = 'Questions with answers';
            if (!document.getElementById('answer_key').files.length) {
                answerFilename.textContent = 'Click to upload PDF';
                summaryAnswer.innerHTML = '<span class="text-danger">Not uploaded</span>';
            }
            
            rubricsTitle.innerHTML = 'Rubrics';
            rubricsDesc.textContent = 'Grading criteria for essays';
            rubricsHelp.textContent = 'Upload grading rubrics for essays, literature, or subjective answers where there\'s no single correct answer.';
            if (!document.getElementById('rubrics').files.length) {
                rubricsFilename.textContent = 'Click to upload PDF (optional)';
                summaryRubrics.innerHTML = '<span class="text-muted">Optional</span>';
            }
            
            summaryMarkingType.innerHTML = '<span class="text-primary">Standard</span>';
        }
        updateSummaryAwardMarks();
    }
    
    function updateSummaryAwardMarks() {
        const isRubric = document.getElementById('marking_rubric') && document.getElementById('marking_rubric').checked;
        const isSpreadsheet = document.getElementById('marking_spreadsheet') && document.getElementById('marking_spreadsheet').checked;
        const row = document.getElementById('summary-award-marks-row');
        const el = document.getElementById('summary-award-marks');
        if (!row || !el) return;
        if (isRubric || isSpreadsheet) {
            row.style.display = 'none';
            return;
        }
        row.style.display = 'flex';
        el.textContent = document.getElementById('award_marks_yes')?.checked ? 'Marks' : 'Correct / Partial / Incorrect';
    }
    
    document.querySelectorAll('input[name="award_marks"]').forEach(radio => {
        radio.addEventListener('change', updateSummaryAwardMarks);
    });
    
    // Initial validation and UI (marking type + award marks)
    const initialRubric = document.getElementById('marking_rubric') && document.getElementById('marking_rubric').checked;
    const initialSpreadsheet = document.getElementById('marking_spreadsheet') && document.getElementById('marking_spreadsheet').checked;
    updateMarkingTypeUI(!!initialRubric, !!initialSpreadsheet);
    updateSummaryAwardMarks();
    validateForm();
    
    // Google Drive file browser
    let currentFileType = null;
    
    function toggleDriveBrowser() {
        const browser = document.getElementById('drive-browser');
        if (browser) {
            browser.style.display = browser.style.display === 'none' ? 'block' : 'none';
            if (browser.style.display === 'block') {
                loadDriveFiles();
                // Reset selections
                document.getElementById('drive-file-type-select').value = '';
                document.getElementById('drive-file-select').value = '';
                document.getElementById('drive-file-select').disabled = true;
                currentFileType = null;
            }
        }
    }
    
    function setDriveFileType(fileType) {
        currentFileType = fileType;
        const fileSelect = document.getElementById('drive-file-select');
        if (fileType) {
            fileSelect.disabled = false;
        } else {
            fileSelect.disabled = true;
            fileSelect.value = '';
        }
    }
    
    async function loadDriveFiles() {
        const select = document.getElementById('drive-file-select');
        if (!select) return;
        
        select.innerHTML = '<option value="">Loading files...</option>';
        select.disabled = true;
        
        try {
            const response = await fetch('/api/teacher/drive/files');
            const data = await response.json();
            
            if (data.success && data.files && data.files.length > 0) {
                select.innerHTML = '<option value="">-- Select a file from Google Drive --</option>';
                data.files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.id;
                    option.textContent = `${file.name} (${file.type.toUpperCase()})`;
                    option.dataset.name = file.name;
                    option.dataset.type = file.type;
                    select.appendChild(option);
                });
                select.disabled = false;
                
                // Show success message
                if (data.count && typeof showToast === 'function') {
                    showToast('Success', `Loaded ${data.count} file(s) from Google Drive`, 'success');
                }
            } else if (data.success && data.files && data.files.length === 0) {
                select.innerHTML = '<option value="">No PDFs, Docs, or Sheets found in this folder</option>';
                const msg = 'No files found. Make sure the folder contains PDFs, Google Docs, or Google Sheets.';
                if (typeof showToast === 'function') {
                    showToast('Info', msg, 'info');
                } else {
                    alert(msg);
                }
            } else {
                const errorMsg = data.error || 'Unknown error loading files';
                select.innerHTML = `<option value="">Error: ${errorMsg}</option>`;
                if (typeof showToast === 'function') {
                    showToast('Error', errorMsg, 'danger');
                } else {
                    alert('Error: ' + errorMsg);
                }
                console.error('Drive API error:', data);
            }
        } catch (error) {
            console.error('Error loading Drive files:', error);
            select.innerHTML = '<option value="">Network error loading files</option>';
            const msg = 'Failed to connect to server. Please try again.';
            if (typeof showToast === 'function') {
                showToast('Error', msg, 'danger');
            } else {
                alert(msg);
            }
        }
    }
    
    function selectDriveFile(fileId, selectElement) {
        if (!fileId || !currentFileType) {
            alert('Please select a file type first');
            return;
        }
        
        const select = document.getElementById('drive-file-select');
        const selectedOption = select.options[select.selectedIndex];
        if (!selectedOption || !selectedOption.value) return;
        
        const name = selectedOption.dataset.name || selectedOption.textContent.split(' (')[0];
        const type = selectedOption.dataset.type || 'pdf';
        
        // Set the hidden drive ID field
        const driveIdField = document.getElementById(`${currentFileType}_drive_id`);
        if (driveIdField) {
            driveIdField.value = fileId;
        }
        
        // Clear any uploaded file for this field
        const fileInput = document.getElementById(currentFileType === 'answer' ? 'answer_key' : 
                                                 currentFileType === 'reference' ? 'reference_materials' : 
                                                 currentFileType);
        if (fileInput) {
            fileInput.value = '';
        }
        
        // Update UI
        const zone = document.getElementById(`${currentFileType}-zone`);
        const filename = document.getElementById(`${currentFileType}-filename`);
        const summary = document.getElementById(`summary-${currentFileType}`);
        
        if (zone && filename) {
            zone.classList.add('has-file');
            filename.textContent = `${name} (from Drive)`;
            if (summary) {
                summary.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Selected from Drive</span>';
            }
        }
        
        // Reset and hide browser
        document.getElementById('drive-file-type-select').value = '';
        document.getElementById('drive-file-select').value = '';
        document.getElementById('drive-file-select').disabled = true;
        currentFileType = null;
        toggleDriveBrowser();
        validateForm();
    }
    
    // Toggle between class and teaching group selection
    document.querySelectorAll('input[name="target_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const isClass = this.value === 'class';
            document.getElementById('target_class_id').disabled = !isClass;
            document.getElementById('target_group_id').disabled = isClass;
            
            // Clear the disabled field
            if (isClass) {
                document.getElementById('target_group_id').value = '';
            } else {
                document.getElementById('target_class_id').value = '';
            }
        });
    });
</script>
{% endblock %}
