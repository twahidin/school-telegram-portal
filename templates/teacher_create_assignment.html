{% extends "base.html" %}

{% block title %}Create Assignment - Teacher Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark teacher-nav">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('teacher_dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>Teacher Portal
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="{{ url_for('teacher_logout') }}">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('teacher_assignments') }}">Assignments</a></li>
            <li class="breadcrumb-item active">Create New</li>
        </ol>
    </nav>
    
    <div class="page-header mb-4">
        <h1><i class="bi bi-plus-circle me-2"></i>Create Assignment</h1>
        <p class="text-muted">Upload your question paper and answer key PDFs</p>
    </div>
    
    {% if error %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-circle me-2"></i>{{ error }}
    </div>
    {% endif %}
    
    {% if success %}
    <div class="alert alert-success">
        <i class="bi bi-check-circle me-2"></i>{{ success }}
    </div>
    {% endif %}
    
    <form method="POST" enctype="multipart/form-data" id="create-assignment-form">
        <div class="row">
            <div class="col-lg-8">
                <!-- Basic Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">Assignment Title *</label>
                            <input type="text" class="form-control" id="title" name="title" required 
                                   placeholder="e.g., Chapter 5 Assessment">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="subject" class="form-label">Subject *</label>
                                <input type="text" class="form-control" id="subject" name="subject" required
                                       placeholder="e.g., Mathematics" list="subjects-list">
                                <datalist id="subjects-list">
                                    {% if teacher.subjects %}
                                    {% for subj in teacher.subjects %}
                                    <option value="{{ subj }}">
                                    {% endfor %}
                                    {% endif %}
                                </datalist>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="due_date" class="form-label">Due Date (optional)</label>
                                <input type="date" class="form-control" id="due_date" name="due_date">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="total_marks" class="form-label">Total Marks *</label>
                                <input type="number" class="form-control" id="total_marks" name="total_marks" 
                                       min="1" value="100" required placeholder="e.g., 100">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="instructions" class="form-label">Instructions (optional)</label>
                            <textarea class="form-control" id="instructions" name="instructions" rows="3"
                                      placeholder="Add any special instructions for students..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Assignment Target (Class or Teaching Group) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Assign To</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Choose whether to assign this to an entire class or a specific teaching group.</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Assignment Target *</label>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="target_type" id="target_class" value="class" checked>
                                        <label class="form-check-label" for="target_class">
                                            <i class="bi bi-collection me-1"></i>Entire Class
                                        </label>
                                    </div>
                                    <select class="form-select mt-2" id="target_class_id" name="target_class_id">
                                        <option value="">Select a class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="target_type" id="target_group" value="teaching_group">
                                        <label class="form-check-label" for="target_group">
                                            <i class="bi bi-diagram-3 me-1"></i>Teaching Group
                                        </label>
                                    </div>
                                    <select class="form-select mt-2" id="target_group_id" name="target_group_id" disabled>
                                        <option value="">Select a teaching group...</option>
                                        {% for g in teaching_groups %}
                                        <option value="{{ g.group_id }}">{{ g.name }} ({{ g.class_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <small class="text-muted">Leave empty to make the assignment available to all your students.</small>
                        </div>
                    </div>
                </div>
                
                <!-- AI Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Marking Configuration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Configure which AI model to use for reviewing and grading this assignment, and provide additional instructions for feedback and grading.</p>
                        
                        <div class="mb-3">
                            <label for="ai_model" class="form-label">AI Model for This Assignment *</label>
                            {% set default_model = teacher.get('default_ai_model', 'anthropic') %}
                            <select class="form-select" id="ai_model" name="ai_model" required>
                                <option value="anthropic" {% if default_model == 'anthropic' %}selected{% endif %}>Anthropic (Claude)</option>
                                <option value="openai" {% if default_model == 'openai' %}selected{% endif %}>OpenAI (GPT)</option>
                                <option value="deepseek" {% if default_model == 'deepseek' %}selected{% endif %}>DeepSeek</option>
                                <option value="google" {% if default_model == 'google' %}selected{% endif %}>Google Gemini</option>
                            </select>
                            <small class="text-muted">Your default model: <strong>{{ default_model|title }}</strong></small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="feedback_instructions" class="form-label">Additional Instructions for Feedback (optional)</label>
                            <textarea class="form-control" id="feedback_instructions" name="feedback_instructions" rows="3"
                                      placeholder="e.g., Focus on explaining common mistakes, provide step-by-step guidance, emphasize conceptual understanding..."></textarea>
                            <small class="text-muted">These instructions will guide the AI when providing feedback to students.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="grading_instructions" class="form-label">Additional Instructions for Grading (optional)</label>
                            <textarea class="form-control" id="grading_instructions" name="grading_instructions" rows="3"
                                      placeholder="e.g., Be strict with calculation errors, award partial credit for showing work, deduct points for missing units..."></textarea>
                            <small class="text-muted">These instructions will guide the AI when grading student submissions.</small>
                        </div>
                    </div>
                </div>
                
                <!-- PDF Upload -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-file-pdf me-2"></i>Upload Documents</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Question Paper -->
                            <div class="col-md-6 mb-3">
                                <div class="upload-zone" id="question-zone">
                                    <input type="file" class="form-control d-none" id="question_paper" name="question_paper" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'question')">
                                    <label for="question_paper" class="upload-label">
                                        <div class="upload-icon">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </div>
                                        <h6>Question Paper *</h6>
                                        <p class="text-muted small mb-0">Empty paper for students</p>
                                        <span class="file-name" id="question-filename">Click to upload PDF</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Answer Key -->
                            <div class="col-md-6 mb-3">
                                <div class="upload-zone" id="answer-zone">
                                    <input type="file" class="form-control d-none" id="answer_key" name="answer_key" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'answer')">
                                    <label for="answer_key" class="upload-label">
                                        <div class="upload-icon answer">
                                            <i class="bi bi-file-earmark-check"></i>
                                        </div>
                                        <h6>Answer Key *</h6>
                                        <p class="text-muted small mb-0">Questions with answers</p>
                                        <span class="file-name" id="answer-filename">Click to upload PDF</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Note:</strong> The answer key PDF should contain both the questions and the correct answers. 
                            This will be used by the AI to mark student submissions.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- Summary & Actions -->
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="summary-item">
                            <span>Question Paper:</span>
                            <strong id="summary-question"><span class="text-danger">Not uploaded</span></strong>
                        </div>
                        <div class="summary-item">
                            <span>Answer Key:</span>
                            <strong id="summary-answer"><span class="text-danger">Not uploaded</span></strong>
                        </div>
                        <div class="summary-item">
                            <span>Total Marks:</span>
                            <strong id="summary-marks">100</strong>
                        </div>
                        
                        <hr>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="publish" name="publish" checked>
                            <label class="form-check-label" for="publish">
                                Publish immediately
                            </label>
                            <small class="d-block text-muted">If unchecked, assignment will be saved as draft</small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="bi bi-save me-2"></i>Save Assignment
                            </button>
                            <a href="{{ url_for('teacher_assignments') }}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    background: #fafafa;
}

.upload-zone:hover,
.upload-zone.dragover {
    border-color: var(--teacher-primary);
    background: #f0f7ff;
}

.upload-zone.has-file {
    border-color: #28a745;
    background: #f0fff4;
}

.upload-label {
    cursor: pointer;
    display: block;
    margin: 0;
}

.upload-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #0d6efd, #0a58ca);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
}

.upload-icon.answer {
    background: linear-gradient(135deg, #198754, #146c43);
}

.upload-icon i {
    font-size: 28px;
    color: white;
}

.file-name {
    display: block;
    margin-top: 10px;
    padding: 8px 12px;
    background: white;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #6c757d;
    word-break: break-all;
}

.upload-zone.has-file .file-name {
    color: #28a745;
    font-weight: 500;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.summary-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    function handleFileSelect(input, type) {
        const zone = document.getElementById(type + '-zone');
        const filename = document.getElementById(type + '-filename');
        const summary = document.getElementById('summary-' + type);
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            zone.classList.add('has-file');
            filename.textContent = file.name;
            summary.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Uploaded</span>';
        } else {
            zone.classList.remove('has-file');
            filename.textContent = 'Click to upload PDF';
            summary.innerHTML = '<span class="text-danger">Not uploaded</span>';
        }
        
        validateForm();
    }
    
    // Update marks summary
    document.getElementById('total_marks').addEventListener('input', function() {
        document.getElementById('summary-marks').textContent = this.value || '0';
    });
    
    // Drag and drop
    ['question-zone', 'answer-zone'].forEach(zoneId => {
        const zone = document.getElementById(zoneId);
        const input = zone.querySelector('input[type="file"]');
        
        ['dragenter', 'dragover'].forEach(eventName => {
            zone.addEventListener(eventName, (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
            });
        });
        
        zone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length && files[0].type === 'application/pdf') {
                input.files = files;
                input.dispatchEvent(new Event('change'));
            }
        });
    });
    
    function validateForm() {
        const questionPaper = document.getElementById('question_paper').files.length > 0;
        const answerKey = document.getElementById('answer_key').files.length > 0;
        const submitBtn = document.getElementById('submit-btn');
        
        // Both files are required
        submitBtn.disabled = !(questionPaper && answerKey);
    }
    
    // Form validation
    document.getElementById('create-assignment-form').addEventListener('submit', function(e) {
        const questionPaper = document.getElementById('question_paper').files.length;
        const answerKey = document.getElementById('answer_key').files.length;
        
        if (!questionPaper || !answerKey) {
            e.preventDefault();
            alert('Please upload both the question paper and answer key PDFs.');
            return false;
        }
    });
    
    // Initial validation
    validateForm();
    
    // Toggle between class and teaching group selection
    document.querySelectorAll('input[name="target_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const isClass = this.value === 'class';
            document.getElementById('target_class_id').disabled = !isClass;
            document.getElementById('target_group_id').disabled = isClass;
            
            // Clear the disabled field
            if (isClass) {
                document.getElementById('target_group_id').value = '';
            } else {
                document.getElementById('target_class_id').value = '';
            }
        });
    });
</script>
{% endblock %}
