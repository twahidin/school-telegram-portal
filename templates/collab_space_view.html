<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Collab Space</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body, #root { height: 100%; width: 100%; overflow: hidden; }
  .node-hover:hover { filter: brightness(0.95); }
  .add-btn:hover circle { fill: #059669; }
  .modal-overlay { background: rgba(0,0,0,0.5); }
  @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  .modal-content { animation: fadeIn 0.2s ease-out; }
  .scrollbar-thin::-webkit-scrollbar { width: 6px; }
  .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 9999px; font-size: 11px; font-weight: 600; }
  .save-indicator { transition: opacity 0.3s; }
  @keyframes cursorPulse { 0%,100% { opacity: 0.9; } 50% { opacity: 0.5; } }
  .remote-cursor { pointer-events: none; }
  .presence-dot { animation: cursorPulse 2s ease-in-out infinite; }
</style>
</head>
<body>
<div id="root"></div>

<!-- Flask data injection -->
<script>
window.FLASK_DATA = {
    space: {{ space_json|safe }},
    nodes_data: {{ nodes_json|safe }},
    user_role: "{{ user_role }}",
    user_id: "{{ user_id }}",
    user_name: "{{ user_name }}",
    back_url: "{{ back_url }}",
    has_api_key: {{ 'true' if has_api_key else 'false' }},
    all_spaces: {{ all_spaces_json|safe }}
};
</script>

{% raw %}
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;
const FD = window.FLASK_DATA;
const SPACE_ID = FD.space.space_id;
const socket = io({ transports: ['websocket', 'polling'] });

/* ── SVG Icon Components ── */
const Icon = ({ children, size = 20, className = '', style = {}, onClick }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
    fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
    className={className} style={style} onClick={onClick}>{children}</svg>
);
const SettingsIcon = (p) => <Icon {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></Icon>;
const XIcon = (p) => <Icon {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;
const ThumbsUpIcon = (p) => <Icon {...p}><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></Icon>;
const MessageIcon = (p) => <Icon {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>;
const FileTextIcon = (p) => <Icon {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>;
const ImageIcon = (p) => <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>;
const BarChartIcon = (p) => <Icon {...p}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></Icon>;
const SendIcon = (p) => <Icon {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>;
const DownloadIcon = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
const TrashIcon = (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>;
const ArrowLeftIcon = (p) => <Icon {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></Icon>;
const UsersIcon = (p) => <Icon {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
const EditIcon = (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>;

/* ── Color Palette ── */
const COLOR_PALETTE = [
  { name:'Blue',primary:'#3B82F6',light:'#DBEAFE',dark:'#1E40AF' },
  { name:'Green',primary:'#10B981',light:'#D1FAE5',dark:'#065F46' },
  { name:'Orange',primary:'#F97316',light:'#FED7AA',dark:'#92400E' },
  { name:'Purple',primary:'#A855F7',light:'#E9D5FF',dark:'#581C87' },
  { name:'Pink',primary:'#EC4899',light:'#FCE7F3',dark:'#831843' },
  { name:'Cyan',primary:'#06B6D4',light:'#CFFAFE',dark:'#164E63' },
  { name:'Amber',primary:'#D97706',light:'#FEF3C7',dark:'#78350F' },
  { name:'Teal',primary:'#14B8A6',light:'#CCFBF1',dark:'#134E4A' },
];

/* ── Node dimension helpers (pill-shaped, expandable) ── */
const LAYER_FONT = {0:14,1:11,2:10,3:9};
function getNodeSize(node) {
  if (node.layer === 0) return { w: 130, h: 60 };
  const fs = LAYER_FONT[node.layer] || 9;
  const charW = fs * 0.62;
  const label = node.label || '';
  const pad = 28;
  const isText = node.isTextNode;
  const minW = isText ? 110 : (node.layer === 1 ? 100 : 80);
  const maxW = isText ? 240 : 180;
  const textW = label.length * charW + pad;
  const w = Math.max(minW, Math.min(maxW, textW));
  const h = isText ? 38 : (node.layer === 1 ? 42 : (node.layer === 2 ? 36 : 30));
  return { w, h };
}

/* ── Initial Layout Calculation (run once) ── */
function layoutNodes(data, cx, cy) {
  const out = JSON.parse(JSON.stringify(data));
  // Only position nodes that don't already have valid x,y from DB (dragged positions)
  const needsPos = (n) => (n.x === 0 && n.y === 0) || n.x === undefined;
  if (needsPos(out.central)) { out.central.x = cx; out.central.y = cy; }
  const l1 = out.layer1, l1R = 220;
  l1.forEach((n,i) => { if (needsPos(n)) { const a=(i/l1.length)*Math.PI*2-Math.PI/2; n.x=out.central.x+l1R*Math.cos(a); n.y=out.central.y+l1R*Math.sin(a); }});
  const l2R = 150;
  out.layer2.forEach(n => {
    if (!needsPos(n)) return;
    const p = l1.find(x => x.id===n.parentId); if(!p) return;
    const sibs = out.layer2.filter(s => s.parentId===p.id), idx = sibs.indexOf(n);
    const pa = Math.atan2(p.y-out.central.y,p.x-out.central.x), spread=0.7;
    const a = pa+(idx-(sibs.length-1)/2)*spread;
    n.x=p.x+l2R*Math.cos(a); n.y=p.y+l2R*Math.sin(a);
  });
  const l3R = 110;
  out.layer3.forEach(n => {
    if (!needsPos(n)) return;
    const p = out.layer2.find(x => x.id===n.parentId); if(!p) return;
    const pp = l1.find(x => x.id===p.parentId);
    const sibs = out.layer3.filter(s => s.parentId===p.id), idx = sibs.indexOf(n);
    const pa = Math.atan2(p.y-(pp?.y||out.central.y),p.x-(pp?.x||out.central.x)), spread=0.6;
    const a = pa+(idx-(sibs.length-1)/2)*spread;
    n.x=p.x+l3R*Math.cos(a); n.y=p.y+l3R*Math.sin(a);
  });
  return out;
}

/* ── Place a new node near its parent ── */
function placeNearParent(parent, siblings, dist) {
  if (siblings.length === 0) return { x: parent.x + dist, y: parent.y };
  const angles = siblings.map(s => Math.atan2(s.y - parent.y, s.x - parent.x)).sort((a,b) => a - b);
  let maxGap = 0, bestAngle = angles[0] + Math.PI;
  for (let i = 0; i < angles.length; i++) {
    const next = i < angles.length - 1 ? angles[i+1] : angles[0] + Math.PI * 2;
    const gap = next - angles[i];
    if (gap > maxGap) { maxGap = gap; bestAngle = angles[i] + gap / 2; }
  }
  return { x: parent.x + dist * Math.cos(bestAngle), y: parent.y + dist * Math.sin(bestAngle) };
}

const CurvedLine = ({x1,y1,x2,y2,color='#94a3b8'}) => {
  const mx=(x1+x2)/2, my=(y1+y2)/2;
  return <path d={`M${x1},${y1} Q${mx},${my} ${x2},${y2}`} stroke={color} strokeWidth="2" fill="none" opacity="0.5"/>;
};

/* ── Single Node (pill-shaped, expandable) ── */
const MindMapNode = ({node, isSelected, onMouseDown, onAddChild, userView}) => {
  const { w, h } = getNodeSize(node);
  const fs = LAYER_FONT[node.layer] || 9;
  const isText = node.isTextNode;
  // Colors
  const bg = node.layer === 0 ? '#0F172A'
    : isText ? (node.studentColor?.light || '#f8fafc')
    : (node.studentColor ? node.studentColor.dark : '#e2e8f0');
  const stroke = isSelected ? '#FBBF24' : (node.studentColor ? node.studentColor.primary : '#334155');
  const textFill = node.layer === 0 ? '#FFFFFF'
    : isText ? (node.studentColor?.dark || '#1E293B')
    : (node.studentColor ? '#FFFFFF' : '#1E293B');
  // Truncate for display
  const maxChars = Math.floor((w - 20) / (fs * 0.6));
  const display = node.label.length > maxChars ? node.label.substring(0, maxChars - 1) + '\u2026' : node.label;
  // Central node word wrap
  let centralLines = [];
  if (node.layer === 0) {
    const words = node.label.split(' '); let line = '';
    words.forEach(wd => { if ((line + ' ' + wd).trim().length > 16) { centralLines.push(line.trim()); line = wd; } else { line = (line + ' ' + wd).trim(); } });
    if (line) centralLines.push(line);
  }
  // Show + button: not on text nodes, not on layer 3
  const showAdd = !isText && node.layer < 3;
  return (
    <g style={{cursor:'pointer'}} onMouseDown={e => onMouseDown(e, node)} onTouchStart={e => onMouseDown(e, node)}>
      {isSelected && <rect x={node.x-w/2-4} y={node.y-h/2-4} width={w+8} height={h+8} rx={(h+8)/2} fill="none" stroke="#FBBF24" strokeWidth="3" opacity="0.5"/>}
      <rect x={node.x-w/2} y={node.y-h/2} width={w} height={h} rx={h/2} fill={bg} stroke={stroke} strokeWidth={isSelected?3:1.5} className="node-hover" style={{transition:'all 0.15s'}}/>
      {/* Text node icon */}
      {isText && <g opacity="0.4"><rect x={node.x-w/2+8} y={node.y-5} width="10" height="10" rx="1.5" fill="none" stroke={node.studentColor?.dark||'#475569'} strokeWidth="1"/><line x1={node.x-w/2+10} y1={node.y-2} x2={node.x-w/2+16} y2={node.y-2} stroke={node.studentColor?.dark||'#475569'} strokeWidth="0.8"/><line x1={node.x-w/2+10} y1={node.y+1} x2={node.x-w/2+15} y2={node.y+1} stroke={node.studentColor?.dark||'#475569'} strokeWidth="0.8"/></g>}
      {/* Vote badge */}
      {node.votes>0&&node.layer>0&&(<g><circle cx={node.x+w/2-4} cy={node.y-h/2-4} r="10" fill="#FBBF24" stroke="#fff" strokeWidth="1.5"/><text x={node.x+w/2-4} y={node.y-h/2-3} textAnchor="middle" dominantBaseline="middle" style={{fontSize:'8px',fontWeight:700,fill:'#1E293B'}}>{node.votes}</text></g>)}
      {/* Comment badge */}
      {node.comments&&node.comments.length>0&&(<g><circle cx={node.x-w/2+4} cy={node.y-h/2-4} r="10" fill="#3B82F6" stroke="#fff" strokeWidth="1.5"/><text x={node.x-w/2+4} y={node.y-h/2-3} textAnchor="middle" dominantBaseline="middle" style={{fontSize:'8px',fontWeight:700,fill:'#FFFFFF'}}>{node.comments.length}</text></g>)}
      {/* Label text */}
      {node.layer === 0 ? centralLines.map((line,i) => (
        <text key={i} x={node.x} y={node.y+(i-(centralLines.length-1)/2)*16} textAnchor="middle" dominantBaseline="middle"
          style={{fontSize:`${fs}px`,fontWeight:700,fill:textFill,pointerEvents:'none'}}>{line}</text>
      )) : (
        <text x={node.x + (isText ? 8 : 0)} y={node.y+1} textAnchor="middle" dominantBaseline="middle"
          style={{fontSize:`${fs}px`,fontWeight:600,fill:textFill,pointerEvents:'none'}}>{display}</text>
      )}
      {/* Add child button */}
      {showAdd && (<g className="add-btn" onMouseDown={e=>{e.stopPropagation();onAddChild(node);}} onTouchStart={e=>{e.stopPropagation();e.preventDefault();onAddChild(node);}} style={{cursor:'pointer'}}><circle cx={node.x+w/2+12} cy={node.y} r="11" fill="#10B981" stroke="#fff" strokeWidth="1.5"/><text x={node.x+w/2+12} y={node.y+1} textAnchor="middle" dominantBaseline="middle" style={{fontSize:'14px',fill:'#fff',fontWeight:700,pointerEvents:'none'}}>+</text></g>)}
      {/* Student color dot */}
      {node.studentColor&&node.layer>0&&(<circle cx={node.x} cy={node.y+h/2+8} r="4" fill={node.studentColor.primary} stroke="#fff" strokeWidth="1"/>)}
    </g>
  );
};

/* ── API helpers (infographic/PDF only) ── */
const api = (path, opts={}) => fetch(`/api/collab-space/${SPACE_ID}${path}`, {method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, ...opts});

/* ── Remote Cursor Component ── */
const RemoteCursor = ({user}) => {
  if (!user.x && user.x !== 0) return null;
  return (
    <g className="remote-cursor" style={{transition:'transform 0.12s ease-out'}}>
      <polygon points={`${user.x},${user.y} ${user.x},${user.y+18} ${user.x+5},${user.y+14} ${user.x+10},${user.y+20} ${user.x+13},${user.y+18} ${user.x+8},${user.y+12} ${user.x+14},${user.y+10}`}
        fill={user.color||'#94a3b8'} stroke="#fff" strokeWidth="1" opacity="0.85"/>
      <rect x={user.x+14} y={user.y+12} rx="4" ry="4" width={Math.max(40,user.name.length*6+12)} height="16" fill={user.color||'#94a3b8'} opacity="0.85"/>
      <text x={user.x+20} y={user.y+23} style={{fontSize:'9px',fill:'#fff',fontWeight:600,pointerEvents:'none'}}>{user.name}</text>
    </g>
  );
};

/* ── Main App ── */
function App() {
  const svgRef = useRef(null);
  const saveTimer = useRef(null);
  const [userView, setUserView] = useState(FD.user_role === 'student' ? 'student' : 'teacher');
  const [nodes, setNodes] = useState(() => layoutNodes(FD.nodes_data, 500, 350));
  const [selectedNode, setSelectedNode] = useState(null);
  const [teacherPanel, setTeacherPanel] = useState(false);
  const [commentText, setCommentText] = useState('');
  const [showAddModal, setShowAddModal] = useState(false);
  const [contentText, setContentText] = useState('');
  const [contentImage, setContentImage] = useState(false);
  const [addTarget, setAddTarget] = useState(null);
  const [addAsTextNode, setAddAsTextNode] = useState(false);
  const [showColorPicker, setShowColorPicker] = useState(false);
  const [generationsUsed, setGenerationsUsed] = useState(FD.space.generation_count || 0);
  const maxGenerations = FD.space.max_generation || 5;
  const isTeacher = FD.user_role === 'teacher';
  // Teachers have unlimited generations; students share a pool
  const canGenerate = isTeacher || generationsUsed < maxGenerations;
  const [currentStudent, setCurrentStudent] = useState({id:FD.user_id, name:FD.user_name, color:COLOR_PALETTE[0]});
  const [saveStatus, setSaveStatus] = useState('');
  const [genStatus, setGenStatus] = useState('');
  const [settings, setSettings] = useState({
    topic: FD.space.central_topic || 'Discussion',
    maxLayer1: (FD.space.settings||{}).maxLayer1||6, maxTextNodes: (FD.space.settings||{}).maxTextNodes||5,
    charLimit: (FD.space.settings||{}).charLimit||200, sessionOpen: FD.space.is_active!==false,
  });
  const [viewBox, setViewBox] = useState({x:50,y:-20,w:950,h:740});
  const [dragging, setDragging] = useState(false);  // canvas pan
  const [dragStart, setDragStart] = useState({x:0,y:0});
  // Live collab state
  const [onlineUsers, setOnlineUsers] = useState([]);
  const [remoteCursors, setRemoteCursors] = useState({});
  const [connected, setConnected] = useState(false);
  const cursorThrottle = useRef(0);
  // Node dragging — use refs for zero-lag drag, only commit to state on drop
  const dragNodeRef = useRef(null);     // the node being dragged
  const dragStartRef = useRef(null);    // {nodeX, nodeY, mouseX, mouseY}
  const didDragRef = useRef(false);
  const dragOffsetRef = useRef({dx:0, dy:0});
  const rafRef = useRef(null);
  const [dragNodeId, setDragNodeId] = useState(null);  // only for cursor style
  const DRAG_THRESHOLD = 5;
  // Editing
  const [editing, setEditing] = useState(false);
  const [editLabel, setEditLabel] = useState('');
  const [editContent, setEditContent] = useState('');
  // Polling fallback
  const pollVersion = useRef('');
  const pollTimer = useRef(null);

  // Derived: taken colors (by other online users)
  const takenColors = onlineUsers.filter(u => u.user_id !== FD.user_id).map(u => u.color).filter(Boolean);

  // ─── Polling fallback: fetch latest state every 3s ───
  useEffect(() => {
    const poll = async () => {
      // Skip if user is actively dragging
      if (dragNodeRef.current) return;
      try {
        const r = await fetch(`/api/collab-space/${SPACE_ID}/nodes`, {headers:{'Accept':'application/json'}});
        if (!r.ok) return;
        const data = await r.json();
        if (!data.nodes_data) return;
        // Only update if version changed (something new from server)
        if (data.version && data.version !== pollVersion.current) {
          pollVersion.current = data.version;
          setNodes(prev => {
            const remote = data.nodes_data;
            // Merge: use remote state but preserve local positions of nodes being viewed
            return layoutNodes(remote, 500, 350);
          });
          if (data.collab_settings) {
            setSettings(prev => ({...prev, ...data.collab_settings}));
          }
        }
      } catch(e) { /* silent */ }
    };
    pollTimer.current = setInterval(poll, 3000);
    return () => clearInterval(pollTimer.current);
  }, []);

  // ─── Socket.IO setup ───
  useEffect(() => {
    socket.on('connect', () => {
      console.log('[Collab] Socket connected, transport:', socket.io.engine?.transport?.name);
      setConnected(true);
      socket.emit('join_space', {
        space_id: SPACE_ID, user_id: FD.user_id,
        user_name: FD.user_name, user_role: FD.user_role,
        color: currentStudent.color.primary,
      });
    });
    socket.on('disconnect', (reason) => {
      console.log('[Collab] Socket disconnected:', reason);
      setConnected(false);
    });
    socket.on('connect_error', (err) => {
      console.warn('[Collab] Socket connect error:', err.message);
    });
    // Full room user list on join
    socket.on('room_users', (data) => {
      setOnlineUsers(data.users || []);
    });
    socket.on('user_joined', (data) => {
      setOnlineUsers(prev => prev.find(u => u.user_id === data.user_id) ? prev : [...prev, data]);
    });
    socket.on('user_left', (data) => {
      setOnlineUsers(prev => prev.filter(u => u.user_id !== data.user_id));
      setRemoteCursors(prev => { const n={...prev}; delete n[data.user_id]; return n; });
    });
    socket.on('color_changed', (data) => {
      setOnlineUsers(prev => prev.map(u => u.user_id === data.user_id ? {...u, color: data.color} : u));
    });
    socket.on('cursor_move', (data) => {
      setRemoteCursors(prev => ({...prev, [data.user_id]: {x:data.x,y:data.y,name:data.user_name,color:data.color}}));
    });
    socket.on('node_added', (data) => {
      setNodes(prev => {
        const lk = data.layer_key;
        if (!prev[lk] || prev[lk].find(n => n.id === data.node.id)) return prev;
        return {...prev, [lk]: [...prev[lk], data.node]};
      });
    });
    socket.on('node_deleted', (data) => {
      const ids = new Set(data.deleted_ids || [data.node_id]);
      setNodes(prev => ({...prev,
        layer1: prev.layer1.filter(n => !ids.has(n.id)),
        layer2: prev.layer2.filter(n => !ids.has(n.id)),
        layer3: prev.layer3.filter(n => !ids.has(n.id)),
      }));
      setSelectedNode(prev => prev && ids.has(prev.id) ? null : prev);
    });
    socket.on('node_voted', (data) => {
      const lk = data.layer_key;
      setNodes(prev => prev[lk] ? {...prev, [lk]: prev[lk].map(n => n.id===data.node_id ? {...n,votes:(n.votes||0)+1} : n)} : prev);
      setSelectedNode(prev => prev && prev.id===data.node_id ? {...prev,votes:(prev.votes||0)+1} : prev);
    });
    socket.on('comment_added', (data) => {
      const lk = data.layer_key;
      setNodes(prev => prev[lk] ? {...prev, [lk]: prev[lk].map(n => n.id===data.node_id ? {...n,comments:[...(n.comments||[]),data.comment]} : n)} : prev);
      setSelectedNode(prev => prev && prev.id===data.node_id ? {...prev,comments:[...(prev.comments||[]),data.comment]} : prev);
    });
    socket.on('node_moved', (data) => {
      // Don't apply remote move if we're the one dragging that node
      if (dragNodeRef.current && dragNodeRef.current.id === data.node_id) return;
      setNodes(prev => {
        const update = (arr) => arr.map(n => n.id === data.node_id ? {...n, x: data.x, y: data.y} : n);
        const upd = {...prev, layer1: update(prev.layer1), layer2: update(prev.layer2), layer3: update(prev.layer3)};
        if (prev.central.id === data.node_id) upd.central = {...prev.central, x: data.x, y: data.y};
        return upd;
      });
    });
    socket.on('node_edited', (data) => {
      const lk = data.layer_key;
      setNodes(prev => {
        if (!prev[lk]) return prev;
        return {...prev, [lk]: prev[lk].map(n => {
          if (n.id !== data.node_id) return n;
          const upd = {...n};
          if (data.label !== undefined && data.label !== null) upd.label = data.label;
          if (data.content !== undefined && data.content !== null) upd.content = data.content;
          return upd;
        })};
      });
      setSelectedNode(prev => {
        if (!prev || prev.id !== data.node_id) return prev;
        const upd = {...prev};
        if (data.label !== undefined && data.label !== null) upd.label = data.label;
        if (data.content !== undefined && data.content !== null) upd.content = data.content;
        return upd;
      });
    });
    socket.on('settings_changed', (data) => {
      if (data.settings) setSettings(prev => ({...prev, ...data.settings}));
    });
    return () => {
      socket.emit('leave_space', {space_id: SPACE_ID, user_id: FD.user_id, user_name: FD.user_name});
      ['connect','disconnect','connect_error','room_users','user_joined','user_left','color_changed','cursor_move',
       'node_added','node_deleted','node_voted','comment_added','node_moved','node_edited','settings_changed'
      ].forEach(ev => socket.off(ev));
    };
  }, []);

  // ─── Backup full-state save ───
  function triggerSave(nodesData) {
    if (saveTimer.current) clearTimeout(saveTimer.current);
    setSaveStatus('Synced');
    saveTimer.current = setTimeout(async () => {
      setSaveStatus('Saving...');
      try {
        await api('/save-nodes', {body: JSON.stringify({nodes_data: nodesData, settings: {maxLayer1:settings.maxLayer1,maxTextNodes:settings.maxTextNodes,charLimit:settings.charLimit}})});
        setSaveStatus('Saved'); setTimeout(() => setSaveStatus(''), 2000);
      } catch(e) { setSaveStatus('Save failed'); }
    }, 5000);
  }

  // ─── Unified pointer helpers (mouse + touch) ───
  const getPointer = (e) => {
    if (e.touches && e.touches.length > 0) return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
    if (e.changedTouches && e.changedTouches.length > 0) return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY };
    return { clientX: e.clientX, clientY: e.clientY };
  };
  const svgCoordsFromPointer = (p) => {
    const svg = svgRef.current; if (!svg) return {x:0,y:0};
    const rect = svg.getBoundingClientRect();
    return { x: viewBox.x + ((p.clientX - rect.left) / rect.width) * viewBox.w,
             y: viewBox.y + ((p.clientY - rect.top) / rect.height) * viewBox.h };
  };
  const svgCoords = (e) => svgCoordsFromPointer(getPointer(e));
  // Pinch-to-zoom + viewBox refs for use in native listeners
  const pinchRef = useRef(null);
  const viewBoxRef = useRef(viewBox);
  viewBoxRef.current = viewBox;
  const draggingRef = useRef(false);
  const dragStartRef2 = useRef({x:0,y:0});

  // ─── Canvas interactions ───
  const handleWheel = useCallback(e => {
    e.preventDefault();
    const scale = e.deltaY > 0 ? 1.1 : 0.9;
    setViewBox(v => { const cx=v.x+v.w/2, cy=v.y+v.h/2, nw=v.w*scale, nh=v.h*scale; return {x:cx-nw/2,y:cy-nh/2,w:nw,h:nh}; });
  }, []);

  // — Pointer down (canvas pan start) —
  const handlePointerDown = e => {
    if (e.touches && e.touches.length === 2) {
      const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
      pinchRef.current = { dist: d, vb: {...viewBoxRef.current} };
      return;
    }
    if (dragNodeRef.current) return;
    const p = getPointer(e);
    setDragging(true); draggingRef.current = true;
    setDragStart({x: p.clientX, y: p.clientY}); dragStartRef2.current = {x: p.clientX, y: p.clientY};
  };

  // — Pointer move — uses requestAnimationFrame for smooth 60fps drag —
  const handlePointerMove = useCallback(e => {
    if (e.touches) e.preventDefault();
    // Pinch
    if (e.touches && e.touches.length === 2 && pinchRef.current) {
      const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
      const scale = pinchRef.current.dist / d;
      const vb = pinchRef.current.vb;
      const cx = vb.x + vb.w / 2, cy = vb.y + vb.h / 2;
      setViewBox({x: cx - vb.w*scale/2, y: cy - vb.h*scale/2, w: vb.w*scale, h: vb.h*scale});
      return;
    }
    const p = getPointer(e);
    // Cursor broadcast (~15fps)
    const now = Date.now();
    if (now - cursorThrottle.current > 66) {
      cursorThrottle.current = now;
      const svg = svgRef.current;
      if (svg) {
        const rect = svg.getBoundingClientRect();
        const vb = viewBoxRef.current;
        const sx = vb.x + ((p.clientX - rect.left) / rect.width) * vb.w;
        const sy = vb.y + ((p.clientY - rect.top) / rect.height) * vb.h;
        socket.volatile.emit('cursor_move', {space_id:SPACE_ID, user_id:FD.user_id, user_name:FD.user_name, color:currentStudent.color.primary, x:Math.round(sx), y:Math.round(sy)});
      }
    }
    // Node drag (RAF-batched for smooth 60fps)
    const dn = dragNodeRef.current, ds = dragStartRef.current;
    if (dn && ds) {
      const svg = svgRef.current; if (!svg) return;
      const rect = svg.getBoundingClientRect();
      const vb = viewBoxRef.current;
      const cx = vb.x + ((p.clientX - rect.left) / rect.width) * vb.w;
      const cy = vb.y + ((p.clientY - rect.top) / rect.height) * vb.h;
      const dx = cx - ds.mouseX, dy = cy - ds.mouseY;
      if (!didDragRef.current && Math.abs(dx) + Math.abs(dy) > DRAG_THRESHOLD) {
        didDragRef.current = true; setDragNodeId(dn.id);
      }
      if (didDragRef.current) {
        dragOffsetRef.current = {dx, dy};
        if (!rafRef.current) {
          rafRef.current = requestAnimationFrame(() => {
            const off = dragOffsetRef.current;
            const d = dragNodeRef.current, s = dragStartRef.current;
            if (d && s) {
              const nx = s.nodeX + off.dx, ny = s.nodeY + off.dy;
              setNodes(prev => {
                if (d.id === 'central') return {...prev, central: {...prev.central, x: nx, y: ny}};
                const lk = d.type;
                return {...prev, [lk]: prev[lk].map(n => n.id === d.id ? {...n, x: nx, y: ny} : n)};
              });
            }
            rafRef.current = null;
          });
        }
      }
      return;
    }
    // Canvas pan
    if (draggingRef.current) {
      const ds = dragStartRef2.current;
      const vb = viewBoxRef.current;
      const ddx = (p.clientX - ds.x) * (vb.w / window.innerWidth);
      const ddy = (p.clientY - ds.y) * (vb.h / window.innerHeight);
      setViewBox(v => ({...v, x: v.x - ddx, y: v.y - ddy}));
      setDragStart({x: p.clientX, y: p.clientY}); dragStartRef2.current = {x: p.clientX, y: p.clientY};
    }
  }, []);

  // — Pointer up (finish drag/click) —
  const handlePointerUp = () => {
    pinchRef.current = null;
    if (rafRef.current) { cancelAnimationFrame(rafRef.current); rafRef.current = null; }
    const dn = dragNodeRef.current;
    // Finish node drag → commit + broadcast
    if (dn && didDragRef.current) {
      setNodes(prev => {
        let finalNode;
        if (dn.id === 'central') finalNode = prev.central;
        else { const lk = dn.type; finalNode = prev[lk]?.find(n => n.id === dn.id); }
        if (finalNode) {
          const lk = dn.id === 'central' ? 'central' : dn.type;
          socket.emit('node_moved', {space_id: SPACE_ID, node_id: dn.id, layer_key: lk, x: finalNode.x, y: finalNode.y, user_id: FD.user_id});
        }
        triggerSave(prev);
        return prev;
      });
    }
    // Click (no drag) → select node
    if (dn && !didDragRef.current) {
      setNodes(prev => {
        let fresh;
        if (dn.id === 'central') fresh = prev.central;
        else { const lk = dn.type; fresh = prev[lk]?.find(n => n.id === dn.id); }
        if (fresh) { setSelectedNode(fresh); setEditing(false); }
        return prev;
      });
    }
    dragNodeRef.current = null; dragStartRef.current = null;
    didDragRef.current = false; dragOffsetRef.current = {dx:0,dy:0};
    setDragNodeId(null);
    setDragging(false); draggingRef.current = false;
  };

  // Attach wheel + touch listeners with {passive:false}
  useEffect(() => {
    const el = svgRef.current; if (!el) return;
    el.addEventListener('wheel', handleWheel, {passive:false});
    el.addEventListener('touchmove', handlePointerMove, {passive:false});
    return () => {
      el.removeEventListener('wheel', handleWheel);
      el.removeEventListener('touchmove', handlePointerMove);
    };
  }, [handleWheel, handlePointerMove]);

  // ─── Node pointer-down (start potential drag — mouse + touch) ───
  const handleNodeMouseDown = (e, node) => {
    if (e.touches) e.preventDefault();
    e.stopPropagation();
    const c = svgCoords(e);
    dragNodeRef.current = node;
    dragStartRef.current = { nodeX: node.x, nodeY: node.y, mouseX: c.x, mouseY: c.y };
    didDragRef.current = false;
    dragOffsetRef.current = {dx:0, dy:0};
  };

  // ─── Add child ───
  const handleAddChild = parent => { setAddTarget(parent); setAddAsTextNode(parent.layer >= 1); setShowAddModal(true); };

  const handleCreate = () => {
    if (!contentText.trim() || !addTarget) return;
    const layerKey = `layer${addTarget.layer + 1}`;
    const parent = addTarget.id === 'central' ? nodes.central : nodes[addTarget.type]?.find(n => n.id === addTarget.id);
    if (!parent) return;
    const siblings = nodes[layerKey]?.filter(n => n.parentId === addTarget.id) || [];
    const dist = addTarget.layer === 0 ? 220 : (addTarget.layer === 1 ? 150 : 110);
    const pos = placeNearParent(parent, siblings, dist);
    const newNode = {
      id: `n-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,
      parentId: addTarget.id, type: layerKey,
      label: contentText.substring(0, 30), content: contentText,
      studentColor: currentStudent.color, layer: addTarget.layer + 1,
      studentId: currentStudent.id, studentName: currentStudent.name,
      isTextNode: addAsTextNode,
      votes: 0, comments: [],
      textContent: (addAsTextNode || addTarget.layer + 1 === 3) ? contentText : '',
      hasImage: contentImage, x: pos.x, y: pos.y,
    };
    setNodes(prev => {
      const upd = {...prev, [layerKey]: [...prev[layerKey], newNode]};
      triggerSave(upd);
      return upd;
    });
    socket.emit('node_added', {space_id: SPACE_ID, node: newNode, layer_key: layerKey, user_id: FD.user_id});
    setShowAddModal(false); setContentText(''); setContentImage(false); setAddTarget(null); setAddAsTextNode(false);
  };

  // ─── Vote ───
  const handleVote = () => {
    if (!selectedNode || selectedNode.layer === 0) return;
    const lk = selectedNode.type;
    setNodes(prev => ({...prev, [lk]: prev[lk].map(n => n.id===selectedNode.id ? {...n,votes:(n.votes||0)+1} : n)}));
    setSelectedNode(prev => ({...prev, votes:(prev.votes||0)+1}));
    socket.emit('node_voted', {space_id:SPACE_ID, node_id:selectedNode.id, layer_key:lk, user_id:FD.user_id});
  };

  // ─── Comment ───
  const handleComment = () => {
    if (!commentText.trim() || !selectedNode) return;
    const nc = {id:`cm-${Date.now()}`,studentId:currentStudent.id,name:currentStudent.name,studentColor:currentStudent.color,text:commentText};
    const lk = selectedNode.type;
    setNodes(prev => ({...prev, [lk]: prev[lk].map(n => n.id===selectedNode.id ? {...n,comments:[...(n.comments||[]),nc]} : n)}));
    setSelectedNode(prev => ({...prev, comments:[...(prev.comments||[]),nc]}));
    setCommentText('');
    socket.emit('comment_added', {space_id:SPACE_ID, node_id:selectedNode.id, layer_key:lk, comment:nc, user_id:FD.user_id});
  };

  // ─── Delete ───
  const handleDeleteNode = nodeId => {
    if (!selectedNode || selectedNode.layer === 0) return;
    const childCount = selectedNode.layer===1
      ? nodes.layer2.filter(n=>n.parentId===nodeId).length + nodes.layer3.filter(n=>nodes.layer2.some(l2=>l2.parentId===nodeId&&n.parentId===l2.id)).length
      : selectedNode.layer===2 ? nodes.layer3.filter(n=>n.parentId===nodeId).length : 0;
    const msg = childCount > 0
      ? `Delete "${selectedNode.label}" and its ${childCount} child node${childCount>1?'s':''}? This cannot be undone.`
      : `Delete "${selectedNode.label}"? This cannot be undone.`;
    if (!window.confirm(msg)) return;
    const deletedIds = [nodeId];
    if (selectedNode.layer===1) { nodes.layer2.filter(n=>n.parentId===nodeId).forEach(n=>{deletedIds.push(n.id);}); nodes.layer3.filter(n=>nodes.layer2.some(l2=>l2.parentId===nodeId&&l2.id===n.parentId)).forEach(n=>deletedIds.push(n.id)); }
    else if (selectedNode.layer===2) { nodes.layer3.filter(n=>n.parentId===nodeId).forEach(n=>deletedIds.push(n.id)); }
    const idSet = new Set(deletedIds);
    setNodes(prev => {
      const upd = {...prev, layer1:prev.layer1.filter(n=>!idSet.has(n.id)), layer2:prev.layer2.filter(n=>!idSet.has(n.id)), layer3:prev.layer3.filter(n=>!idSet.has(n.id))};
      triggerSave(upd); return upd;
    });
    setSelectedNode(null);
    socket.emit('node_deleted', {space_id:SPACE_ID, node_id:nodeId, deleted_ids:deletedIds, user_id:FD.user_id});
  };

  // ─── Edit own node ───
  const startEditing = () => {
    if (!selectedNode || selectedNode.layer === 0) return;
    setEditing(true); setEditLabel(selectedNode.label); setEditContent(selectedNode.content || '');
  };
  const saveEdit = () => {
    if (!selectedNode) return;
    const lk = selectedNode.type;
    const newLabel = editLabel.trim() || selectedNode.label;
    const newContent = editContent;
    setNodes(prev => ({...prev, [lk]: prev[lk].map(n => n.id === selectedNode.id ? {...n, label: newLabel, content: newContent} : n)}));
    setSelectedNode(prev => ({...prev, label: newLabel, content: newContent}));
    setEditing(false);
    socket.emit('node_edited', {space_id: SPACE_ID, node_id: selectedNode.id, layer_key: lk, label: newLabel, content: newContent, user_id: FD.user_id});
    setNodes(prev => { triggerSave(prev); return prev; });
  };

  // ─── Color change ───
  const pickColor = (c) => {
    setCurrentStudent(prev => ({...prev, color: c}));
    setShowColorPicker(false);
    socket.emit('color_changed', {space_id: SPACE_ID, user_id: FD.user_id, color: c.primary});
  };

  // ─── Generate infographic / PDF ───
  const handleGenerateInfographic = async () => {
    setGenStatus('Generating infographic... this may take a minute');
    try {
      const r = await api('/generate-infographic');
      const ct = r.headers.get('Content-Type')||'';
      if (!r.ok) {
        const data = await r.json().catch(() => ({}));
        setGenStatus(data.error || `Request failed (${r.status}). Try refreshing or re‑logging in.`);
        return;
      }
      if (!ct.includes('json')) { setGenStatus('Error: unexpected response'); return; }
      const data = await r.json();
      if (data.success) { setGenerationsUsed(data.generation_count || generationsUsed+1); setGenStatus('Infographic generated!'); }
      else { setGenStatus(data.error||'Failed'); }
    } catch(e) { setGenStatus('Error: '+e.message); }
  };
  const handleGeneratePDF = async () => {
    setGenStatus('Generating study notes PDF...');
    try { await api('/save-nodes', {body: JSON.stringify({nodes_data: nodes})}); } catch(e) {}
    try {
      const r = await api('/generate-pdf');
      if (r.ok && r.headers.get('Content-Type')?.includes('pdf')) {
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = (FD.space.name || 'study-notes') + '.pdf';
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        setGenerationsUsed(prev => prev + 1);
        setGenStatus('PDF downloaded!');
      } else {
        const data = await r.json().catch(() => ({}));
        setGenStatus(data.error || (r.status === 401 || r.status === 403 ? 'Session expired? Try re‑logging in.' : `Request failed (${r.status}).`));
      }
    } catch(e) { setGenStatus('Error: ' + e.message); }
  };

  // ─── Derived data ───
  const allFlat = [nodes.central,...nodes.layer1,...nodes.layer2,...nodes.layer3];
  const totalVotes = allFlat.reduce((s,n)=>s+(n.votes||0),0);
  const totalComments = allFlat.reduce((s,n)=>s+(n.comments?.length||0),0);
  const edges = [];
  nodes.layer1.forEach(n => edges.push({from:nodes.central,to:n,color:n.studentColor?.primary||'#94a3b8'}));
  nodes.layer2.forEach(n => {const p=nodes.layer1.find(x=>x.id===n.parentId);if(p)edges.push({from:p,to:n,color:n.studentColor?.primary||'#94a3b8'});});
  nodes.layer3.forEach(n => {const p=nodes.layer2.find(x=>x.id===n.parentId);if(p)edges.push({from:p,to:n,color:n.studentColor?.primary||'#94a3b8'});});

  return (
    <div style={{display:'flex',height:'100vh',fontFamily:'-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif'}}>
      {/* Teacher Side Panel */}
      {FD.user_role==='teacher' && (
      <div style={{position:'fixed',left:0,top:0,height:'100%',width:320,background:'#fff',boxShadow:'2px 0 12px rgba(0,0,0,0.1)',borderRight:'1px solid #e2e8f0',
        transform:teacherPanel?'translateX(0)':'translateX(-100%)',transition:'transform 0.3s ease',zIndex:50,overflowY:'auto'}}>
        <div style={{padding:24}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
            <h2 style={{fontSize:18,fontWeight:700,color:'#1e293b'}}>Teacher Controls</h2>
            <button onClick={()=>setTeacherPanel(false)} style={{background:'none',border:'none',cursor:'pointer',color:'#64748b'}}><XIcon size={20}/></button>
          </div>
          <div style={{display:'flex',flexDirection:'column',gap:20}}>
            <div><label style={{display:'block',fontSize:13,fontWeight:600,color:'#475569',marginBottom:6}}>Central Topic</label>
              <input value={settings.topic} onChange={e=>setSettings({...settings,topic:e.target.value})} style={{width:'100%',padding:'8px 12px',border:'1px solid #d1d5db',borderRadius:8,fontSize:13,outline:'none'}}/></div>
            <div><label style={{display:'block',fontSize:13,fontWeight:600,color:'#475569',marginBottom:6}}>Max Layer 1 Sub-topics ({settings.maxLayer1})</label>
              <input type="range" min="2" max="10" value={settings.maxLayer1} onChange={e=>setSettings({...settings,maxLayer1:parseInt(e.target.value)})} style={{width:'100%'}}/></div>
            <div><label style={{display:'block',fontSize:13,fontWeight:600,color:'#475569',marginBottom:6}}>Max Text Nodes per Sub-node</label>
              <input type="number" min="1" max="10" value={settings.maxTextNodes} onChange={e=>setSettings({...settings,maxTextNodes:parseInt(e.target.value)})} style={{width:'100%',padding:'8px 12px',border:'1px solid #d1d5db',borderRadius:8,fontSize:13}}/></div>
            <div><label style={{display:'block',fontSize:13,fontWeight:600,color:'#475569',marginBottom:6}}>Character Limit per Text Node</label>
              <input type="number" min="50" max="1000" step="50" value={settings.charLimit} onChange={e=>setSettings({...settings,charLimit:parseInt(e.target.value)})} style={{width:'100%',padding:'8px 12px',border:'1px solid #d1d5db',borderRadius:8,fontSize:13}}/></div>
            <button onClick={() => { const s={maxLayer1:settings.maxLayer1,maxTextNodes:settings.maxTextNodes,charLimit:settings.charLimit}; socket.emit('settings_changed',{space_id:SPACE_ID,settings:s,user_id:FD.user_id}); }}
              style={{padding:'8px 16px',background:'#3b82f6',color:'#fff',border:'none',borderRadius:8,fontSize:13,fontWeight:600,cursor:'pointer'}}>Broadcast Settings</button>
            <div style={{paddingTop:16,borderTop:'1px solid #e2e8f0'}}>
              <h3 style={{fontSize:14,fontWeight:700,color:'#1e293b',marginBottom:12}}>Session Stats</h3>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}}>
                <div style={{background:'#f0f9ff',padding:12,borderRadius:8,textAlign:'center'}}><div style={{fontSize:20,fontWeight:700,color:'#3b82f6'}}>{allFlat.length}</div><div style={{fontSize:10,color:'#64748b'}}>Total Nodes</div></div>
                <div style={{background:'#f0fdf4',padding:12,borderRadius:8,textAlign:'center'}}><div style={{fontSize:20,fontWeight:700,color:'#10b981'}}>{totalVotes}</div><div style={{fontSize:10,color:'#64748b'}}>Total Votes</div></div>
                <div style={{background:'#fdf4ff',padding:12,borderRadius:8,textAlign:'center'}}><div style={{fontSize:20,fontWeight:700,color:'#a855f7'}}>{totalComments}</div><div style={{fontSize:10,color:'#64748b'}}>Comments</div></div>
                <div style={{background:connected?'#f0fdf4':'#fef2f2',padding:12,borderRadius:8,textAlign:'center'}}><div style={{fontSize:20,fontWeight:700,color:connected?'#10b981':'#ef4444'}}>{onlineUsers.length}</div><div style={{fontSize:10,color:'#64748b'}}>Online</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>)}

      {/* Main Content — paddingBottom reserves space for fixed toolbar so it's not covered on iPad */}
      <div style={{flex:1,display:'flex',flexDirection:'column',minHeight:0,paddingBottom:'calc(56px + env(safe-area-inset-bottom, 0px))'}}>
        {/* Header */}
        <div style={{background:'#0f172a',color:'#fff',padding:'12px 20px',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
          <div style={{display:'flex',alignItems:'center',gap:16}}>
            <a href={FD.back_url} style={{color:'#94a3b8',textDecoration:'none',display:'flex',alignItems:'center'}} title="Back"><ArrowLeftIcon size={18}/></a>
            {FD.user_role==='teacher' && <button onClick={()=>setTeacherPanel(!teacherPanel)} style={{background:teacherPanel?'#334155':'transparent',border:'none',color:'#fff',cursor:'pointer',padding:8,borderRadius:8}}><SettingsIcon size={18}/></button>}
            <div>
              <h1 style={{fontSize:17,fontWeight:700}}>{settings.topic}</h1>
              <div style={{display:'flex',alignItems:'center',gap:8,marginTop:2}}>
                <span style={{display:'inline-block',width:8,height:8,borderRadius:'50%',background:settings.sessionOpen?'#10b981':'#ef4444'}}/>
                <span style={{fontSize:11,color:'#94a3b8'}}>{settings.sessionOpen?'Session Active':'Session Closed'}</span>
                <span style={{fontSize:11,color:'#64748b',marginLeft:8}}>Code: <strong style={{color:'#fbbf24'}}>{FD.space.join_code}</strong></span>
              </div>
            </div>
          </div>
          <div style={{display:'flex',alignItems:'center',gap:16}}>
            {/* Connection indicator */}
            <div style={{display:'flex',alignItems:'center',gap:5}} title={connected?'Live sync active':'Reconnecting...'}>
              <span className="presence-dot" style={{display:'inline-block',width:8,height:8,borderRadius:'50%',background:connected?'#10b981':'#ef4444'}}/>
              <span style={{fontSize:11,color:'#94a3b8'}}>{connected?'Live':'Offline'}</span>
            </div>
            {/* Online users */}
            <div style={{display:'flex',alignItems:'center'}}>
              <UsersIcon size={15} style={{color:'#94a3b8',marginRight:4}}/>
              <span style={{fontSize:11,color:'#94a3b8',marginRight:6}}>{onlineUsers.length}</span>
              {onlineUsers.filter(u=>u.user_id!==FD.user_id).slice(0,5).map(u => (
                <div key={u.user_id} title={u.user_name} style={{width:22,height:22,borderRadius:'50%',background:u.color||'#64748b',border:'2px solid #1e293b',
                  display:'flex',alignItems:'center',justifyContent:'center',marginLeft:-4,fontSize:9,fontWeight:700,color:'#fff'}}>
                  {(u.user_name||'?').charAt(0).toUpperCase()}
                </div>
              ))}
            </div>
            {saveStatus && <span className="save-indicator" style={{fontSize:11,color:saveStatus==='Saved'||saveStatus==='Synced'?'#10b981':'#fbbf24'}}>{saveStatus}</span>}
            {/* Color picker trigger */}
            <div style={{display:'flex',alignItems:'center',gap:6,cursor:'pointer'}} onClick={()=>setShowColorPicker(!showColorPicker)}>
              <span style={{fontSize:12,color:'#94a3b8'}}>Color:</span>
              <div style={{width:22,height:22,borderRadius:'50%',background:currentStudent.color.primary,border:'2px solid #fff'}}/>
            </div>
            {/* Teacher space switcher */}
            {FD.user_role==='teacher' && FD.all_spaces.length>1 && (
              <div style={{borderLeft:'1px solid #334155',paddingLeft:12}}>
                <select value={SPACE_ID} onChange={e=>{if(e.target.value!==SPACE_ID)window.location.href='/teacher/collab-space/'+e.target.value;}}
                  style={{background:'#1e293b',color:'#e2e8f0',border:'1px solid #475569',borderRadius:6,padding:'4px 8px',fontSize:12,cursor:'pointer'}}>
                  {FD.all_spaces.map(s => <option key={s.space_id} value={s.space_id}>{s.name||s.space_id}{s.assigned_group_name?` (${s.assigned_group_name})`:''}</option>)}
                </select>
              </div>
            )}
            {/* View toggle (teacher only) */}
            {FD.user_role==='teacher' && (
            <div style={{display:'flex',gap:4,borderLeft:'1px solid #334155',paddingLeft:12}}>
              {['student','teacher'].map(v => (
                <button key={v} onClick={()=>setUserView(v)} style={{padding:'5px 14px',borderRadius:6,fontSize:12,fontWeight:600,border:'none',cursor:'pointer',
                  background:userView===v?'#3b82f6':'transparent',color:userView===v?'#fff':'#94a3b8'}}>{v.charAt(0).toUpperCase()+v.slice(1)} View</button>
              ))}
            </div>
            )}
          </div>
        </div>

        {/* Color Picker Dropdown */}
        {showColorPicker && (
          <div style={{position:'absolute',right:200,top:52,background:'#fff',borderRadius:12,padding:16,boxShadow:'0 8px 32px rgba(0,0,0,0.15)',zIndex:40,width:220}}>
            <div style={{fontSize:12,fontWeight:600,color:'#475569',marginBottom:10}}>Pick your color <span style={{fontWeight:400,color:'#94a3b8'}}>(taken colors are locked)</span></div>
            <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
              {COLOR_PALETTE.map((c,i) => {
                const mine = currentStudent.color.name === c.name;
                const taken = !mine && takenColors.includes(c.primary);
                return (
                  <div key={i} onClick={()=>{ if(!taken) pickColor(c); }}
                    style={{width:36,height:36,borderRadius:'50%',background:c.primary,
                      border: mine ? '3px solid #1e293b' : taken ? '3px solid #ef4444' : '2px solid #e2e8f0',
                      cursor: taken ? 'not-allowed' : 'pointer', opacity: taken ? 0.3 : 1,
                      display:'flex',alignItems:'center',justifyContent:'center',position:'relative'}}>
                    {mine && <span style={{color:'#fff',fontSize:14,fontWeight:700}}>✓</span>}
                    {taken && <XIcon size={12} style={{color:'#fff'}}/>}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Mind Map + Detail Panel — minHeight:0 so toolbar is not pushed off-screen */}
        <div style={{flex:1,display:'flex',overflow:'hidden',minHeight:0}}>
          <svg ref={svgRef} style={{flex:1,background:'#f8fafc',cursor: dragNodeId ? 'grabbing' : (dragging ? 'grabbing' : 'grab'), touchAction:'none'}}
            viewBox={`${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`}
            onMouseDown={handlePointerDown} onMouseMove={handlePointerMove} onMouseUp={handlePointerUp} onMouseLeave={handlePointerUp}
            onTouchStart={handlePointerDown} onTouchEnd={handlePointerUp} onTouchCancel={handlePointerUp}>
            <defs><pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e2e8f0" strokeWidth="0.5"/></pattern></defs>
            <rect x={viewBox.x-500} y={viewBox.y-500} width={viewBox.w+1000} height={viewBox.h+1000} fill="url(#grid)"/>
            {edges.map((e,i) => <CurvedLine key={i} x1={e.from.x} y1={e.from.y} x2={e.to.x} y2={e.to.y} color={e.color}/>)}
            <MindMapNode node={nodes.central} isSelected={selectedNode?.id==='central'} onMouseDown={handleNodeMouseDown} onAddChild={handleAddChild} userView={userView}/>
            {nodes.layer1.map(n => <MindMapNode key={n.id} node={n} isSelected={selectedNode?.id===n.id} onMouseDown={handleNodeMouseDown} onAddChild={handleAddChild} userView={userView}/>)}
            {nodes.layer2.map(n => <MindMapNode key={n.id} node={n} isSelected={selectedNode?.id===n.id} onMouseDown={handleNodeMouseDown} onAddChild={handleAddChild} userView={userView}/>)}
            {nodes.layer3.map(n => <MindMapNode key={n.id} node={n} isSelected={selectedNode?.id===n.id} onMouseDown={handleNodeMouseDown} onAddChild={handleAddChild} userView={userView}/>)}
            {/* Remote cursors */}
            {Object.entries(remoteCursors).map(([uid,cur]) => <RemoteCursor key={uid} user={cur}/>)}
            {/* Legend — positioned higher so it stays visible above bottom toolbar */}
            <g transform={`translate(${viewBox.x+16},${viewBox.y+viewBox.h-220})`}>
              <rect x="0" y="0" width="170" height="100" rx="8" fill="white" stroke="#e2e8f0" strokeWidth="1" opacity="0.9"/>
              <text x="10" y="16" style={{fontSize:'10px',fontWeight:700,fill:'#475569'}}>Legend</text>
              <rect x="10" y="24" width="20" height="12" rx="6" fill="#0F172A"/><text x="36" y="33" style={{fontSize:'9px',fill:'#64748b'}}>Central Topic</text>
              <rect x="10" y="42" width="20" height="12" rx="6" fill="#1E40AF"/><text x="36" y="51" style={{fontSize:'9px',fill:'#64748b'}}>Sub-topic</text>
              <rect x="10" y="60" width="20" height="12" rx="6" fill="#DBEAFE" stroke="#3B82F6" strokeWidth="0.5"/><text x="36" y="69" style={{fontSize:'9px',fill:'#64748b'}}>Text node (leaf)</text>
              <circle cx="20" cy="86" r="5" fill="#FBBF24"/><text x="36" y="89" style={{fontSize:'9px',fill:'#64748b'}}>Vote count</text>
            </g>
          </svg>

          {/* Right Detail Panel */}
          <div style={{width:360,background:'#fff',borderLeft:'1px solid #e2e8f0',overflowY:'auto',flexShrink:0}}>
            {selectedNode ? (
              <div style={{padding:20}}>
                <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:4}}>
                  {selectedNode.studentColor && <div style={{width:14,height:14,borderRadius:'50%',background:selectedNode.studentColor.primary,border:'2px solid #e2e8f0'}}/>}
                  <h3 style={{fontSize:16,fontWeight:700,color:'#1e293b',flex:1}}>{selectedNode.label}</h3>
                  {selectedNode.isTextNode && <span className="badge" style={{background:'#fef3c7',color:'#92400e',fontSize:10}}>Text Node</span>}
                </div>
                <div style={{display:'flex',gap:8,marginBottom:16}}>
                  <span className="badge" style={{background:'#f1f5f9',color:'#475569'}}>Layer {selectedNode.layer}</span>
                  {selectedNode.studentName && <span className="badge" style={{background:selectedNode.studentColor?.light||'#f1f5f9',color:selectedNode.studentColor?.dark||'#475569'}}>by {selectedNode.studentName}</span>}
                </div>

                {/* Editing mode */}
                {editing ? (
                  <div style={{marginBottom:16}}>
                    <label style={{display:'block',fontSize:12,fontWeight:600,color:'#475569',marginBottom:4}}>Label</label>
                    <input value={editLabel} onChange={e=>setEditLabel(e.target.value.substring(0,30))}
                      style={{width:'100%',padding:'8px 12px',border:'1px solid #d1d5db',borderRadius:8,fontSize:13,outline:'none',marginBottom:10}}/>
                    <label style={{display:'block',fontSize:12,fontWeight:600,color:'#475569',marginBottom:4}}>Content</label>
                    <textarea value={editContent} onChange={e=>setEditContent(e.target.value.substring(0,settings.charLimit))} rows="4"
                      style={{width:'100%',padding:'8px 12px',border:'1px solid #d1d5db',borderRadius:8,fontSize:13,resize:'none',outline:'none',marginBottom:8}}/>
                    <div style={{display:'flex',gap:8}}>
                      <button onClick={saveEdit} style={{flex:1,padding:'8px 12px',background:'#3b82f6',color:'#fff',border:'none',borderRadius:8,fontSize:12,fontWeight:600,cursor:'pointer'}}>Save</button>
                      <button onClick={()=>setEditing(false)} style={{flex:1,padding:'8px 12px',background:'#f1f5f9',color:'#475569',border:'1px solid #d1d5db',borderRadius:8,fontSize:12,fontWeight:600,cursor:'pointer'}}>Cancel</button>
                    </div>
                  </div>
                ) : (
                  <>
                    {selectedNode.content && <div style={{background:'#f0f9ff',padding:14,borderRadius:10,border:'1px solid #bfdbfe',marginBottom:16}}><p style={{fontSize:13,color:'#334155',lineHeight:1.6}}>{selectedNode.content}</p></div>}
                    {selectedNode.textContent && selectedNode.textContent !== selectedNode.content && <div style={{background:'#f0fdf4',padding:14,borderRadius:10,border:'1px solid #bbf7d0',marginBottom:16}}><div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}><FileTextIcon size={14} style={{color:'#16a34a'}}/><span style={{fontSize:11,fontWeight:600,color:'#15803d'}}>Text Content</span></div><p style={{fontSize:13,color:'#334155',lineHeight:1.6}}>{selectedNode.textContent}</p></div>}
                  </>
                )}

                <div style={{display:'flex',gap:8,paddingTop:16,borderTop:'1px solid #e2e8f0',marginBottom:16,flexWrap:'wrap'}}>
                  <button onClick={handleVote} disabled={selectedNode.layer===0} style={{display:'flex',alignItems:'center',gap:6,padding:'8px 14px',background:'#eff6ff',border:'1px solid #bfdbfe',borderRadius:8,cursor:selectedNode.layer===0?'not-allowed':'pointer',color:'#2563eb',fontSize:12,fontWeight:600}}><ThumbsUpIcon size={14}/> {selectedNode.votes||0}</button>
                  <div style={{display:'flex',alignItems:'center',gap:6,padding:'8px 14px',background:'#f8fafc',border:'1px solid #e2e8f0',borderRadius:8,color:'#64748b',fontSize:12}}><MessageIcon size={14}/> {selectedNode.comments?.length||0}</div>
                  {/* Edit button: own nodes only */}
                  {!editing && selectedNode.layer > 0 && (FD.user_role==='teacher' || selectedNode.studentId === currentStudent.id) && (
                    <button onClick={startEditing} style={{display:'flex',alignItems:'center',gap:5,padding:'8px 12px',background:'#f0f9ff',border:'1px solid #bfdbfe',borderRadius:8,cursor:'pointer',color:'#2563eb',fontSize:12,fontWeight:600}}><EditIcon size={13}/> Edit</button>
                  )}
                  {/* Delete */}
                  {selectedNode.layer>0 && (FD.user_role==='teacher' || selectedNode.studentId===currentStudent.id) && (
                    <button onClick={()=>handleDeleteNode(selectedNode.id)} style={{display:'flex',alignItems:'center',gap:5,padding:'8px 10px',background:'#fef2f2',border:'1px solid #fecaca',borderRadius:8,cursor:'pointer',color:'#dc2626',fontSize:12,marginLeft:'auto'}}><TrashIcon size={13}/> Delete</button>
                  )}
                </div>

                {/* Comments section */}
                <div style={{borderTop:'1px solid #e2e8f0',paddingTop:16}}>
                  <h4 style={{fontSize:14,fontWeight:700,color:'#1e293b',marginBottom:12}}>Comments</h4>
                  {selectedNode.comments&&selectedNode.comments.length>0 ? (
                    <div style={{display:'flex',flexDirection:'column',gap:10,marginBottom:16}}>
                      {selectedNode.comments.map(c => (<div key={c.id} style={{background:'#f8fafc',padding:12,borderRadius:10,border:'1px solid #e2e8f0'}}><div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}><div style={{width:10,height:10,borderRadius:'50%',background:c.studentColor?.primary||'#94a3b8'}}/><span style={{fontSize:11,fontWeight:600,color:'#475569'}}>{c.name}</span></div><p style={{fontSize:12,color:'#64748b',lineHeight:1.5}}>{c.text}</p></div>))}
                    </div>
                  ) : <p style={{fontSize:12,color:'#94a3b8',marginBottom:16}}>No comments yet</p>}
                  {userView==='student' && (
                    <div>
                      <textarea value={commentText} onChange={e=>setCommentText(e.target.value)} placeholder="Add a comment..." rows="2" style={{width:'100%',padding:'8px 12px',border:'1px solid #d1d5db',borderRadius:8,fontSize:12,resize:'none',outline:'none',marginBottom:8}}/>
                      <button onClick={handleComment} disabled={!commentText.trim()} style={{width:'100%',padding:'8px 12px',background:commentText.trim()?'#3b82f6':'#d1d5db',color:'#fff',border:'none',borderRadius:8,fontSize:12,fontWeight:600,cursor:commentText.trim()?'pointer':'not-allowed',display:'flex',alignItems:'center',justifyContent:'center',gap:6}}><SendIcon size={13}/> Post Comment</button>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100%',color:'#94a3b8',textAlign:'center',padding:40}}>
                <MessageIcon size={48} style={{marginBottom:16,opacity:0.3}}/>
                <p style={{fontSize:14,fontWeight:500}}>Click a node to view details</p>
                <p style={{fontSize:12,marginTop:8}}>Select any node on the mind map to see its content, vote, or add comments.</p>
                <p style={{fontSize:11,marginTop:12,color:'#cbd5e1'}}>Drag nodes to reposition them</p>
              </div>
            )}
          </div>
        </div>

        {/* Bottom Export Toolbar — fixed to viewport so always visible on iPad (Safari 100vh issue) */}
        <div style={{position:'fixed',bottom:0,left:0,right:0,background:'#f1f5f9',borderTop:'1px solid #e2e8f0',padding:'10px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',minHeight:56,zIndex:50,
          paddingBottom:'max(10px, env(safe-area-inset-bottom))'}}>
          <div style={{display:'flex',alignItems:'center',gap:12,flexWrap:'wrap'}}>
            <span style={{fontSize:11,color:'#64748b'}}>Nodes: <strong style={{color:'#1e293b'}}>{allFlat.length}</strong></span>
            <span style={{fontSize:11,color:'#64748b'}}>Votes: <strong style={{color:'#1e293b'}}>{totalVotes}</strong></span>
            {!isTeacher && <span style={{fontSize:11,color:'#64748b'}}>Generations left: <strong style={{color:canGenerate?'#1e293b':'#ef4444'}}>{maxGenerations - generationsUsed}/{maxGenerations}</strong></span>}
            {isTeacher && <span style={{fontSize:11,color:'#10b981',fontWeight:600}}>Unlimited (Teacher)</span>}
            {genStatus && <span style={{fontSize:11,color:'#7c3aed',fontWeight:500}}>{genStatus}</span>}
          </div>
          <div style={{display:'flex',gap:8,flexShrink:0,alignItems:'center'}}>
            <button type="button" onClick={handleGenerateInfographic} disabled={(!canGenerate && !isTeacher)||!FD.has_api_key}
              style={{display:'flex',alignItems:'center',justifyContent:'center',gap:5,minHeight:44,minWidth:44,padding:'10px 16px',background:((!canGenerate&&!isTeacher)||!FD.has_api_key)?'#94a3b8':'#7c3aed',color:'#fff',border:'none',borderRadius:8,fontSize:12,fontWeight:600,cursor:((!canGenerate&&!isTeacher)||!FD.has_api_key)?'not-allowed':'pointer',WebkitTapHighlightColor:'transparent'}}
              title={!FD.has_api_key?'Teacher must set Nanobanana API key':((!canGenerate&&!isTeacher)?'No generations left':'Generate infographic')}>
              <BarChartIcon size={14}/> Infographic
            </button>
            <button type="button" onClick={handleGeneratePDF} disabled={!canGenerate && !isTeacher}
              style={{display:'flex',alignItems:'center',justifyContent:'center',gap:5,minHeight:44,minWidth:44,padding:'10px 16px',background:(!canGenerate&&!isTeacher)?'#94a3b8':'#dc2626',color:'#fff',border:'none',borderRadius:8,fontSize:12,fontWeight:600,cursor:(!canGenerate&&!isTeacher)?'not-allowed':'pointer',WebkitTapHighlightColor:'transparent'}}
              title={(!canGenerate&&!isTeacher)?'No generations left':'Generate PDF report'}>
              <DownloadIcon size={14}/> Study Notes PDF
            </button>
          </div>
        </div>
      </div>

      {/* Add Content Modal */}
      {showAddModal && (
        <div className="modal-overlay" style={{position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',zIndex:60}}>
          <div className="modal-content" style={{background:'#fff',borderRadius:16,padding:28,maxWidth:440,width:'90%',boxShadow:'0 16px 48px rgba(0,0,0,0.2)'}}>
            <h3 style={{fontSize:18,fontWeight:700,color:'#1e293b',marginBottom:4}}>Add Content</h3>
            <p style={{fontSize:12,color:'#64748b',marginBottom:16}}>Adding to: <strong>{addTarget?.label}</strong> (Layer {(addTarget?.layer||0)+1})</p>
            {/* Text Node toggle (available from layer 1 onwards) */}
            {addTarget && addTarget.layer >= 1 && (
              <div style={{display:'flex',gap:8,marginBottom:16}}>
                <button onClick={()=>setAddAsTextNode(false)}
                  style={{flex:1,padding:'10px',borderRadius:10,fontSize:13,fontWeight:600,cursor:'pointer',
                    background:!addAsTextNode?'#3b82f6':'#f1f5f9',color:!addAsTextNode?'#fff':'#64748b',
                    border:!addAsTextNode?'none':'1px solid #e2e8f0'}}>
                  Sub-topic
                </button>
                <button onClick={()=>setAddAsTextNode(true)}
                  style={{flex:1,padding:'10px',borderRadius:10,fontSize:13,fontWeight:600,cursor:'pointer',
                    background:addAsTextNode?'#f59e0b':'#f1f5f9',color:addAsTextNode?'#fff':'#64748b',
                    border:addAsTextNode?'none':'1px solid #e2e8f0'}}>
                  Text Node (leaf)
                </button>
              </div>
            )}
            {addAsTextNode && (
              <div style={{background:'#fef3c7',padding:10,borderRadius:8,marginBottom:12,fontSize:11,color:'#92400e',lineHeight:1.5}}>
                Text nodes are leaf nodes — no further branches can be added to them.
              </div>
            )}
            <div style={{marginBottom:16}}>
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}><label style={{fontSize:12,fontWeight:600,color:'#475569'}}>Content</label><span style={{fontSize:11,color:contentText.length>=settings.charLimit?'#ef4444':'#94a3b8'}}>{contentText.length}/{settings.charLimit}</span></div>
              <textarea value={contentText} onChange={e=>setContentText(e.target.value.substring(0,settings.charLimit))} placeholder="Enter your content..." rows="4" style={{width:'100%',padding:'10px 14px',border:'1px solid #d1d5db',borderRadius:10,fontSize:13,resize:'none',outline:'none',lineHeight:1.6}}/>
              <div style={{height:4,borderRadius:2,background:'#e2e8f0',marginTop:6}}><div style={{height:'100%',borderRadius:2,background:contentText.length>=settings.charLimit?'#ef4444':'#3b82f6',width:`${Math.min(100,(contentText.length/settings.charLimit)*100)}%`,transition:'width 0.2s'}}/></div>
            </div>
            <label style={{display:'flex',alignItems:'center',gap:8,cursor:'pointer',marginBottom:20}}>
              <input type="checkbox" checked={contentImage} onChange={e=>setContentImage(e.target.checked)}/><ImageIcon size={16} style={{color:'#ca8a04'}}/><span style={{fontSize:13,color:'#475569'}}>Include image</span>
            </label>
            <div style={{display:'flex',gap:10}}>
              <button onClick={()=>{setShowAddModal(false);setContentText('');setContentImage(false);setAddAsTextNode(false);}} style={{flex:1,padding:'10px 16px',border:'1px solid #d1d5db',borderRadius:10,background:'#fff',cursor:'pointer',fontSize:13,fontWeight:600,color:'#475569'}}>Cancel</button>
              <button onClick={handleCreate} disabled={!contentText.trim()} style={{flex:1,padding:'10px 16px',border:'none',borderRadius:10,background:contentText.trim()?'#3b82f6':'#d1d5db',color:'#fff',cursor:contentText.trim()?'pointer':'not-allowed',fontSize:13,fontWeight:600}}>Create Node</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
{% endraw %}
</body>
</html>
