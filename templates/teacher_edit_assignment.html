{% extends "base.html" %}

{% block title %}Edit Assignment - Teacher Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark teacher-nav">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('teacher_dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>Teacher Portal
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="{{ url_for('teacher_logout') }}">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('teacher_assignments') }}">Assignments</a></li>
            <li class="breadcrumb-item active">Edit</li>
        </ol>
    </nav>
    
    <div class="page-header mb-4">
        <h1><i class="bi bi-pencil me-2"></i>Edit Assignment</h1>
        <p class="text-muted">Assignment ID: <code>{{ assignment.assignment_id }}</code></p>
    </div>
    
    {% if error %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-circle me-2"></i>{{ error }}
    </div>
    {% endif %}
    
    {% if success %}
    <div class="alert alert-success">
        <i class="bi bi-check-circle me-2"></i>{{ success }}
    </div>
    {% endif %}
    
    <form method="POST" enctype="multipart/form-data" id="edit-assignment-form">
        <div class="row">
            <div class="col-lg-8">
                <!-- Basic Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">Assignment Title *</label>
                            <input type="text" class="form-control" id="title" name="title" required 
                                   value="{{ assignment.title }}">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="subject" class="form-label">Subject *</label>
                                <input type="text" class="form-control" id="subject" name="subject" required
                                       value="{{ assignment.subject }}" list="subjects-list">
                                <datalist id="subjects-list">
                                    {% if teacher.subjects %}
                                    {% for subj in teacher.subjects %}
                                    <option value="{{ subj }}">
                                    {% endfor %}
                                    {% endif %}
                                </datalist>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="due_date" class="form-label">Due Date (optional)</label>
                                <input type="date" class="form-control" id="due_date" name="due_date"
                                       value="{{ assignment.due_date or '' }}">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="total_marks" class="form-label">Total Marks *</label>
                                <input type="number" class="form-control" id="total_marks" name="total_marks" 
                                       min="1" value="{{ assignment.total_marks or 100 }}" required>
                            </div>
                        </div>
                        
                        {% if assignment.marking_type != 'rubric' %}
                        <div class="mb-3" id="award-marks-container">
                            <label class="form-label">Grading display</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="award_marks" id="award_marks_yes" value="on"
                                       {% if assignment.get('award_marks', True) %}checked{% endif %}>
                                <label class="form-check-label" for="award_marks_yes">
                                    <i class="bi bi-star me-1"></i>Award marks
                                </label>
                                <small class="text-muted d-block ms-4">Students see marks per question and total score</small>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="award_marks" id="award_marks_no" value="off"
                                       {% if not assignment.get('award_marks', True) %}checked{% endif %}>
                                <label class="form-check-label" for="award_marks_no">
                                    <i class="bi bi-check2-all me-1"></i>No marks (Correct / Partial correct / Incorrect)
                                </label>
                                <small class="text-muted d-block ms-4">Students see only result per question: Correct, Partial correct, or Incorrect</small>
                            </div>
                        </div>
                        {% else %}
                        <input type="hidden" name="award_marks" value="on">
                        {% endif %}
                        
                        <div class="mb-3">
                            <label class="form-label">When to send feedback to student</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="send_ai_feedback_immediately" id="feedback_teacher_first" value="off"
                                       {% if not assignment.get('send_ai_feedback_immediately', False) %}checked{% endif %}>
                                <label class="form-check-label" for="feedback_teacher_first">
                                    <i class="bi bi-person-check me-1"></i>Teacher reviews first (default)
                                </label>
                                <small class="text-muted d-block ms-4">AI generates feedback but students only see it after you review and send</small>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="send_ai_feedback_immediately" id="feedback_ai_straightaway" value="on"
                                       {% if assignment.get('send_ai_feedback_immediately', False) %}checked{% endif %}>
                                <label class="form-check-label" for="feedback_ai_straightaway">
                                    <i class="bi bi-robot me-1"></i>Send AI feedback to student straight away
                                </label>
                                <small class="text-muted d-block ms-4">Students see AI feedback as soon as they submit (you can still review and add comments later)</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="instructions" class="form-label">Instructions (optional)</label>
                            <textarea class="form-control" id="instructions" name="instructions" rows="3">{{ assignment.instructions or '' }}</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Documents - Between Basic Info and Assign To -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-file-pdf me-2"></i>Upload Documents</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Question Paper -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Question Paper *</label>
                                {% if assignment.question_paper_id %}
                                <div class="current-file mb-2">
                                    <a href="{{ url_for('download_assignment_file', assignment_id=assignment.assignment_id, file_type='question_paper') }}" 
                                       target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-file-earmark-pdf me-1"></i>
                                        {{ assignment.question_paper_name or 'question_paper.pdf' }}
                                    </a>
                                </div>
                                {% endif %}
                                <div class="upload-zone {% if assignment.question_paper_id %}has-file{% endif %}" id="question-zone">
                                    <input type="file" class="form-control d-none" id="question_paper" name="question_paper" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'question')">
                                    <label for="question_paper" class="upload-label">
                                        <div class="upload-icon">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </div>
                                        <p class="mb-0 small">{% if assignment.question_paper_id %}Replace file{% else %}Upload PDF{% endif %}</p>
                                        <span class="file-name" id="question-filename">
                                            {% if assignment.question_paper_id %}Click to replace{% else %}Click to upload{% endif %}
                                        </span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Answer Key -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Answer Key *</label>
                                {% if assignment.answer_key_id %}
                                <div class="current-file mb-2">
                                    <a href="{{ url_for('download_assignment_file', assignment_id=assignment.assignment_id, file_type='answer_key') }}" 
                                       target="_blank" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-file-earmark-check me-1"></i>
                                        {{ assignment.answer_key_name or 'answer_key.pdf' }}
                                    </a>
                                </div>
                                {% endif %}
                                <div class="upload-zone {% if assignment.answer_key_id %}has-file{% endif %}" id="answer-zone">
                                    <input type="file" class="form-control d-none" id="answer_key" name="answer_key" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'answer')">
                                    <label for="answer_key" class="upload-label">
                                        <div class="upload-icon answer">
                                            <i class="bi bi-file-earmark-check"></i>
                                        </div>
                                        <p class="mb-0 small">{% if assignment.answer_key_id %}Replace file{% else %}Upload PDF{% endif %}</p>
                                        <span class="file-name" id="answer-filename">
                                            {% if assignment.answer_key_id %}Click to replace{% else %}Click to upload{% endif %}
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Reference Materials -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Reference Materials</label>
                                {% if assignment.reference_materials_id %}
                                <div class="current-file mb-2">
                                    <a href="{{ url_for('download_assignment_file', assignment_id=assignment.assignment_id, file_type='reference_materials') }}" 
                                       target="_blank" class="btn btn-outline-purple btn-sm">
                                        <i class="bi bi-book me-1"></i>
                                        {{ assignment.reference_materials_name or 'reference_materials.pdf' }}
                                    </a>
                                </div>
                                {% endif %}
                                <div class="upload-zone {% if assignment.reference_materials_id %}has-file{% endif %}" id="reference-zone">
                                    <input type="file" class="form-control d-none" id="reference_materials" name="reference_materials" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'reference')">
                                    <label for="reference_materials" class="upload-label">
                                        <div class="upload-icon reference">
                                            <i class="bi bi-book"></i>
                                        </div>
                                        <p class="mb-0 small">{% if assignment.reference_materials_id %}Replace file{% else %}Upload PDF (optional){% endif %}</p>
                                        <span class="file-name" id="reference-filename">
                                            {% if assignment.reference_materials_id %}Click to replace{% else %}Click to upload{% endif %}
                                        </span>
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-1">Literature, history content, passages, etc.</small>
                            </div>
                            
                            <!-- Rubrics -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Rubrics</label>
                                {% if assignment.rubrics_id %}
                                <div class="current-file mb-2">
                                    <a href="{{ url_for('download_assignment_file', assignment_id=assignment.assignment_id, file_type='rubrics') }}" 
                                       target="_blank" class="btn btn-outline-orange btn-sm">
                                        <i class="bi bi-list-check me-1"></i>
                                        {{ assignment.rubrics_name or 'rubrics.pdf' }}
                                    </a>
                                </div>
                                {% endif %}
                                <div class="upload-zone {% if assignment.rubrics_id %}has-file{% endif %}" id="rubrics-zone">
                                    <input type="file" class="form-control d-none" id="rubrics" name="rubrics" 
                                           accept=".pdf" onchange="handleFileSelect(this, 'rubrics')">
                                    <label for="rubrics" class="upload-label">
                                        <div class="upload-icon rubrics">
                                            <i class="bi bi-list-check"></i>
                                        </div>
                                        <p class="mb-0 small">{% if assignment.rubrics_id %}Replace file{% else %}Upload PDF (optional){% endif %}</p>
                                        <span class="file-name" id="rubrics-filename">
                                            {% if assignment.rubrics_id %}Click to replace{% else %}Click to upload{% endif %}
                                        </span>
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-1">Grading criteria for essays/subjective answers.</small>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Leave fields empty to keep existing files. Upload new files to replace them.
                            <br><small class="mt-1 d-block"><i class="bi bi-check-circle me-1"></i>Answer key uses full PDF vision for maximum accuracy. Reference materials &amp; rubrics use text extraction for efficiency.</small>
                        </div>
                    </div>
                </div>
                
                <!-- Assignment Target (Class or Teaching Group) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Assign To</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Choose whether to assign this to an entire class or a specific teaching group.</p>
                        
                        {% set current_target_type = assignment.get('target_type', 'class') %}
                        <div class="mb-3">
                            <label class="form-label">Assignment Target *</label>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="target_type" id="target_class" value="class" {% if current_target_type == 'class' %}checked{% endif %}>
                                        <label class="form-check-label" for="target_class">
                                            <i class="bi bi-collection me-1"></i>Entire Class
                                        </label>
                                    </div>
                                    <select class="form-select mt-2" id="target_class_id" name="target_class_id" {% if current_target_type != 'class' %}disabled{% endif %}>
                                        <option value="">Select a class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}" {% if assignment.get('target_class_id') == c.class_id %}selected{% endif %}>{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="target_type" id="target_group" value="teaching_group" {% if current_target_type == 'teaching_group' %}checked{% endif %}>
                                        <label class="form-check-label" for="target_group">
                                            <i class="bi bi-diagram-3 me-1"></i>Teaching Group
                                        </label>
                                    </div>
                                    <select class="form-select mt-2" id="target_group_id" name="target_group_id" {% if current_target_type != 'teaching_group' %}disabled{% endif %}>
                                        <option value="">Select a teaching group...</option>
                                        {% for g in teaching_groups %}
                                        <option value="{{ g.group_id }}" {% if assignment.get('target_group_id') == g.group_id %}selected{% endif %}>{{ g.name }} ({{ g.class_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <small class="text-muted">Leave empty to make the assignment available to all your students.</small>
                        </div>
                    </div>
                </div>
                
                <!-- AI Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Marking Configuration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Configure which AI model to use for reviewing and grading this assignment, and provide additional instructions for feedback and grading.</p>
                        
                        <div class="mb-3">
                            <label for="ai_model" class="form-label">AI Model for This Assignment *</label>
                            {% set current_model = assignment.get('ai_model', teacher.get('default_ai_model', 'anthropic')) %}
                            <select class="form-select" id="ai_model" name="ai_model" required>
                                <option value="anthropic" {% if current_model == 'anthropic' %}selected{% endif %}>Anthropic (Claude)</option>
                                <option value="openai" {% if current_model == 'openai' %}selected{% endif %}>OpenAI (GPT)</option>
                                <option value="deepseek" {% if current_model == 'deepseek' %}selected{% endif %}>DeepSeek</option>
                                <option value="google" {% if current_model == 'google' %}selected{% endif %}>Google Gemini</option>
                            </select>
                            <small class="text-muted">Your default model: <strong>{{ teacher.get('default_ai_model', 'anthropic')|title }}</strong></small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="feedback_instructions" class="form-label">Additional Instructions for Feedback (optional)</label>
                            <textarea class="form-control" id="feedback_instructions" name="feedback_instructions" rows="3"
                                      placeholder="e.g., Focus on explaining common mistakes, provide step-by-step guidance, emphasize conceptual understanding...">{{ assignment.get('feedback_instructions', '') }}</textarea>
                            <small class="text-muted">These instructions will guide the AI when providing feedback to students.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="grading_instructions" class="form-label">Additional Instructions for Grading (optional)</label>
                            <textarea class="form-control" id="grading_instructions" name="grading_instructions" rows="3"
                                      placeholder="e.g., Be strict with calculation errors, award partial credit for showing work, deduct points for missing units...">{{ assignment.get('grading_instructions', '') }}</textarea>
                            <small class="text-muted">These instructions will guide the AI when grading student submissions.</small>
                        </div>
                    </div>
                </div>
                
                <!-- Student AI Help Limits -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Student AI Help Limits</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Control how many times students can request AI help for this assignment. This helps manage API costs.</p>
                        
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Note:</strong> Students will see alerts on their dashboard about remaining help requests.
                        </div>
                        
                        <div class="row">
                            <!-- Overall Review Settings -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable_overall_review" name="enable_overall_review" 
                                                   {% if assignment.get('enable_overall_review', True) %}checked{% endif %}>
                                            <label class="form-check-label fw-bold" for="enable_overall_review">
                                                <i class="bi bi-eye me-1"></i>Enable Overall Review
                                            </label>
                                        </div>
                                        <p class="text-muted small mb-2">Students can request AI to review their entire submission before final submit.</p>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">Max reviews</span>
                                            <input type="number" class="form-control" id="overall_review_limit" name="overall_review_limit" 
                                                   value="{{ assignment.get('overall_review_limit', 1) }}" min="0" max="10">
                                            <span class="input-group-text">times</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Question Help Settings -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable_question_help" name="enable_question_help"
                                                   {% if assignment.get('enable_question_help', True) %}checked{% endif %}>
                                            <label class="form-check-label fw-bold" for="enable_question_help">
                                                <i class="bi bi-question-circle me-1"></i>Enable Question Help
                                            </label>
                                        </div>
                                        <p class="text-muted small mb-2">Students can ask AI for hints and guidance on specific questions.</p>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">Max questions</span>
                                            <input type="number" class="form-control" id="question_help_limit" name="question_help_limit" 
                                                   value="{{ assignment.get('question_help_limit', 5) }}" min="0" max="50">
                                            <span class="input-group-text">times</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="summary-item">
                            <span>Question Paper:</span>
                            <strong id="summary-question">
                                {% if assignment.question_paper_id %}
                                <span class="text-success"><i class="bi bi-check-circle"></i></span>
                                {% else %}
                                <span class="text-danger">Missing</span>
                                {% endif %}
                            </strong>
                        </div>
                        <div class="summary-item">
                            <span>Answer Key:</span>
                            <strong id="summary-answer">
                                {% if assignment.answer_key_id %}
                                <span class="text-success"><i class="bi bi-check-circle"></i></span>
                                {% else %}
                                <span class="text-danger">Missing</span>
                                {% endif %}
                            </strong>
                        </div>
                        <div class="summary-item">
                            <span>Reference Materials:</span>
                            <strong id="summary-reference">
                                {% if assignment.reference_materials_id %}
                                <span class="text-success"><i class="bi bi-check-circle"></i></span>
                                {% else %}
                                <span class="text-muted">Optional</span>
                                {% endif %}
                            </strong>
                        </div>
                        <div class="summary-item">
                            <span>Rubrics:</span>
                            <strong id="summary-rubrics">
                                {% if assignment.rubrics_id %}
                                <span class="text-success"><i class="bi bi-check-circle"></i></span>
                                {% else %}
                                <span class="text-muted">Optional</span>
                                {% endif %}
                            </strong>
                        </div>
                        <div class="summary-item">
                            <span>Total Marks:</span>
                            <strong id="summary-marks">{{ assignment.total_marks or 100 }}</strong>
                        </div>
                        <div class="summary-item">
                            <span>Status:</span>
                            <strong>
                                {% if assignment.status == 'published' %}
                                <span class="badge bg-success">Published</span>
                                {% else %}
                                <span class="badge bg-secondary">Draft</span>
                                {% endif %}
                            </strong>
                        </div>
                        
                        <hr>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="publish" name="publish" 
                                   {% if assignment.status == 'published' %}checked{% endif %}>
                            <label class="form-check-label" for="publish">
                                Published
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save me-2"></i>Save Changes
                            </button>
                            <a href="{{ url_for('teacher_assignments') }}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    background: #fafafa;
}

.upload-zone:hover,
.upload-zone.dragover {
    border-color: var(--teacher-primary);
    background: #f0f7ff;
}

.upload-zone.has-file {
    border-color: #28a745;
    background: #f0fff4;
}

.upload-label {
    cursor: pointer;
    display: block;
    margin: 0;
}

.upload-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #0d6efd, #0a58ca);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
}

.upload-icon.answer {
    background: linear-gradient(135deg, #198754, #146c43);
}

.upload-icon.reference {
    background: linear-gradient(135deg, #6f42c1, #5a32a3);
}

.upload-icon.rubrics {
    background: linear-gradient(135deg, #fd7e14, #dc6a10);
}

.btn-outline-purple {
    color: #6f42c1;
    border-color: #6f42c1;
}
.btn-outline-purple:hover {
    color: #fff;
    background-color: #6f42c1;
    border-color: #6f42c1;
}

.btn-outline-orange {
    color: #fd7e14;
    border-color: #fd7e14;
}
.btn-outline-orange:hover {
    color: #fff;
    background-color: #fd7e14;
    border-color: #fd7e14;
}

.upload-icon i {
    font-size: 18px;
    color: white;
}

.file-name {
    display: block;
    margin-top: 5px;
    font-size: 0.8rem;
    color: #6c757d;
    word-break: break-all;
}

.upload-zone.has-file .file-name {
    color: #28a745;
    font-weight: 500;
}

.current-file {
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.summary-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    function handleFileSelect(input, type) {
        const zone = document.getElementById(type + '-zone');
        const filename = document.getElementById(type + '-filename');
        const summary = document.getElementById('summary-' + type);
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            zone.classList.add('has-file');
            filename.textContent = file.name;
            summary.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> New</span>';
        }
    }
    
    // Update marks summary
    document.getElementById('total_marks').addEventListener('input', function() {
        document.getElementById('summary-marks').textContent = this.value || '0';
    });
    
    // Drag and drop
    ['question-zone', 'answer-zone', 'reference-zone', 'rubrics-zone'].forEach(zoneId => {
        const zone = document.getElementById(zoneId);
        const input = zone.querySelector('input[type="file"]');
        
        ['dragenter', 'dragover'].forEach(eventName => {
            zone.addEventListener(eventName, (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
            });
        });
        
        zone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length && files[0].type === 'application/pdf') {
                input.files = files;
                input.dispatchEvent(new Event('change'));
            }
        });
    });
    
    // Toggle between class and teaching group selection
    document.querySelectorAll('input[name="target_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const isClass = this.value === 'class';
            document.getElementById('target_class_id').disabled = !isClass;
            document.getElementById('target_group_id').disabled = isClass;
            
            // Clear the disabled field
            if (isClass) {
                document.getElementById('target_group_id').value = '';
            } else {
                document.getElementById('target_class_id').value = '';
            }
        });
    });
</script>
{% endblock %}
