{% extends "base.html" %}

{% block title %}Admin Dashboard - School Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark admin-nav">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">
            <i class="bi bi-shield-lock me-2"></i>Admin Panel
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="{{ url_for('admin_logout') }}">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="page-header mb-4">
        <h1><i class="bi bi-speedometer2 me-2"></i>Admin Dashboard</h1>
        <p class="text-muted">Manage students, teachers, and system settings</p>
    </div>
    
    <!-- Stats -->
    <div class="row g-4 mb-5">
        <div class="col-md-4 col-lg">
            <div class="stat-card stat-primary">
                <div class="stat-icon"><i class="bi bi-people"></i></div>
                <div class="stat-info">
                    <h3>{{ stats.students }}</h3>
                    <p>Students</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-lg">
            <div class="stat-card stat-success">
                <div class="stat-icon"><i class="bi bi-person-workspace"></i></div>
                <div class="stat-info">
                    <h3>{{ stats.teachers }}</h3>
                    <p>Teachers</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-lg">
            <div class="stat-card stat-info">
                <div class="stat-icon"><i class="bi bi-collection"></i></div>
                <div class="stat-info">
                    <h3>{{ stats.classes }}</h3>
                    <p>Classes</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-lg">
            <div class="stat-card stat-warning">
                <div class="stat-icon"><i class="bi bi-journal-text"></i></div>
                <div class="stat-info">
                    <h3>{{ stats.assignments }}</h3>
                    <p>Assignments</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-lg">
            <div class="stat-card stat-secondary">
                <div class="stat-icon"><i class="bi bi-check2-square"></i></div>
                <div class="stat-info">
                    <h3>{{ stats.submissions }}</h3>
                    <p>Submissions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classes" type="button">
                <i class="bi bi-collection me-1"></i>Classes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button">
                <i class="bi bi-people me-1"></i>Students
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachers" type="button">
                <i class="bi bi-person-workspace me-1"></i>Teachers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="teaching-groups-tab" data-bs-toggle="tab" data-bs-target="#teaching-groups" type="button">
                <i class="bi bi-diagram-3 me-1"></i>Teaching Groups
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="prompts-tab" data-bs-toggle="tab" data-bs-target="#prompts" type="button">
                <i class="bi bi-robot me-1"></i>AI Prompts
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="module-access-tab" data-bs-toggle="tab" data-bs-target="#module-access" type="button">
                <i class="bi bi-journal-bookmark me-1"></i>Learning Modules
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button">
                <i class="bi bi-file-earmark-pdf me-1"></i>Reports & Tools
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="adminTabsContent">
        <!-- Students Tab -->
        <div class="tab-pane fade" id="students" role="tabpanel">
            <div class="row g-4">
                <!-- Manage Students (First) -->
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Manage Students</h5>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning" id="reset-selected-passwords" disabled data-bs-toggle="modal" data-bs-target="#mass-reset-modal">
                                    <i class="bi bi-key me-1"></i>Reset Passwords
                                </button>
                                <button class="btn btn-outline-danger" id="delete-selected-students" disabled>
                                    <i class="bi bi-trash me-1"></i>Delete Selected
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filter -->
                            <div class="row mb-3">
                                <div class="col">
                                    <select class="form-select form-select-sm" id="filter-class">
                                        <option value="">All Classes</option>
                                        <option value="__unassigned__">Unassigned (No Class)</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-danger btn-sm" id="delete-by-class" disabled>
                                        <i class="bi bi-trash me-1"></i>Delete Class
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Assign to Class -->
                            <div class="row mb-3 align-items-center" id="assign-class-section" style="display: none;">
                                <div class="col">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="bi bi-arrow-right-circle me-1"></i>Assign to
                                        </span>
                                        <select class="form-select form-select-sm" id="assign-to-class">
                                            <option value="">Select class...</option>
                                            {% for c in classes %}
                                            <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                            {% endfor %}
                                        </select>
                                        <button class="btn btn-primary btn-sm" id="assign-class-btn" disabled>
                                            <i class="bi bi-check-lg"></i> Assign
                                        </button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <small class="text-muted"><span id="selected-count">0</span> selected</small>
                                </div>
                            </div>

                            <!-- Students Table -->
                            <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                <table class="table table-sm table-hover" id="students-table">
                                    <thead class="sticky-top bg-white">
                                        <tr>
                                            <th><input type="checkbox" id="select-all-students"></th>
                                            <th>Name</th>
                                            <th>Class</th>
                                            <th>Teachers</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="students-tbody">
                                        <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import Students (Second) -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Import Students</h5>
                        </div>
                        <div class="card-body">
                            <!-- Import Method Tabs -->
                            <ul class="nav nav-pills mb-3" id="importMethod" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#excel-paste">
                                        <i class="bi bi-table me-1"></i>Excel Paste
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#csv-upload">
                                        <i class="bi bi-file-earmark-csv me-1"></i>CSV Upload
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content">
                                <!-- Excel Paste -->
                                <div class="tab-pane fade show active" id="excel-paste">
                                    <div class="alert alert-info small py-2 mb-3">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <strong>Tip:</strong> Click any cell and paste from Excel (Ctrl+V), or type directly. Press Tab to move between cells.
                                    </div>
                                    
                                    <!-- Spreadsheet Grid -->
                                    <div class="spreadsheet-container">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted small"><span id="row-count">0</span> students</span>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" onclick="addEmptyRow()">
                                                    <i class="bi bi-plus me-1"></i>Add Row
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="clearAllRows()">
                                                    <i class="bi bi-trash me-1"></i>Clear All
                                                </button>
                                            </div>
                                        </div>
                                        <div class="table-responsive spreadsheet-wrapper" id="spreadsheet-wrapper">
                                            <table class="table table-sm table-bordered spreadsheet-table mb-0" id="spreadsheet-table">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th style="width: 100px;">Student ID *</th>
                                                        <th style="width: 150px;">Name *</th>
                                                        <th style="width: 80px;">Class</th>
                                                        <th style="width: 100px;">Password</th>
                                                        <th style="width: 120px;">Teachers</th>
                                                        <th style="width: 40px;"></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="spreadsheet-tbody">
                                                    <!-- Empty rows will be populated by JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2 mt-3">
                                        <button class="btn btn-primary" id="import-excel-btn" disabled>
                                            <i class="bi bi-upload me-1"></i>Import <span id="import-count">0</span> Students
                                        </button>
                                    </div>
                                </div>

                                <!-- CSV Upload -->
                                <div class="tab-pane fade" id="csv-upload">
                                    <p class="text-muted small">Upload a CSV file with headers: <code>student_id, name, class, password, teachers</code></p>
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="csv-file" accept=".csv">
                                    </div>
                                    <button class="btn btn-primary" id="import-csv-btn">
                                        <i class="bi bi-upload me-1"></i>Import CSV
                                    </button>
                                    <a href="#" class="btn btn-outline-secondary" id="download-template">
                                        <i class="bi bi-download me-1"></i>Download Template
                                    </a>
                                </div>
                            </div>

                            <div id="import-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teachers Tab -->
        <div class="tab-pane fade" id="teachers" role="tabpanel">
            <div class="row g-4">
                <!-- Add Teacher -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>Add Teacher</h5>
                        </div>
                        <div class="card-body">
                            <form id="add-teacher-form">
                                <div class="mb-3">
                                    <label class="form-label">Teacher ID *</label>
                                    <input type="text" class="form-control" id="teacher_id" placeholder="e.g., T001" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Name *</label>
                                    <input type="text" class="form-control" id="teacher_name" placeholder="Full name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input type="text" class="form-control" id="teacher_password" placeholder="Default: teacher123">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subjects (comma-separated)</label>
                                    <input type="text" class="form-control" id="teacher_subjects" placeholder="e.g., Math, Physics">
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-plus-circle me-1"></i>Add Teacher
                                </button>
                            </form>
                            <div id="add-teacher-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Assign Teacher to Class -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-link me-2"></i>Assign Teacher to Class</h5>
                        </div>
                        <div class="card-body">
                            <form id="assign-teacher-form">
                                <div class="mb-3">
                                    <label class="form-label">Teacher *</label>
                                    <select class="form-select" id="assign_teacher_id" required>
                                        <option value="">Select teacher...</option>
                                        {% for t in teachers %}
                                        <option value="{{ t.teacher_id }}">{{ t.name }} ({{ t.teacher_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Class *</label>
                                    <select class="form-select" id="assign_class_id" required>
                                        <option value="">Select class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-link me-1"></i>Assign Teacher
                                </button>
                            </form>
                            <div id="assign-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Unassign Teacher from Class -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Unassign Teacher from Class</h5>
                        </div>
                        <div class="card-body">
                            <form id="unassign-teacher-form">
                                <div class="mb-3">
                                    <label class="form-label">Teacher *</label>
                                    <select class="form-select" id="unassign_teacher_id" required>
                                        <option value="">Select teacher...</option>
                                        {% for t in teachers %}
                                        <option value="{{ t.teacher_id }}">{{ t.name }} ({{ t.teacher_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Class *</label>
                                    <select class="form-select" id="unassign_class_id" required>
                                        <option value="">Select class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-x-circle me-1"></i>Unassign Teacher
                                </button>
                            </form>
                            <div id="unassign-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Manage Teachers -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-person-workspace me-2"></i>Manage Teachers</h5>
                            <button class="btn btn-outline-danger btn-sm" id="delete-selected-teachers" disabled>
                                <i class="bi bi-trash me-1"></i>Delete Selected
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="teachers-table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="select-all-teachers"></th>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Subjects</th>
                                            <th>Telegram</th>
                                            <th>Students</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for t in teachers %}
                                        <tr data-id="{{ t.teacher_id }}">
                                            <td><input type="checkbox" class="teacher-checkbox" value="{{ t.teacher_id }}"></td>
                                            <td><code>{{ t.teacher_id }}</code></td>
                                            <td>{{ t.name }}</td>
                                            <td>{{ t.subjects | join(', ') if t.subjects else '-' }}</td>
                                            <td>
                                                {% if t.telegram_id %}
                                                <span class="badge bg-success"><i class="bi bi-check"></i></span>
                                                {% else %}
                                                <span class="badge bg-secondary">-</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ t.student_count or 0 }}</td>
                                            <td>
                                                <button class="btn btn-outline-primary btn-sm edit-teacher-btn me-1" 
                                                        data-teacher-id="{{ t.teacher_id }}" 
                                                        data-teacher-name="{{ t.name }}"
                                                        data-teacher-subjects="{{ t.subjects | join(', ') if t.subjects else '' }}"
                                                        data-teacher-classes="{{ t.classes | join(', ') if t.classes else '' }}"
                                                        title="Edit Teacher">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm reset-teacher-pwd-btn" 
                                                        data-teacher-id="{{ t.teacher_id }}" data-teacher-name="{{ t.name }}"
                                                        title="Reset Password">
                                                    <i class="bi bi-key"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Classes Tab -->
        <div class="tab-pane fade show active" id="classes" role="tabpanel">
            <div class="row g-4">
                <!-- Add Class -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-collection me-2"></i>Add Class</h5>
                        </div>
                        <div class="card-body">
                            <form id="add-class-form">
                                <div class="mb-3">
                                    <label class="form-label">Class ID *</label>
                                    <input type="text" class="form-control" id="class_id" placeholder="e.g., SEC1, 10A" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Level <small class="text-muted">(optional)</small></label>
                                    <input type="text" class="form-control" id="class_name" placeholder="e.g., Secondary 1, Year 10">
                                </div>
                                <button type="submit" class="btn btn-info">
                                    <i class="bi bi-plus-circle me-1"></i>Add Class
                                </button>
                            </form>
                            <div id="add-class-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Assign Students to Class by Name -->
                <div class="col-lg-8">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Assign Students to Class by Name</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Select Class *</label>
                                    <select class="form-select" id="bulk_assign_class_id" required>
                                        <option value="">Choose a class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted d-block mt-2">Paste names from Excel. Each line = one student.</small>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Paste Student Names (one name per line)</label>
                                    <textarea class="form-control" id="bulk_assign_names" rows="4" placeholder="John Doe&#10;Jane Smith&#10;Ahmad bin Ali&#10;..."></textarea>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-success" id="preview-bulk-assign-btn">
                                    <i class="bi bi-search me-1"></i>Preview & Match Students
                                </button>
                            </div>
                            
                            <!-- Preview Results -->
                            <div id="bulk-assign-preview" class="mt-4" style="display: none;">
                                <hr>
                                <div class="row">
                                    <!-- Found Students -->
                                    <div class="col-md-6">
                                        <h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Found Students (<span id="found-count">0</span>)</h6>
                                        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-success sticky-top">
                                                    <tr>
                                                        <th><input type="checkbox" id="select-all-found" checked></th>
                                                        <th>Name</th>
                                                        <th>Student ID</th>
                                                        <th>Current Class</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="found-students-tbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <!-- Not Found Students -->
                                    <div class="col-md-6">
                                        <h6 class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Not Found (<span id="notfound-count">0</span>)</h6>
                                        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                            <table class="table table-sm">
                                                <thead class="table-warning sticky-top">
                                                    <tr>
                                                        <th>Name Entered</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="notfound-students-tbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="confirm-bulk-assign-btn" disabled>
                                        <i class="bi bi-check2-all me-1"></i>Assign <span id="assign-count">0</span> Students to Class
                                    </button>
                                    <button class="btn btn-outline-secondary ms-2" id="cancel-bulk-assign-btn">Cancel</button>
                                </div>
                            </div>
                            <div id="bulk-assign-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Manage Classes -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-list me-2"></i>Manage Classes</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                                {% for c in classes %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ c.class_id }}</strong>
                                        {% if c.name and c.name != c.class_id %}
                                        <small class="text-muted d-block">Level: {{ c.name }}</small>
                                        {% endif %}
                                        <small class="text-primary d-block">{{ c.student_count or 0 }} students</small>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary download-class-pdf-btn" 
                                                data-class-id="{{ c.class_id }}"
                                                title="Download Student List PDF">
                                            <i class="bi bi-file-pdf"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger delete-class-btn" 
                                                data-class-id="{{ c.class_id }}"
                                                data-student-count="{{ c.student_count or 0 }}"
                                                title="Delete Class">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% else %}
                                <div class="list-group-item text-muted text-center">No classes yet</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learning Modules Access Tab -->
        <div class="tab-pane fade" id="module-access" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-journal-bookmark me-2"></i>Learning Module Access</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Choose which <strong>teachers</strong> can create and manage learning modules, and which <strong>classes</strong> can see and use "My Learning". All other teachers and students will not see the Modules / My Learning features.
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-2">Teachers allowed to use Modules</h6>
                            <div class="border rounded p-3 mb-3" style="max-height: 280px; overflow-y: auto;">
                                {% for t in teachers %}
                                <div class="form-check">
                                    <input class="form-check-input module-access-teacher" type="checkbox" value="{{ t.teacher_id }}" id="ma-t-{{ t.teacher_id }}"
                                        {% if t.teacher_id in module_access_teacher_ids %}checked{% endif %}>
                                    <label class="form-check-label" for="ma-t-{{ t.teacher_id }}">{{ t.name }} ({{ t.teacher_id }})</label>
                                </div>
                                {% else %}
                                <p class="text-muted small mb-0">No teachers yet</p>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-2">Classes allowed to use My Learning</h6>
                            <div class="border rounded p-3 mb-3" style="max-height: 280px; overflow-y: auto;">
                                {% for c in classes %}
                                <div class="form-check">
                                    <input class="form-check-input module-access-class" type="checkbox" value="{{ c.class_id }}" id="ma-c-{{ c.class_id }}"
                                        {% if c.class_id in module_access_class_ids %}checked{% endif %}>
                                    <label class="form-check-label" for="ma-c-{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %} â€” {{ c.student_count or 0 }} students</label>
                                </div>
                                {% else %}
                                <p class="text-muted small mb-0">No classes yet</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="save-module-access-btn">
                        <i class="bi bi-check2-circle me-1"></i>Save access
                    </button>
                    <span id="module-access-status" class="ms-3 text-muted small"></span>
                </div>
            </div>
        </div>

        <!-- Teaching Groups Tab -->
        <div class="tab-pane fade" id="teaching-groups" role="tabpanel">
            <div class="row g-4">
                <!-- Create Teaching Group -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Create Teaching Group</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Teaching groups allow you to assign a subset of students from a class to a specific teacher.
                            </p>
                            <form id="create-teaching-group-form">
                                <div class="mb-3">
                                    <label class="form-label">Group Name *</label>
                                    <input type="text" class="form-control" id="tg_name" placeholder="e.g., 3I4 Chemistry Group A" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Select Class *</label>
                                    <select class="form-select" id="tg_class_id" required>
                                        <option value="">Select a class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Assign to Teacher *</label>
                                    <select class="form-select" id="tg_teacher_id" required>
                                        <option value="">Select a teacher...</option>
                                        {% for t in teachers %}
                                        <option value="{{ t.teacher_id }}">{{ t.name }} ({{ t.teacher_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Select Students *</label>
                                    <div id="tg-students-container" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                                        <p class="text-muted small mb-0">Select a class first to see students</p>
                                    </div>
                                    <small class="text-muted">Students from the selected class will appear here</small>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i>Create Teaching Group
                                </button>
                            </form>
                            <div id="create-tg-result" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Manage Teaching Groups -->
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Manage Teaching Groups</h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadTeachingGroups()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Group Name</th>
                                            <th>Class</th>
                                            <th>Teacher</th>
                                            <th>Students</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teaching-groups-tbody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="bi bi-hourglass me-2"></i>Loading teaching groups...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Students to Teaching Group by Name -->
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Add Students to Teaching Group by Name</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Select Teaching Group *</label>
                                    <select class="form-select" id="tg_bulk_assign_group_id">
                                        <option value="">Choose a teaching group...</option>
                                    </select>
                                    <small class="text-muted d-block mt-2">Paste names from Excel. Each line = one student.</small>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Paste Student Names (one name per line)</label>
                                    <textarea class="form-control" id="tg_bulk_assign_names" rows="4" placeholder="John Doe&#10;Jane Smith&#10;Ahmad bin Ali&#10;..."></textarea>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-info" id="preview-tg-bulk-assign-btn">
                                    <i class="bi bi-search me-1"></i>Preview & Match Students
                                </button>
                            </div>
                            
                            <!-- Preview Results -->
                            <div id="tg-bulk-assign-preview" class="mt-4" style="display: none;">
                                <hr>
                                <div class="row">
                                    <!-- Found Students -->
                                    <div class="col-md-6">
                                        <h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Found Students (<span id="tg-found-count">0</span>)</h6>
                                        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-success sticky-top">
                                                    <tr>
                                                        <th><input type="checkbox" id="tg-select-all-found" checked></th>
                                                        <th>Name</th>
                                                        <th>Student ID</th>
                                                        <th>Class</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tg-found-students-tbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <!-- Not Found Students -->
                                    <div class="col-md-6">
                                        <h6 class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Not Found (<span id="tg-notfound-count">0</span>)</h6>
                                        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                            <table class="table table-sm">
                                                <thead class="table-warning sticky-top">
                                                    <tr>
                                                        <th>Name Entered</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tg-notfound-students-tbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="confirm-tg-bulk-assign-btn" disabled>
                                        <i class="bi bi-check2-all me-1"></i>Add <span id="tg-assign-count">0</span> Students to Group
                                    </button>
                                    <button class="btn btn-outline-secondary ms-2" id="cancel-tg-bulk-assign-btn">Cancel</button>
                                </div>
                            </div>
                            <div id="tg-bulk-assign-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Prompts Tab -->
        <div class="tab-pane fade" id="prompts" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Help Prompts</h5>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" id="reset-prompts-btn">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset to Defaults
                                </button>
                                <button class="btn btn-success btn-sm" id="save-prompts-btn">
                                    <i class="bi bi-save me-1"></i>Save All Changes
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-4">
                                Configure the AI prompts used when students request help with questions. 
                                Use <code>{subject}</code>, <code>{assignment_title}</code>, <code>{question}</code>, 
                                <code>{student_answer}</code>, and <code>{answer_context}</code> as placeholders.
                            </p>
                            
                            <div id="prompts-loading" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="text-muted mt-2">Loading prompts...</p>
                            </div>
                            
                            <div id="prompts-container" style="display: none;">
                                <!-- Prompts will be loaded here -->
                            </div>
                            
                            <div id="prompts-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports & Tools Tab -->
        <div class="tab-pane fade" id="reports" role="tabpanel">
            <div class="row g-4">
                <!-- Generate Reports by Teacher -->
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Generate Reports by Teacher</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Select a teacher to see their assigned classes and teaching groups, then generate PDF student lists.
                            </p>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Select Teacher</label>
                                    <select class="form-select" id="teacher_report_select">
                                        <option value="">Choose a teacher...</option>
                                        {% for t in teachers %}
                                        <option value="{{ t.teacher_id }}">{{ t.name }} ({{ t.teacher_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <div id="teacher-report-content" class="mt-3 mt-md-0">
                                        <div class="text-muted text-center py-4">
                                            <i class="bi bi-arrow-left me-2"></i>Select a teacher to view their classes and groups
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Class Student List PDF -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-pdf me-2"></i>Generate Class Student List</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Generate a PDF with student IDs and names for a class. No passwords included - safe to share with students.
                            </p>
                            <form id="class-report-form">
                                <div class="mb-3">
                                    <label class="form-label">Select Class *</label>
                                    <select class="form-select" id="report_class_id" required>
                                        <option value="">Choose a class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %} - {{ c.student_count or 0 }} students</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Teacher (optional)</label>
                                    <select class="form-select" id="report_teacher_id">
                                        <option value="">No teacher specified</option>
                                        {% for t in teachers %}
                                        <option value="{{ t.teacher_id }}">{{ t.name }} ({{ t.teacher_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-download me-1"></i>Download PDF
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Teaching Group Student List PDF -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Generate Teaching Group List</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Generate a PDF with student IDs and names for a teaching group.
                            </p>
                            <form id="tg-report-form">
                                <div class="mb-3">
                                    <label class="form-label">Select Teaching Group *</label>
                                    <select class="form-select" id="report_tg_id" required>
                                        <option value="">Loading teaching groups...</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-download me-1"></i>Download PDF
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Convert Class to Teaching Group -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Convert Class to Teaching Group</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Create a teaching group from all students in a class. The original class remains unchanged.
                            </p>
                            <form id="convert-class-form">
                                <div class="mb-3">
                                    <label class="form-label">Select Class *</label>
                                    <select class="form-select" id="convert_class_id" required>
                                        <option value="">Choose a class...</option>
                                        {% for c in classes %}
                                        <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %} - {{ c.student_count or 0 }} students</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Assign to Teacher *</label>
                                    <select class="form-select" id="convert_teacher_id" required>
                                        <option value="">Select a teacher...</option>
                                        {% for t in teachers %}
                                        <option value="{{ t.teacher_id }}">{{ t.name }} ({{ t.teacher_id }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Group Name (optional)</label>
                                    <input type="text" class="form-control" id="convert_group_name" placeholder="Auto-generated if empty">
                                </div>
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-arrow-repeat me-1"></i>Create Teaching Group
                                </button>
                            </form>
                            <div id="convert-class-result" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Students Detection -->
                <div class="col-lg-6">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Duplicate Student Detection</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Find students with the same name who may have been imported multiple times with different IDs.
                            </p>
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-outline-warning" id="scan-duplicates-btn">
                                    <i class="bi bi-search me-1"></i>Scan for Duplicates
                                </button>
                                <button class="btn btn-outline-secondary" id="download-duplicates-report-btn" disabled>
                                    <i class="bi bi-file-pdf me-1"></i>Download Report
                                </button>
                            </div>
                            <div id="duplicates-result" style="display: none;">
                                <div class="alert alert-info mb-3">
                                    <strong id="duplicates-count">0</strong> duplicate name groups found
                                </div>
                                <div id="duplicates-list" class="border rounded" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Duplicates will be listed here -->
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-danger" id="resolve-duplicates-btn" disabled>
                                        <i class="bi bi-check2-all me-1"></i>Resolve All Duplicates (Keep Oldest IDs)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import with Reconciliation Info -->
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Smart Import with Duplicate Prevention</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                When importing students, use <strong>"Import with Reconciliation"</strong> in the Students tab to automatically:
                            </p>
                            <ul class="mb-0">
                                <li>Detect if a student with the same name already exists</li>
                                <li>Use the existing (older) student ID instead of creating a duplicate</li>
                                <li>Merge class assignments and teacher associations</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="delete-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="delete-message">Are you sure you want to delete the selected items?</p>
                <p class="text-danger mb-0"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="reset-password-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-key me-2"></i>Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reset-password-body">
                <!-- Content will be set dynamically -->
            </div>
            <div class="modal-footer" id="reset-password-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-reset-btn">Reset Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Teacher Modal -->
<div class="modal fade" id="edit-teacher-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Teacher</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-teacher-form">
                    <input type="hidden" id="edit-teacher-id">
                    <div class="mb-3">
                        <label class="form-label">Teacher ID</label>
                        <input type="text" class="form-control" id="edit-teacher-id-display" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="edit-teacher-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subjects (comma-separated)</label>
                        <input type="text" class="form-control" id="edit-teacher-subjects" placeholder="e.g., Math, Physics">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Classes (comma-separated)</label>
                        <input type="text" class="form-control" id="edit-teacher-classes" placeholder="e.g., S3C1, S3I4">
                        <small class="text-muted">Enter class IDs the teacher should teach, separated by commas</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-teacher-btn">
                    <i class="bi bi-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mass Reset Password Modal -->
<div class="modal fade" id="mass-reset-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-key me-2"></i>Reset Student Passwords</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="reset-count-text" class="text-muted">0 students selected</p>
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input type="text" class="form-control" id="mass-reset-password" placeholder="Leave blank for 'student123'">
                    <small class="text-muted">Default: student123</small>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    This will reset passwords for all selected students.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-mass-reset">
                    <i class="bi bi-key me-1"></i>Reset Passwords
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="edit-student-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Student</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-student-form">
                    <input type="hidden" id="edit-student-id">
                    <div class="mb-3">
                        <label class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="edit-student-id-display" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="edit-student-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Class</label>
                        <select class="form-select" id="edit-student-class">
                            <option value="">No class</option>
                            {% for c in classes %}
                            <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teachers (semicolon-separated IDs)</label>
                        <input type="text" class="form-control" id="edit-student-teachers" placeholder="e.g., T001;T002">
                        <small class="text-muted">Enter teacher IDs separated by semicolons</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-student-btn">
                    <i class="bi bi-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Spreadsheet styling */
.spreadsheet-wrapper {
    max-height: 350px;
    overflow-y: auto;
    border: 2px solid #dee2e6;
    border-radius: 8px;
}

.spreadsheet-table {
    font-size: 0.85rem;
    margin: 0;
}

.spreadsheet-table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 4px;
    white-space: nowrap;
}

.spreadsheet-table td {
    padding: 0 !important;
    vertical-align: middle;
}

.spreadsheet-table input {
    border: none;
    border-radius: 0;
    padding: 6px 8px;
    width: 100%;
    height: 100%;
    font-size: 0.85rem;
    background: transparent;
}

.spreadsheet-table input:focus {
    background: #e8f4ff;
    outline: 2px solid #0d6efd;
    outline-offset: -2px;
}

.spreadsheet-table input::placeholder {
    color: #ccc;
    font-style: italic;
}

.spreadsheet-table tr:hover input {
    background: #f8f9fa;
}

.spreadsheet-table tr:hover input:focus {
    background: #e8f4ff;
}

.spreadsheet-table .delete-row-btn {
    border: none;
    background: none;
    color: #dc3545;
    padding: 4px 8px;
    opacity: 0.3;
    transition: opacity 0.15s;
}

.spreadsheet-table tr:hover .delete-row-btn {
    opacity: 1;
}

.spreadsheet-table .row-invalid input {
    background-color: #fff3cd;
}

.spreadsheet-table .row-valid {
    background-color: #d1e7dd;
}

.sticky-top {
    z-index: 10;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // Load students on page load
    loadStudents();

    // ================== SPREADSHEET GRID ==================
    
    const INITIAL_ROWS = 10;
    
    // Initialize spreadsheet with empty rows on page load
    document.addEventListener('DOMContentLoaded', () => {
        initSpreadsheet();
    });
    
    function initSpreadsheet() {
        const tbody = document.getElementById('spreadsheet-tbody');
        tbody.innerHTML = '';
        for (let i = 0; i < INITIAL_ROWS; i++) {
            addRowToSpreadsheet();
        }
        updateRowCount();
    }
    
    function addRowToSpreadsheet(data = {}) {
        const tbody = document.getElementById('spreadsheet-tbody');
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td><input type="text" class="cell-input" data-field="student_id" value="${escapeHtml(data.student_id || '')}" placeholder="S001"></td>
            <td><input type="text" class="cell-input" data-field="name" value="${escapeHtml(data.name || '')}" placeholder="John Doe"></td>
            <td><input type="text" class="cell-input" data-field="class" value="${escapeHtml(data.class || '')}" placeholder="10A"></td>
            <td><input type="text" class="cell-input" data-field="password" value="${escapeHtml(data.password || '')}" placeholder="student123"></td>
            <td><input type="text" class="cell-input" data-field="teachers" value="${escapeHtml(data.teachers || '')}" placeholder="T001;T002"></td>
            <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)"><i class="bi bi-x-lg"></i></button></td>
        `;
        
        // Add event listeners
        row.querySelectorAll('.cell-input').forEach(input => {
            input.addEventListener('input', updateRowCount);
            input.addEventListener('paste', handleCellPaste);
            input.addEventListener('keydown', handleCellKeydown);
        });
        
        tbody.appendChild(row);
        return row;
    }
    
    function addEmptyRow() {
        const row = addRowToSpreadsheet();
        row.querySelector('input').focus();
        updateRowCount();
    }
    
    function deleteRow(btn) {
        const row = btn.closest('tr');
        row.remove();
        
        // Ensure at least one row exists
        const tbody = document.getElementById('spreadsheet-tbody');
        if (tbody.children.length === 0) {
            addRowToSpreadsheet();
        }
        updateRowCount();
    }
    
    function clearAllRows() {
        initSpreadsheet();
    }
    
    function handleCellPaste(e) {
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedText = clipboardData.getData('text');
        
        // Check if pasting multiple lines (from Excel)
        if (pastedText.includes('\n') || pastedText.includes('\t')) {
            e.preventDefault();
            
            const lines = pastedText.split('\n').filter(line => line.trim());
            const currentRow = e.target.closest('tr');
            const tbody = document.getElementById('spreadsheet-tbody');
            const currentRowIndex = Array.from(tbody.children).indexOf(currentRow);
            
            // Parse and insert rows
            lines.forEach((line, lineIndex) => {
                // Handle both tab and comma separated
                let parts = line.includes('\t') ? line.split('\t') : line.split(',');
                parts = parts.map(p => p.trim());
                
                const rowIndex = currentRowIndex + lineIndex;
                let row = tbody.children[rowIndex];
                
                // Create new row if needed
                if (!row) {
                    row = addRowToSpreadsheet();
                }
                
                // Fill in the cells
                const inputs = row.querySelectorAll('.cell-input');
                inputs[0].value = parts[0] || '';  // student_id
                inputs[1].value = parts[1] || '';  // name
                inputs[2].value = parts[2] || '';  // class
                inputs[3].value = parts[3] || '';  // password
                inputs[4].value = parts[4] || '';  // teachers
            });
            
            // Add a few extra empty rows if needed
            const totalRows = tbody.children.length;
            const neededRows = currentRowIndex + lines.length + 3;
            for (let i = totalRows; i < neededRows; i++) {
                addRowToSpreadsheet();
            }
            
            updateRowCount();
        }
    }
    
    function handleCellKeydown(e) {
        const input = e.target;
        const row = input.closest('tr');
        const cell = input.closest('td');
        const tbody = document.getElementById('spreadsheet-tbody');
        const rows = Array.from(tbody.children);
        const rowIndex = rows.indexOf(row);
        const cells = Array.from(row.querySelectorAll('td'));
        const cellIndex = cells.indexOf(cell);
        
        if (e.key === 'Tab') {
            // Tab moves to next cell, shift+tab to previous
            const direction = e.shiftKey ? -1 : 1;
            let nextCellIndex = cellIndex + direction;
            let nextRowIndex = rowIndex;
            
            if (nextCellIndex < 0) {
                nextRowIndex--;
                nextCellIndex = 4; // Last editable column
            } else if (nextCellIndex > 4) {
                nextRowIndex++;
                nextCellIndex = 0;
                // Add new row if at the end
                if (nextRowIndex >= rows.length) {
                    addRowToSpreadsheet();
                }
            }
            
            if (nextRowIndex >= 0 && nextRowIndex < tbody.children.length) {
                e.preventDefault();
                const nextRow = tbody.children[nextRowIndex];
                const nextInput = nextRow.querySelectorAll('.cell-input')[nextCellIndex];
                if (nextInput) nextInput.focus();
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            // Move to same column in next row
            let nextRowIndex = rowIndex + 1;
            if (nextRowIndex >= rows.length) {
                addRowToSpreadsheet();
            }
            const nextRow = tbody.children[nextRowIndex];
            if (nextRow) {
                const nextInput = nextRow.querySelectorAll('.cell-input')[cellIndex];
                if (nextInput) nextInput.focus();
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (rowIndex < rows.length - 1) {
                const nextRow = rows[rowIndex + 1];
                nextRow.querySelectorAll('.cell-input')[cellIndex]?.focus();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (rowIndex > 0) {
                const prevRow = rows[rowIndex - 1];
                prevRow.querySelectorAll('.cell-input')[cellIndex]?.focus();
            }
        }
    }
    
    function getSpreadsheetData() {
        const rows = document.querySelectorAll('#spreadsheet-tbody tr');
        const students = [];
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('.cell-input');
            const student_id = inputs[0].value.trim();
            const name = inputs[1].value.trim();
            
            if (student_id && name) {
                students.push({
                    student_id: student_id,
                    name: name,
                    class: inputs[2].value.trim(),
                    password: inputs[3].value.trim() || 'student123',
                    teachers: inputs[4].value.trim() ? inputs[4].value.split(';').map(t => t.trim()).filter(t => t) : []
                });
            }
        });
        
        return students;
    }
    
    function updateRowCount() {
        const students = getSpreadsheetData();
        const count = students.length;
        document.getElementById('row-count').textContent = count;
        document.getElementById('import-count').textContent = count;
        document.getElementById('import-excel-btn').disabled = count === 0;
        
        // Highlight valid rows
        document.querySelectorAll('#spreadsheet-tbody tr').forEach(row => {
            const inputs = row.querySelectorAll('.cell-input');
            const hasId = inputs[0].value.trim();
            const hasName = inputs[1].value.trim();
            
            row.classList.remove('row-valid', 'row-invalid');
            if (hasId && hasName) {
                row.classList.add('row-valid');
            } else if (hasId || hasName) {
                row.classList.add('row-invalid');
            }
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    // Excel/Paste Import
    document.getElementById('import-excel-btn').addEventListener('click', async () => {
        const students = getSpreadsheetData();
        
        if (students.length === 0) {
            showResult('import-result', 'No valid students to import', 'warning');
            return;
        }

        await importStudents(students);
        initSpreadsheet(); // Clear after import
    });

    // CSV Import
    document.getElementById('import-csv-btn').addEventListener('click', async () => {
        const fileInput = document.getElementById('csv-file');
        const file = fileInput.files[0];
        
        if (!file) {
            showResult('import-result', 'Please select a CSV file', 'warning');
            return;
        }

        const text = await file.text();
        const lines = text.split('\n');
        const students = [];
        
        // Skip header row
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const parts = line.split(',').map(p => p.trim().replace(/^["']|["']$/g, ''));
            if (parts.length >= 3) {
                students.push({
                    student_id: parts[0],
                    name: parts[1],
                    class: parts[2],
                    password: parts[3] || 'student123',
                    teachers: parts[4] ? parts[4].split(';').map(t => t.trim()) : []
                });
            }
        }

        if (students.length === 0) {
            showResult('import-result', 'No valid student data found in CSV', 'warning');
            return;
        }

        await importStudents(students);
    });

    // Download CSV Template
    document.getElementById('download-template').addEventListener('click', (e) => {
        e.preventDefault();
        const csv = 'student_id,name,class,password,teachers\nS001,John Doe,10A,student123,T001\nS002,Jane Smith,10A,student123,T001;T002';
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'students_template.csv';
        a.click();
    });

    async function importStudents(students) {
        try {
            const response = await fetch('/admin/import_students', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ students })
            });
            const data = await response.json();
            
            if (data.success) {
                showResult('import-result', `Imported ${data.imported} students` + 
                    (data.errors.length ? `. Errors: ${data.errors.join(', ')}` : ''), 
                    data.errors.length ? 'warning' : 'success');
                loadStudents();
            } else {
                showResult('import-result', data.error, 'danger');
            }
        } catch (e) {
            showResult('import-result', 'Import failed', 'danger');
        }
    }

    // ================== STUDENT MANAGEMENT ==================

    async function loadStudents() {
        try {
            const response = await fetch('/admin/api/students');
            const data = await response.json();
            
            const tbody = document.getElementById('students-tbody');
            if (data.students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No students found</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.students.map(s => `
                <tr data-id="${s.student_id}">
                    <td><input type="checkbox" class="student-checkbox" value="${s.student_id}"></td>
                    <td>${s.name}<br><small class="text-muted">${s.student_id}</small></td>
                    <td>${s.class || '-'}</td>
                    <td>${(s.teachers || []).join(', ') || '-'}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm edit-student-btn me-1" 
                                data-student-id="${s.student_id}" 
                                data-student-name="${s.name}"
                                data-student-class="${s.class || ''}"
                                data-student-teachers="${(s.teachers || []).join(';')}"
                                title="Edit Student">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm reset-pwd-btn" 
                                data-student-id="${s.student_id}" data-student-name="${s.name}"
                                title="Reset Password">
                            <i class="bi bi-key"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            attachResetPasswordListeners();
            attachEditStudentListeners();
            updateDeleteButtons();
        } catch (e) {
            console.error('Failed to load students:', e);
        }
    }

    // Filter by class
    document.getElementById('filter-class').addEventListener('change', async (e) => {
        const classId = e.target.value;
        // Disable delete class button for unassigned filter or no selection
        document.getElementById('delete-by-class').disabled = !classId || classId === '__unassigned__';
        
        try {
            let url = '/admin/api/students';
            if (classId === '__unassigned__') {
                url = '/admin/api/students?class=__unassigned__';
            } else if (classId) {
                url = `/admin/api/students?class=${classId}`;
            }
            const response = await fetch(url);
            const data = await response.json();
            
            const tbody = document.getElementById('students-tbody');
            if (data.students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No students found</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.students.map(s => `
                <tr data-id="${s.student_id}">
                    <td><input type="checkbox" class="student-checkbox" value="${s.student_id}"></td>
                    <td>${s.name}<br><small class="text-muted">${s.student_id}</small></td>
                    <td>${s.class || '-'}</td>
                    <td>${(s.teachers || []).join(', ') || '-'}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm edit-student-btn me-1" 
                                data-student-id="${s.student_id}" 
                                data-student-name="${s.name}"
                                data-student-class="${s.class || ''}"
                                data-student-teachers="${(s.teachers || []).join(';')}"
                                title="Edit Student">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm reset-pwd-btn" 
                                data-student-id="${s.student_id}" data-student-name="${s.name}"
                                title="Reset Password">
                            <i class="bi bi-key"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            attachResetPasswordListeners();
            attachEditStudentListeners();
        } catch (e) {
            console.error('Failed to filter students:', e);
        }
    });

    // Select all students
    document.getElementById('select-all-students').addEventListener('change', (e) => {
        document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = e.target.checked);
        updateSelectionUI();
    });

    document.getElementById('students-tbody').addEventListener('change', updateSelectionUI);

    function updateSelectionUI() {
        const selectedStudents = document.querySelectorAll('.student-checkbox:checked').length;
        document.getElementById('delete-selected-students').disabled = selectedStudents === 0;
        document.getElementById('reset-selected-passwords').disabled = selectedStudents === 0;
        
        // Update mass reset modal count
        document.getElementById('reset-count-text').textContent = `${selectedStudents} student(s) selected`;
        
        // Show/hide assign class section
        const assignSection = document.getElementById('assign-class-section');
        if (selectedStudents > 0) {
            assignSection.style.display = 'flex';
            document.getElementById('selected-count').textContent = selectedStudents;
        } else {
            assignSection.style.display = 'none';
        }
        
        // Update assign button state
        updateAssignButton();
        
        const selectedTeachers = document.querySelectorAll('.teacher-checkbox:checked').length;
        document.getElementById('delete-selected-teachers').disabled = selectedTeachers === 0;
    }
    
    // Assign to class functionality
    document.getElementById('assign-to-class').addEventListener('change', updateAssignButton);
    
    function updateAssignButton() {
        const selectedStudents = document.querySelectorAll('.student-checkbox:checked').length;
        const selectedClass = document.getElementById('assign-to-class').value;
        document.getElementById('assign-class-btn').disabled = selectedStudents === 0 || !selectedClass;
    }
    
    document.getElementById('assign-class-btn').addEventListener('click', async () => {
        const selectedIds = [...document.querySelectorAll('.student-checkbox:checked')].map(cb => cb.value);
        const classId = document.getElementById('assign-to-class').value;
        
        if (selectedIds.length === 0 || !classId) return;
        
        try {
            const response = await fetch('/admin/assign_students_to_class', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_ids: selectedIds, class_id: classId })
            });
            const data = await response.json();
            
            if (data.success) {
                // Show success message
                alert(`âœ… ${data.updated} student(s) assigned to class "${classId}"`);
                // Refresh student list
                loadStudents();
                // Reset selection
                document.getElementById('select-all-students').checked = false;
                document.getElementById('assign-to-class').value = '';
                updateSelectionUI();
            } else {
                alert('âŒ ' + (data.error || 'Failed to assign students'));
            }
        } catch (e) {
            alert('âŒ Failed to assign students');
            console.error(e);
        }
    });

    // Delete selected students
    let deleteAction = null;
    const deleteModal = new bootstrap.Modal(document.getElementById('delete-modal'));

    document.getElementById('delete-selected-students').addEventListener('click', () => {
        const selected = [...document.querySelectorAll('.student-checkbox:checked')].map(cb => cb.value);
        if (selected.length === 0) return;
        
        document.getElementById('delete-message').textContent = `Delete ${selected.length} selected student(s)?`;
        deleteAction = { type: 'students', ids: selected };
        deleteModal.show();
    });

    document.getElementById('delete-by-class').addEventListener('click', () => {
        const classId = document.getElementById('filter-class').value;
        if (!classId) return;
        
        document.getElementById('delete-message').textContent = `Delete ALL students in class "${classId}"?`;
        deleteAction = { type: 'students-class', class: classId };
        deleteModal.show();
    });

    // Mass reset student passwords
    document.getElementById('confirm-mass-reset').addEventListener('click', async () => {
        const selected = [...document.querySelectorAll('.student-checkbox:checked')].map(cb => cb.value);
        if (selected.length === 0) return;
        
        const customPassword = document.getElementById('mass-reset-password').value.trim();
        
        try {
            const response = await fetch('/admin/mass_reset_student_passwords', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    student_ids: selected,
                    password: customPassword
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('mass-reset-modal')).hide();
                alert(`Successfully reset ${data.count} password(s) to: ${data.password}`);
                document.getElementById('mass-reset-password').value = '';
            } else {
                alert(data.error || 'Failed to reset passwords');
            }
        } catch (e) {
            console.error('Mass reset failed:', e);
            alert('Failed to reset passwords');
        }
    });

    // ================== TEACHER MANAGEMENT ==================

    document.getElementById('select-all-teachers').addEventListener('change', (e) => {
        document.querySelectorAll('.teacher-checkbox').forEach(cb => cb.checked = e.target.checked);
        updateDeleteButtons();
    });

    document.querySelectorAll('.teacher-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectionUI);
    });

    document.getElementById('delete-selected-teachers').addEventListener('click', () => {
        const selected = [...document.querySelectorAll('.teacher-checkbox:checked')].map(cb => cb.value);
        if (selected.length === 0) return;
        
        document.getElementById('delete-message').innerHTML = `Delete ${selected.length} selected teacher(s)?<br><br><small class="text-muted">This will also:<br>â€¢ Remove Telegram associations (can be reused)<br>â€¢ Delete all their assignments and submissions<br>â€¢ Remove them from students</small>`;
        deleteAction = { type: 'teachers', ids: selected };
        deleteModal.show();
    });

    // ================== CLASS MANAGEMENT ==================
    
    // Download class student list PDF
    document.querySelectorAll('.download-class-pdf-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const classId = btn.dataset.classId;
            window.open(`/admin/api/class-report/${classId}/pdf`, '_blank');
        });
    });
    
    // ================== BULK ASSIGN STUDENTS TO CLASS ==================
    
    let matchedStudents = [];
    
    document.getElementById('preview-bulk-assign-btn').addEventListener('click', async () => {
        const classId = document.getElementById('bulk_assign_class_id').value;
        const namesText = document.getElementById('bulk_assign_names').value.trim();
        
        if (!classId) {
            alert('Please select a class first');
            return;
        }
        
        if (!namesText) {
            alert('Please enter student names');
            return;
        }
        
        // Parse names (split by newlines only - each line is one complete name)
        const names = namesText.split(/\n/).map(n => n.trim()).filter(n => n);
        
        if (names.length === 0) {
            alert('No valid names found');
            return;
        }
        
        const btn = document.getElementById('preview-bulk-assign-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Matching...';
        
        try {
            const response = await fetch('/admin/api/match-students-by-name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ names })
            });
            const data = await response.json();
            
            if (!data.success) {
                alert(data.error || 'Error matching students');
                return;
            }
            
            matchedStudents = data.found;
            displayMatchResults(data.found, data.not_found);
            document.getElementById('bulk-assign-preview').style.display = 'block';
            
        } catch (e) {
            alert('Error matching students');
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search me-1"></i>Preview & Match Students';
        }
    });
    
    function displayMatchResults(found, notFound) {
        // Found students table
        const foundTbody = document.getElementById('found-students-tbody');
        document.getElementById('found-count').textContent = found.length;
        
        if (found.length === 0) {
            foundTbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No matching students found</td></tr>';
        } else {
            foundTbody.innerHTML = found.map(s => `
                <tr>
                    <td><input type="checkbox" class="found-student-cb" value="${s.student_id}" checked></td>
                    <td>
                        ${escapeHtml(s.name)}
                        ${s.partial_match ? '<span class="badge bg-info ms-1" title="Partial match">~</span>' : ''}
                        ${s.input_name.toLowerCase() !== s.name.toLowerCase() ? `<br><small class="text-muted">Input: ${escapeHtml(s.input_name)}</small>` : ''}
                    </td>
                    <td><code>${s.student_id}</code></td>
                    <td>${s.class || '<span class="text-muted">-</span>'}</td>
                </tr>
            `).join('');
        }
        
        // Not found table
        const notFoundTbody = document.getElementById('notfound-students-tbody');
        document.getElementById('notfound-count').textContent = notFound.length;
        
        if (notFound.length === 0) {
            notFoundTbody.innerHTML = '<tr><td colspan="2" class="text-success text-center">All students found!</td></tr>';
        } else {
            notFoundTbody.innerHTML = notFound.map(s => `
                <tr>
                    <td>${escapeHtml(s.input_name)}</td>
                    <td><span class="badge bg-warning text-dark">Not in system</span></td>
                </tr>
            `).join('');
        }
        
        // Update assign button
        updateBulkAssignButton();
        
        // Select all handler
        document.getElementById('select-all-found').addEventListener('change', (e) => {
            document.querySelectorAll('.found-student-cb').forEach(cb => cb.checked = e.target.checked);
            updateBulkAssignButton();
        });
        
        // Individual checkbox handlers
        document.querySelectorAll('.found-student-cb').forEach(cb => {
            cb.addEventListener('change', updateBulkAssignButton);
        });
    }
    
    function updateBulkAssignButton() {
        const selectedCount = document.querySelectorAll('.found-student-cb:checked').length;
        document.getElementById('assign-count').textContent = selectedCount;
        document.getElementById('confirm-bulk-assign-btn').disabled = selectedCount === 0;
    }
    
    document.getElementById('confirm-bulk-assign-btn').addEventListener('click', async () => {
        const classId = document.getElementById('bulk_assign_class_id').value;
        const selectedIds = [...document.querySelectorAll('.found-student-cb:checked')].map(cb => cb.value);
        
        if (!classId || selectedIds.length === 0) return;
        
        const btn = document.getElementById('confirm-bulk-assign-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Assigning...';
        
        try {
            const response = await fetch('/admin/api/bulk-assign-class', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_ids: selectedIds, class_id: classId })
            });
            const data = await response.json();
            
            if (data.success) {
                showResult('bulk-assign-result', `Successfully assigned ${data.updated} students to class "${classId}"`, 'success');
                // Reset form
                document.getElementById('bulk_assign_names').value = '';
                document.getElementById('bulk-assign-preview').style.display = 'none';
                matchedStudents = [];
                // Refresh page to update class counts
                setTimeout(() => location.reload(), 1500);
            } else {
                showResult('bulk-assign-result', data.error || 'Failed to assign students', 'danger');
            }
        } catch (e) {
            showResult('bulk-assign-result', 'Error assigning students', 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check2-all me-1"></i>Assign <span id="assign-count">' + selectedIds.length + '</span> Students to Class';
        }
    });
    
    document.getElementById('cancel-bulk-assign-btn').addEventListener('click', () => {
        document.getElementById('bulk-assign-preview').style.display = 'none';
        document.getElementById('bulk-assign-result').style.display = 'none';
        matchedStudents = [];
    });
    
    document.querySelectorAll('.delete-class-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const classId = btn.dataset.classId;
            const studentCount = parseInt(btn.dataset.studentCount) || 0;
            
            let message = `Delete class "${classId}"?`;
            if (studentCount > 0) {
                message += `\n\nWarning: This class has ${studentCount} student(s). They will NOT be deleted, but will no longer be assigned to this class.`;
            }
            
            document.getElementById('delete-message').innerHTML = message.replace('\n\n', '<br><br>');
            deleteAction = { type: 'class', class_id: classId };
            deleteModal.show();
        });
    });

    // Confirm delete
    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        if (!deleteAction) return;
        
        try {
            let response;
            if (deleteAction.type === 'students') {
                response = await fetch('/admin/delete_students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_ids: deleteAction.ids })
                });
            } else if (deleteAction.type === 'students-class') {
                response = await fetch('/admin/delete_students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: deleteAction.class })
                });
            } else if (deleteAction.type === 'teachers') {
                response = await fetch('/admin/delete_teachers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teacher_ids: deleteAction.ids })
                });
            } else if (deleteAction.type === 'class') {
                response = await fetch('/admin/delete_class', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: deleteAction.class_id })
                });
            }
            
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Delete failed');
            }
        } catch (e) {
            alert('Delete failed');
        }
        
        deleteModal.hide();
    });

    // ================== PASSWORD RESET ==================
    
    const resetPasswordModal = new bootstrap.Modal(document.getElementById('reset-password-modal'));
    let resetStudentId = null;
    
    function attachResetPasswordListeners() {
        document.querySelectorAll('.reset-pwd-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                resetStudentId = btn.dataset.studentId;
                const studentName = btn.dataset.studentName;
                
                document.getElementById('reset-password-body').innerHTML = `
                    <p>Reset password for student:</p>
                    <p><strong>${studentName}</strong> (<code>${resetStudentId}</code>)</p>
                    <p class="text-muted small mb-0">The password will be reset to the student ID: <code>${resetStudentId}</code></p>
                `;
                document.getElementById('reset-password-footer').innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirm-reset-btn">Reset Password</button>
                `;
                
                // Re-attach the confirm button handler
                document.getElementById('confirm-reset-btn').addEventListener('click', confirmResetPassword);
                
                resetPasswordModal.show();
            });
        });
    }
    
    async function confirmResetPassword() {
        if (!resetStudentId) return;
        
        try {
            const response = await fetch('/admin/reset_student_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: resetStudentId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('reset-password-body').innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Password Reset Successful!</h5>
                        <p>New password for <strong>${resetStudentId}</strong>:</p>
                        <div class="alert alert-warning">
                            <code style="font-size: 1.2rem; user-select: all;">${data.new_password}</code>
                        </div>
                        <p class="text-muted small">Please share this password with the student securely.</p>
                    </div>
                `;
                document.getElementById('reset-password-footer').innerHTML = `
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
                `;
            } else {
                alert(data.error || 'Password reset failed');
            }
        } catch (e) {
            console.error('Password reset failed:', e);
            alert('Password reset failed');
        }
    }
    
    // Teacher password reset
    let resetTeacherId = null;
    
    document.querySelectorAll('.reset-teacher-pwd-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            resetTeacherId = btn.dataset.teacherId;
            const teacherName = btn.dataset.teacherName;
            
            document.getElementById('reset-password-body').innerHTML = `
                <p>Reset password for teacher:</p>
                <p><strong>${teacherName}</strong> (<code>${resetTeacherId}</code>)</p>
                <p class="text-muted small mb-0">The password will be reset to the teacher ID: <code>${resetTeacherId}</code></p>
            `;
            document.getElementById('reset-password-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-reset-teacher-btn">Reset Password</button>
            `;
            
            document.getElementById('confirm-reset-teacher-btn').addEventListener('click', confirmResetTeacherPassword);
            resetPasswordModal.show();
        });
    });
    
    async function confirmResetTeacherPassword() {
        if (!resetTeacherId) return;
        
        try {
            const response = await fetch('/admin/reset_teacher_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ teacher_id: resetTeacherId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('reset-password-body').innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Password Reset Successful!</h5>
                        <p>New password for <strong>${resetTeacherId}</strong>:</p>
                        <div class="alert alert-warning">
                            <code style="font-size: 1.2rem; user-select: all;">${data.new_password}</code>
                        </div>
                        <p class="text-muted small">Please share this password with the teacher securely.</p>
                    </div>
                `;
                document.getElementById('reset-password-footer').innerHTML = `
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
                `;
            } else {
                alert(data.error || 'Password reset failed');
            }
        } catch (e) {
            console.error('Password reset failed:', e);
            alert('Password reset failed');
        }
    }
    
    // ================== EDIT TEACHER ==================
    
    const editTeacherModal = new bootstrap.Modal(document.getElementById('edit-teacher-modal'));
    
    document.querySelectorAll('.edit-teacher-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const teacherId = btn.dataset.teacherId;
            const teacherName = btn.dataset.teacherName;
            const teacherSubjects = btn.dataset.teacherSubjects;
            const teacherClasses = btn.dataset.teacherClasses;
            
            document.getElementById('edit-teacher-id').value = teacherId;
            document.getElementById('edit-teacher-id-display').value = teacherId;
            document.getElementById('edit-teacher-name').value = teacherName;
            document.getElementById('edit-teacher-subjects').value = teacherSubjects;
            document.getElementById('edit-teacher-classes').value = teacherClasses;
            
            editTeacherModal.show();
        });
    });
    
    document.getElementById('save-teacher-btn').addEventListener('click', async () => {
        const teacherId = document.getElementById('edit-teacher-id').value;
        const name = document.getElementById('edit-teacher-name').value.trim();
        const subjects = document.getElementById('edit-teacher-subjects').value;
        const classes = document.getElementById('edit-teacher-classes').value;
        
        if (!name) {
            alert('Name is required');
            return;
        }
        
        try {
            const response = await fetch('/admin/update_teacher', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    teacher_id: teacherId,
                    name: name,
                    subjects: subjects.split(',').map(s => s.trim()).filter(s => s),
                    classes: classes.split(',').map(s => s.trim()).filter(s => s)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                editTeacherModal.hide();
                location.reload();
            } else {
                alert(data.error || 'Failed to update teacher');
            }
        } catch (e) {
            console.error('Update failed:', e);
            alert('Failed to update teacher');
        }
    });
    
    // ================== EDIT STUDENT ==================
    
    const editStudentModal = new bootstrap.Modal(document.getElementById('edit-student-modal'));
    
    function attachEditStudentListeners() {
        document.querySelectorAll('.edit-student-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const studentId = btn.dataset.studentId;
                const studentName = btn.dataset.studentName;
                const studentClass = btn.dataset.studentClass;
                const studentTeachers = btn.dataset.studentTeachers;
                
                document.getElementById('edit-student-id').value = studentId;
                document.getElementById('edit-student-id-display').value = studentId;
                document.getElementById('edit-student-name').value = studentName;
                document.getElementById('edit-student-class').value = studentClass;
                document.getElementById('edit-student-teachers').value = studentTeachers;
                
                editStudentModal.show();
            });
        });
    }
    
    document.getElementById('save-student-btn').addEventListener('click', async () => {
        const studentId = document.getElementById('edit-student-id').value;
        const name = document.getElementById('edit-student-name').value.trim();
        const studentClass = document.getElementById('edit-student-class').value;
        const teachers = document.getElementById('edit-student-teachers').value;
        
        if (!name) {
            alert('Name is required');
            return;
        }
        
        try {
            const response = await fetch('/admin/update_student', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: studentId,
                    name: name,
                    class: studentClass,
                    teachers: teachers.split(';').map(t => t.trim()).filter(t => t)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                editStudentModal.hide();
                loadStudents();
                // Show success message
                alert('âœ… Student updated successfully');
            } else {
                alert(data.error || 'Failed to update student');
            }
        } catch (e) {
            console.error('Update failed:', e);
            alert('Failed to update student');
        }
    });

    // ================== ADD FORMS ==================

    document.getElementById('add-teacher-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            teacher_id: document.getElementById('teacher_id').value,
            name: document.getElementById('teacher_name').value,
            password: document.getElementById('teacher_password').value || 'teacher123',
            subjects: document.getElementById('teacher_subjects').value.split(',').map(s => s.trim()).filter(s => s)
        };
        
        try {
            const response = await fetch('/admin/add_teacher', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showResult('add-teacher-result', `Teacher added: ${result.teacher_id}`, 'success');
                e.target.reset();
                setTimeout(() => location.reload(), 1500);
            } else {
                showResult('add-teacher-result', result.error, 'danger');
            }
        } catch (error) {
            showResult('add-teacher-result', 'Failed to add teacher', 'danger');
        }
    });

    document.getElementById('add-class-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            class_id: document.getElementById('class_id').value,
            name: document.getElementById('class_name').value || document.getElementById('class_id').value
        };
        
        try {
            const response = await fetch('/admin/add_class', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showResult('add-class-result', `Class added: ${result.class_id}`, 'success');
                e.target.reset();
                setTimeout(() => location.reload(), 1500);
            } else {
                showResult('add-class-result', result.error, 'danger');
            }
        } catch (error) {
            showResult('add-class-result', 'Failed to add class', 'danger');
        }
    });

    document.getElementById('assign-teacher-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            teacher_id: document.getElementById('assign_teacher_id').value,
            class_id: document.getElementById('assign_class_id').value
        };
        
        try {
            const response = await fetch('/admin/assign_teacher', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showResult('assign-result', `Assigned to ${result.updated} students`, 'success');
                e.target.reset();
            } else {
                showResult('assign-result', result.error, 'danger');
            }
        } catch (error) {
            showResult('assign-result', 'Failed to assign', 'danger');
        }
    });

    document.getElementById('unassign-teacher-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const teacherId = document.getElementById('unassign_teacher_id').value;
        const classId = document.getElementById('unassign_class_id').value;
        
        if (!confirm(`Are you sure you want to unassign this teacher from all students in class "${classId}"?`)) {
            return;
        }
        
        try {
            const response = await fetch('/admin/unassign_teacher', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ teacher_id: teacherId, class_id: classId })
            });
            const result = await response.json();
            
            if (result.success) {
                showResult('unassign-result', `Unassigned from ${result.updated} students`, 'success');
                e.target.reset();
                // Reload page to update counts
                setTimeout(() => location.reload(), 1500);
            } else {
                showResult('unassign-result', result.error, 'danger');
            }
        } catch (error) {
            showResult('unassign-result', 'Failed to unassign', 'danger');
        }
    });

    function showResult(elementId, message, type) {
        const el = document.getElementById(elementId);
        el.style.display = 'block';
        el.className = `mt-3 alert alert-${type}`;
        el.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle'} me-2"></i>${message}`;
    }

    // ================== AI PROMPTS MANAGEMENT ==================
    
    let currentPrompts = {};
    let defaultPrompts = {};
    
    // Load prompts when tab is clicked
    document.getElementById('prompts-tab').addEventListener('click', loadPrompts);
    
    async function loadPrompts() {
        const container = document.getElementById('prompts-container');
        const loading = document.getElementById('prompts-loading');
        
        try {
            const response = await fetch('/admin/api/prompts');
            const data = await response.json();
            
            if (data.success) {
                currentPrompts = data.prompts;
                defaultPrompts = data.defaults;
                renderPrompts();
                loading.style.display = 'none';
                container.style.display = 'block';
            } else {
                loading.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to load prompts'}</div>`;
            }
        } catch (e) {
            console.error('Failed to load prompts:', e);
            loading.innerHTML = `<div class="alert alert-danger">Failed to load prompts</div>`;
        }
    }
    
    function renderPrompts() {
        const container = document.getElementById('prompts-container');
        
        const promptTypes = Object.keys(currentPrompts);
        
        let html = '<div class="accordion" id="promptsAccordion">';
        
        promptTypes.forEach((key, index) => {
            const prompt = currentPrompts[key];
            const isFirst = index === 0;
            
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#prompt-${key}">
                            <strong>${prompt.name || key}</strong>
                            <span class="badge ${prompt.requires_answer ? 'bg-warning text-dark' : 'bg-secondary'} ms-2">
                                ${prompt.requires_answer ? 'Requires Answer' : 'No Answer Needed'}
                            </span>
                        </button>
                    </h2>
                    <div id="prompt-${key}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" data-bs-parent="#promptsAccordion">
                        <div class="accordion-body">
                            <p class="text-muted small mb-3">${prompt.description || ''}</p>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-gear me-1"></i>System Prompt
                                    <small class="text-muted fw-normal">(Instructions for the AI)</small>
                                </label>
                                <textarea class="form-control font-monospace" rows="10" 
                                          id="system-${key}" style="font-size: 0.85rem;">${escapeHtml(prompt.system_prompt || '')}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-chat-left-text me-1"></i>User Prompt
                                    <small class="text-muted fw-normal">(The actual request sent to AI)</small>
                                </label>
                                <textarea class="form-control font-monospace" rows="6" 
                                          id="user-${key}" style="font-size: 0.85rem;">${escapeHtml(prompt.user_prompt || '')}</textarea>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requires-${key}" 
                                           ${prompt.requires_answer ? 'checked' : ''}>
                                    <label class="form-check-label" for="requires-${key}">
                                        Requires student answer
                                    </label>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetSinglePrompt('${key}')">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset This Prompt
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    function resetSinglePrompt(key) {
        if (!confirm(`Reset "${currentPrompts[key].name}" to default? Your changes will be lost.`)) {
            return;
        }
        
        const defaultPrompt = defaultPrompts[key];
        if (defaultPrompt) {
            document.getElementById(`system-${key}`).value = defaultPrompt.system_prompt;
            document.getElementById(`user-${key}`).value = defaultPrompt.user_prompt;
            document.getElementById(`requires-${key}`).checked = defaultPrompt.requires_answer;
        }
    }
    
    document.getElementById('reset-prompts-btn').addEventListener('click', async () => {
        if (!confirm('Reset ALL prompts to defaults? All your customizations will be lost.')) {
            return;
        }
        
        try {
            const response = await fetch('/admin/api/prompts/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            
            if (data.success) {
                showResult('prompts-result', 'Prompts reset to defaults', 'success');
                loadPrompts();
            } else {
                showResult('prompts-result', data.error || 'Failed to reset prompts', 'danger');
            }
        } catch (e) {
            showResult('prompts-result', 'Failed to reset prompts', 'danger');
        }
    });
    
    document.getElementById('save-prompts-btn').addEventListener('click', async () => {
        const promptsToSave = {};
        
        Object.keys(currentPrompts).forEach(key => {
            promptsToSave[key] = {
                name: currentPrompts[key].name,
                description: currentPrompts[key].description,
                system_prompt: document.getElementById(`system-${key}`).value,
                user_prompt: document.getElementById(`user-${key}`).value,
                requires_answer: document.getElementById(`requires-${key}`).checked
            };
        });
        
        try {
            const response = await fetch('/admin/api/prompts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompts: promptsToSave })
            });
            const data = await response.json();
            
            if (data.success) {
                showResult('prompts-result', 'Prompts saved successfully!', 'success');
                // Update current prompts
                Object.keys(promptsToSave).forEach(key => {
                    currentPrompts[key] = { ...currentPrompts[key], ...promptsToSave[key] };
                });
            } else {
                showResult('prompts-result', data.error || 'Failed to save prompts', 'danger');
            }
        } catch (e) {
            showResult('prompts-result', 'Failed to save prompts', 'danger');
        }
    });

    // ================== TEACHING GROUPS ==================
    
    // Load students when class is selected for teaching group
    document.getElementById('tg_class_id').addEventListener('change', async (e) => {
        const classId = e.target.value;
        const container = document.getElementById('tg-students-container');
        
        if (!classId) {
            container.innerHTML = '<p class="text-muted small mb-0">Select a class first to see students</p>';
            return;
        }
        
        container.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm"></div> Loading...</div>';
        
        try {
            const response = await fetch(`/admin/api/students?class=${classId}`);
            const data = await response.json();
            
            if (data.students.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">No students in this class</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="mb-2">
                    <input type="checkbox" id="tg-select-all" class="form-check-input me-2">
                    <label for="tg-select-all" class="form-check-label"><strong>Select All (${data.students.length})</strong></label>
                </div>
                <hr class="my-2">
                ${data.students.map(s => `
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input tg-student-checkbox" value="${s.student_id}" id="tg-${s.student_id}">
                        <label class="form-check-label" for="tg-${s.student_id}">
                            ${s.name} <small class="text-muted">(${s.student_id})</small>
                        </label>
                    </div>
                `).join('')}
            `;
            
            // Select all handler
            document.getElementById('tg-select-all').addEventListener('change', (e) => {
                document.querySelectorAll('.tg-student-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
        } catch (e) {
            container.innerHTML = '<p class="text-danger small mb-0">Error loading students</p>';
        }
    });
    
    // Learning module access - save
    const saveModuleAccessBtn = document.getElementById('save-module-access-btn');
    const moduleAccessStatus = document.getElementById('module-access-status');
    if (saveModuleAccessBtn) {
        saveModuleAccessBtn.addEventListener('click', async () => {
            const teacherIds = [...document.querySelectorAll('.module-access-teacher:checked')].map(cb => cb.value);
            const classIds = [...document.querySelectorAll('.module-access-class:checked')].map(cb => cb.value);
            saveModuleAccessBtn.disabled = true;
            moduleAccessStatus.textContent = 'Saving...';
            try {
                const response = await fetch('{{ url_for("admin_save_module_access") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teacher_ids: teacherIds, class_ids: classIds })
                });
                const data = await response.json();
                if (data.success) {
                    moduleAccessStatus.textContent = 'Saved.';
                    moduleAccessStatus.className = 'ms-3 text-success small';
                } else {
                    moduleAccessStatus.textContent = data.error || 'Failed to save';
                    moduleAccessStatus.className = 'ms-3 text-danger small';
                }
            } catch (e) {
                moduleAccessStatus.textContent = 'Error saving';
                moduleAccessStatus.className = 'ms-3 text-danger small';
            }
            saveModuleAccessBtn.disabled = false;
        });
    }

    // Create teaching group form
    document.getElementById('create-teaching-group-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('tg_name').value.trim();
        const classId = document.getElementById('tg_class_id').value;
        const teacherId = document.getElementById('tg_teacher_id').value;
        const studentIds = [...document.querySelectorAll('.tg-student-checkbox:checked')].map(cb => cb.value);
        
        if (!name || !classId || !teacherId) {
            showResult('create-tg-result', 'Please fill in all required fields', 'warning');
            return;
        }
        
        if (studentIds.length === 0) {
            showResult('create-tg-result', 'Please select at least one student', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/admin/api/teaching-groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, class_id: classId, teacher_id: teacherId, student_ids: studentIds })
            });
            const data = await response.json();
            
            if (data.success) {
                showResult('create-tg-result', `Teaching group "${name}" created with ${studentIds.length} students!`, 'success');
                // Reset form
                document.getElementById('create-teaching-group-form').reset();
                document.getElementById('tg-students-container').innerHTML = '<p class="text-muted small mb-0">Select a class first to see students</p>';
                loadTeachingGroups();
            } else {
                showResult('create-tg-result', data.error || 'Failed to create teaching group', 'danger');
            }
        } catch (e) {
            showResult('create-tg-result', 'Error creating teaching group', 'danger');
        }
    });
    
    // Load teaching groups
    async function loadTeachingGroups() {
        const tbody = document.getElementById('teaching-groups-tbody');
        
        try {
            const response = await fetch('/admin/api/teaching-groups');
            const data = await response.json();
            
            if (!data.groups || data.groups.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No teaching groups created yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.groups.map(g => `
                <tr data-group-id="${g.group_id}">
                    <td><strong>${g.name}</strong></td>
                    <td>${g.class_id}</td>
                    <td>${g.teacher_name || g.teacher_id}</td>
                    <td>
                        <span class="badge bg-primary">${g.student_count || g.student_ids?.length || 0} students</span>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm download-tg-pdf-btn me-1" data-group-id="${g.group_id}" title="Download Student List PDF">
                            <i class="bi bi-file-pdf"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm view-tg-btn me-1" data-group-id="${g.group_id}" title="View Students">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm delete-tg-btn" data-group-id="${g.group_id}" data-group-name="${g.name}" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Attach event listeners
            attachTeachingGroupListeners();
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error loading teaching groups</td></tr>';
        }
    }
    
    function attachTeachingGroupListeners() {
        // Download PDF for teaching group
        document.querySelectorAll('.download-tg-pdf-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const groupId = btn.dataset.groupId;
                window.open(`/admin/api/teaching-group-report/${groupId}/pdf`, '_blank');
            });
        });
        
        // View students in teaching group
        document.querySelectorAll('.view-tg-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const groupId = btn.dataset.groupId;
                try {
                    const response = await fetch(`/admin/api/teaching-groups/${groupId}`);
                    const data = await response.json();
                    
                    if (data.group) {
                        const students = data.group.students || [];
                        alert(`Students in "${data.group.name}":\n\n${students.map(s => `â€¢ ${s.name} (${s.student_id})`).join('\n') || 'No students'}`);
                    }
                } catch (e) {
                    alert('Error loading teaching group details');
                }
            });
        });
        
        // Delete teaching group
        document.querySelectorAll('.delete-tg-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const groupId = btn.dataset.groupId;
                const groupName = btn.dataset.groupName;
                
                if (!confirm(`Delete teaching group "${groupName}"? This will not delete the students.`)) return;
                
                try {
                    const response = await fetch(`/admin/api/teaching-groups/${groupId}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (data.success) {
                        loadTeachingGroups();
                    } else {
                        alert(data.error || 'Failed to delete teaching group');
                    }
                } catch (e) {
                    alert('Error deleting teaching group');
                }
            });
        });
    }
    
    // Load teaching groups when tab is shown
    document.getElementById('teaching-groups-tab').addEventListener('shown.bs.tab', () => {
        loadTeachingGroups();
        loadTeachingGroupsForBulkAssign();
    });
    
    // Also load on page load if hash is #teaching-groups
    if (window.location.hash === '#teaching-groups') {
        document.getElementById('teaching-groups-tab').click();
    }
    
    // ================== BULK ADD STUDENTS TO TEACHING GROUP ==================
    
    async function loadTeachingGroupsForBulkAssign() {
        const select = document.getElementById('tg_bulk_assign_group_id');
        try {
            const response = await fetch('/admin/api/teaching-groups');
            const data = await response.json();
            
            if (data.groups && data.groups.length > 0) {
                select.innerHTML = '<option value="">Choose a teaching group...</option>' +
                    data.groups.map(g => `<option value="${g.group_id}">${g.name} (${g.student_count || 0} students)</option>`).join('');
            } else {
                select.innerHTML = '<option value="">No teaching groups available</option>';
            }
        } catch (e) {
            select.innerHTML = '<option value="">Error loading teaching groups</option>';
        }
    }
    
    let tgMatchedStudents = [];
    
    document.getElementById('preview-tg-bulk-assign-btn').addEventListener('click', async () => {
        const groupId = document.getElementById('tg_bulk_assign_group_id').value;
        const namesText = document.getElementById('tg_bulk_assign_names').value.trim();
        
        if (!groupId) {
            alert('Please select a teaching group first');
            return;
        }
        
        if (!namesText) {
            alert('Please enter student names');
            return;
        }
        
        // Parse names (split by newlines only - each line is one complete name)
        const names = namesText.split(/\n/).map(n => n.trim()).filter(n => n);
        
        if (names.length === 0) {
            alert('No valid names found');
            return;
        }
        
        const btn = document.getElementById('preview-tg-bulk-assign-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Matching...';
        
        try {
            const response = await fetch('/admin/api/match-students-by-name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ names })
            });
            const data = await response.json();
            
            if (!data.success) {
                alert(data.error || 'Error matching students');
                return;
            }
            
            tgMatchedStudents = data.found;
            displayTgMatchResults(data.found, data.not_found);
            document.getElementById('tg-bulk-assign-preview').style.display = 'block';
            
        } catch (e) {
            alert('Error matching students');
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search me-1"></i>Preview & Match Students';
        }
    });
    
    function displayTgMatchResults(found, notFound) {
        // Found students table
        const foundTbody = document.getElementById('tg-found-students-tbody');
        document.getElementById('tg-found-count').textContent = found.length;
        
        if (found.length === 0) {
            foundTbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No matching students found</td></tr>';
        } else {
            foundTbody.innerHTML = found.map(s => `
                <tr>
                    <td><input type="checkbox" class="tg-found-student-cb" value="${s.student_id}" checked></td>
                    <td>
                        ${escapeHtml(s.name)}
                        ${s.partial_match ? '<span class="badge bg-info ms-1" title="Partial match">~</span>' : ''}
                    </td>
                    <td><code>${s.student_id}</code></td>
                    <td>${s.class || '<span class="text-muted">-</span>'}</td>
                </tr>
            `).join('');
        }
        
        // Not found table
        const notFoundTbody = document.getElementById('tg-notfound-students-tbody');
        document.getElementById('tg-notfound-count').textContent = notFound.length;
        
        if (notFound.length === 0) {
            notFoundTbody.innerHTML = '<tr><td colspan="2" class="text-success text-center">All students found!</td></tr>';
        } else {
            notFoundTbody.innerHTML = notFound.map(s => `
                <tr>
                    <td>${escapeHtml(s.input_name)}</td>
                    <td><span class="badge bg-warning text-dark">Not in system</span></td>
                </tr>
            `).join('');
        }
        
        // Update assign button
        updateTgBulkAssignButton();
        
        // Select all handler
        document.getElementById('tg-select-all-found').addEventListener('change', (e) => {
            document.querySelectorAll('.tg-found-student-cb').forEach(cb => cb.checked = e.target.checked);
            updateTgBulkAssignButton();
        });
        
        // Individual checkbox handlers
        document.querySelectorAll('.tg-found-student-cb').forEach(cb => {
            cb.addEventListener('change', updateTgBulkAssignButton);
        });
    }
    
    function updateTgBulkAssignButton() {
        const selectedCount = document.querySelectorAll('.tg-found-student-cb:checked').length;
        document.getElementById('tg-assign-count').textContent = selectedCount;
        document.getElementById('confirm-tg-bulk-assign-btn').disabled = selectedCount === 0;
    }
    
    document.getElementById('confirm-tg-bulk-assign-btn').addEventListener('click', async () => {
        const groupId = document.getElementById('tg_bulk_assign_group_id').value;
        const selectedIds = [...document.querySelectorAll('.tg-found-student-cb:checked')].map(cb => cb.value);
        
        if (!groupId || selectedIds.length === 0) return;
        
        const btn = document.getElementById('confirm-tg-bulk-assign-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Adding...';
        
        try {
            const response = await fetch(`/admin/api/teaching-groups/${groupId}/add-students`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_ids: selectedIds })
            });
            const data = await response.json();
            
            if (data.success) {
                let message = `Added ${data.added} student(s) to group. Total: ${data.total} students.`;
                if (data.already_in_group > 0) {
                    message += ` (${data.already_in_group} already in group)`;
                }
                showResult('tg-bulk-assign-result', message, 'success');
                // Reset form
                document.getElementById('tg_bulk_assign_names').value = '';
                document.getElementById('tg-bulk-assign-preview').style.display = 'none';
                tgMatchedStudents = [];
                // Refresh teaching groups
                loadTeachingGroups();
                loadTeachingGroupsForBulkAssign();
            } else {
                showResult('tg-bulk-assign-result', data.error || 'Failed to add students', 'danger');
            }
        } catch (e) {
            showResult('tg-bulk-assign-result', 'Error adding students', 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check2-all me-1"></i>Add <span id="tg-assign-count">' + selectedIds.length + '</span> Students to Group';
        }
    });
    
    document.getElementById('cancel-tg-bulk-assign-btn').addEventListener('click', () => {
        document.getElementById('tg-bulk-assign-preview').style.display = 'none';
        document.getElementById('tg-bulk-assign-result').style.display = 'none';
        tgMatchedStudents = [];
    });

    // ================== REPORTS & TOOLS ==================
    
    // Load teaching groups for report dropdown when tab is shown
    document.getElementById('reports-tab').addEventListener('shown.bs.tab', loadTeachingGroupsForReport);
    
    // Teacher report dropdown
    document.getElementById('teacher_report_select').addEventListener('change', async (e) => {
        const teacherId = e.target.value;
        const contentDiv = document.getElementById('teacher-report-content');
        
        if (!teacherId) {
            contentDiv.innerHTML = `
                <div class="text-muted text-center py-4">
                    <i class="bi bi-arrow-left me-2"></i>Select a teacher to view their classes and groups
                </div>
            `;
            return;
        }
        
        contentDiv.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-primary"></div>
                <span class="ms-2">Loading...</span>
            </div>
        `;
        
        try {
            const response = await fetch(`/admin/api/teacher/${teacherId}/assignments`);
            const data = await response.json();
            
            if (!data.success) {
                contentDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Error loading data'}</div>`;
                return;
            }
            
            let html = `<label class="form-label fw-bold">${escapeHtml(data.teacher.name)}'s Classes & Groups</label>`;
            
            // Classes section
            if (data.classes.length > 0) {
                html += `<div class="mb-3"><small class="text-muted">Classes:</small><div class="list-group list-group-flush">`;
                data.classes.forEach(c => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                            <div>
                                <strong>${escapeHtml(c.class_id)}</strong>
                                ${c.name && c.name !== c.class_id ? `<small class="text-muted"> - ${escapeHtml(c.name)}</small>` : ''}
                                <span class="badge bg-secondary ms-2">${c.student_count} students</span>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="window.open('/admin/api/class-report/${c.class_id}/pdf?teacher_id=${teacherId}', '_blank')">
                                <i class="bi bi-download me-1"></i>PDF
                            </button>
                        </div>
                    `;
                });
                html += `</div></div>`;
            } else {
                html += `<div class="text-muted small mb-3">No classes assigned</div>`;
            }
            
            // Teaching groups section
            if (data.teaching_groups.length > 0) {
                html += `<div><small class="text-muted">Teaching Groups:</small><div class="list-group list-group-flush">`;
                data.teaching_groups.forEach(g => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-0">
                            <div>
                                <strong>${escapeHtml(g.name)}</strong>
                                <small class="text-muted"> (${escapeHtml(g.class_id)})</small>
                                <span class="badge bg-info ms-2">${g.student_count} students</span>
                            </div>
                            <button class="btn btn-info btn-sm" onclick="window.open('/admin/api/teaching-group-report/${g.group_id}/pdf', '_blank')">
                                <i class="bi bi-download me-1"></i>PDF
                            </button>
                        </div>
                    `;
                });
                html += `</div></div>`;
            } else {
                html += `<div class="text-muted small">No teaching groups assigned</div>`;
            }
            
            if (data.classes.length === 0 && data.teaching_groups.length === 0) {
                html = `<div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    This teacher has no assigned classes or teaching groups.
                </div>`;
            }
            
            contentDiv.innerHTML = html;
            
        } catch (e) {
            contentDiv.innerHTML = `<div class="alert alert-danger">Error loading teacher data</div>`;
        }
    });
    
    async function loadTeachingGroupsForReport() {
        const select = document.getElementById('report_tg_id');
        try {
            const response = await fetch('/admin/api/teaching-groups');
            const data = await response.json();
            
            if (data.groups && data.groups.length > 0) {
                select.innerHTML = '<option value="">Choose a teaching group...</option>' +
                    data.groups.map(g => `<option value="${g.group_id}">${g.name} (${g.student_count || 0} students)</option>`).join('');
            } else {
                select.innerHTML = '<option value="">No teaching groups available</option>';
            }
        } catch (e) {
            select.innerHTML = '<option value="">Error loading teaching groups</option>';
        }
    }
    
    // Generate Class Student List PDF
    document.getElementById('class-report-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const classId = document.getElementById('report_class_id').value;
        const teacherId = document.getElementById('report_teacher_id').value;
        
        if (!classId) {
            alert('Please select a class');
            return;
        }
        
        let url = `/admin/api/class-report/${classId}/pdf`;
        if (teacherId) {
            url += `?teacher_id=${teacherId}`;
        }
        
        window.open(url, '_blank');
    });
    
    // Generate Teaching Group Student List PDF
    document.getElementById('tg-report-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const groupId = document.getElementById('report_tg_id').value;
        
        if (!groupId) {
            alert('Please select a teaching group');
            return;
        }
        
        window.open(`/admin/api/teaching-group-report/${groupId}/pdf`, '_blank');
    });
    
    // Convert Class to Teaching Group
    document.getElementById('convert-class-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const classId = document.getElementById('convert_class_id').value;
        const teacherId = document.getElementById('convert_teacher_id').value;
        const groupName = document.getElementById('convert_group_name').value.trim();
        
        if (!classId || !teacherId) {
            showResult('convert-class-result', 'Please select both a class and a teacher', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/admin/api/class-to-teaching-group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    class_id: classId,
                    teacher_id: teacherId,
                    group_name: groupName || null
                })
            });
            const data = await response.json();
            
            if (data.success) {
                showResult('convert-class-result', 
                    `Teaching group "${data.group_name}" created with ${data.student_count} students!`, 'success');
                document.getElementById('convert-class-form').reset();
                // Refresh teaching groups dropdown
                loadTeachingGroupsForReport();
            } else {
                showResult('convert-class-result', data.error || 'Failed to create teaching group', 'danger');
            }
        } catch (e) {
            showResult('convert-class-result', 'Error creating teaching group', 'danger');
        }
    });
    
    // ================== DUPLICATE DETECTION ==================
    
    let currentDuplicates = [];
    
    document.getElementById('scan-duplicates-btn').addEventListener('click', async () => {
        const btn = document.getElementById('scan-duplicates-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Scanning...';
        
        try {
            const response = await fetch('/admin/api/duplicates');
            const data = await response.json();
            
            if (data.success) {
                currentDuplicates = data.duplicates;
                displayDuplicates(data.duplicates);
                document.getElementById('duplicates-result').style.display = 'block';
                document.getElementById('download-duplicates-report-btn').disabled = data.duplicates.length === 0;
                document.getElementById('resolve-duplicates-btn').disabled = data.duplicates.length === 0;
            } else {
                alert(data.error || 'Error scanning for duplicates');
            }
        } catch (e) {
            alert('Error scanning for duplicates');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-search me-1"></i>Scan for Duplicates';
        }
    });
    
    function displayDuplicates(duplicates) {
        const countEl = document.getElementById('duplicates-count');
        const listEl = document.getElementById('duplicates-list');
        
        countEl.textContent = duplicates.length;
        
        if (duplicates.length === 0) {
            listEl.innerHTML = '<div class="p-3 text-center text-success"><i class="bi bi-check-circle me-2"></i>No duplicate students found!</div>';
            return;
        }
        
        listEl.innerHTML = duplicates.map((group, idx) => `
            <div class="border-bottom p-2 ${idx % 2 === 0 ? 'bg-light' : ''}">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${escapeHtml(group.name)}</strong>
                    <span class="badge bg-warning text-dark">${group.count} accounts</span>
                </div>
                <div class="small text-muted mt-1">
                    ${group.students.map((s, i) => `
                        <span class="${i === 0 ? 'text-success fw-bold' : 'text-danger'}">
                            ${s.student_id}${i === 0 ? ' (KEEP)' : ''}
                        </span>
                    `).join(' | ')}
                </div>
            </div>
        `).join('');
    }
    
    // Download duplicates report PDF
    document.getElementById('download-duplicates-report-btn').addEventListener('click', () => {
        window.open('/admin/api/duplicates/report/pdf', '_blank');
    });
    
    // Resolve duplicates
    document.getElementById('resolve-duplicates-btn').addEventListener('click', async () => {
        if (currentDuplicates.length === 0) {
            alert('No duplicates to resolve');
            return;
        }
        
        const totalDuplicates = currentDuplicates.reduce((sum, g) => sum + g.count - 1, 0);
        
        if (!confirm(`This will:\n\nâ€¢ Keep the OLDEST account for each student\nâ€¢ Remove ${totalDuplicates} duplicate account(s)\nâ€¢ Transfer all submissions and messages to the kept account\n\nThis cannot be undone. Continue?`)) {
            return;
        }
        
        const btn = document.getElementById('resolve-duplicates-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Resolving...';
        
        try {
            // Format groups for the API
            const groups = currentDuplicates.map(g => g.students);
            
            const response = await fetch('/admin/api/duplicates/resolve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ groups })
            });
            const data = await response.json();
            
            if (data.success) {
                alert(`Successfully resolved ${data.resolved_count} duplicate(s)!\n\nAffected teachers: ${data.affected_teachers.map(t => t.name).join(', ') || 'None'}`);
                
                // Offer to download affected teachers report
                if (data.resolved_mappings.length > 0 && data.affected_teachers.length > 0) {
                    if (confirm('Would you like to download a report for affected teachers?')) {
                        downloadAffectedTeachersReport(data.resolved_mappings, data.affected_teachers.map(t => t.teacher_id));
                    }
                }
                
                // Refresh the scan
                document.getElementById('scan-duplicates-btn').click();
                // Refresh student list
                loadStudents();
            } else {
                alert(data.error || 'Error resolving duplicates');
            }
        } catch (e) {
            alert('Error resolving duplicates');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check2-all me-1"></i>Resolve All Duplicates (Keep Oldest IDs)';
        }
    });
    
    async function downloadAffectedTeachersReport(resolvedMappings, affectedTeacherIds) {
        try {
            const response = await fetch('/admin/api/duplicates/affected-teachers-report/pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    resolved_mappings: resolvedMappings,
                    affected_teacher_ids: affectedTeacherIds
                })
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'affected_teachers_report.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } else {
                alert('Error downloading report');
            }
        } catch (e) {
            alert('Error downloading report');
        }
    }
    
    // ================== IMPORT WITH RECONCILIATION ==================
    
    // Add reconciliation checkbox to import section
    document.addEventListener('DOMContentLoaded', () => {
        const importBtn = document.getElementById('import-excel-btn');
        if (importBtn) {
            const reconcileDiv = document.createElement('div');
            reconcileDiv.className = 'form-check mt-2';
            reconcileDiv.innerHTML = `
                <input type="checkbox" class="form-check-input" id="reconcile-by-name" checked>
                <label class="form-check-label small" for="reconcile-by-name">
                    <i class="bi bi-shield-check me-1"></i>Reconcile duplicates by name (use existing student ID if name matches)
                </label>
            `;
            importBtn.parentNode.insertBefore(reconcileDiv, importBtn);
        }
    });
    
    // Override the import function to support reconciliation
    const originalImportStudents = window.importStudents;
    window.importStudents = async function(students) {
        const reconcile = document.getElementById('reconcile-by-name')?.checked ?? true;
        
        try {
            const endpoint = reconcile ? '/admin/import_students_with_reconciliation' : '/admin/import_students';
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ students, reconcile_by_name: reconcile })
            });
            const data = await response.json();
            
            if (data.success) {
                let message = `Imported ${data.imported} students`;
                if (data.updated > 0) {
                    message += `, updated ${data.updated}`;
                }
                if (data.reconciled_count > 0) {
                    message += `, reconciled ${data.reconciled_count} duplicates`;
                    // Show reconciled details
                    const reconciled = data.reconciled;
                    if (reconciled && reconciled.length > 0) {
                        const details = reconciled.map(r => `${r.name}: used existing ID ${r.existing_id} instead of ${r.attempted_id}`).join('\n');
                        console.log('Reconciled students:\n' + details);
                    }
                }
                if (data.errors.length > 0) {
                    message += `. Errors: ${data.errors.slice(0, 3).join(', ')}${data.errors.length > 3 ? '...' : ''}`;
                }
                
                showResult('import-result', message, data.errors.length ? 'warning' : 'success');
                loadStudents();
            } else {
                showResult('import-result', data.error, 'danger');
            }
        } catch (e) {
            showResult('import-result', 'Import failed', 'danger');
        }
    };
</script>
{% endblock %}
