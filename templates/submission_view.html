{% extends "base.html" %}

{% block title %}Submission Feedback - School Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>School Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('assignments_list') }}">Assignments</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('student_submissions') }}">Submissions</a>
                </li>
            </ul>
            <div class="navbar-nav">
                <span class="navbar-text me-3">{{ session.student_name }}</span>
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student_submissions') }}">My Submissions</a></li>
            <li class="breadcrumb-item active">{{ assignment.title }}{% if submission.get('version') %} (Version {{ submission.version }}){% endif %}</li>
        </ol>
    </nav>
    
    <!-- Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-1">{{ assignment.title }}{% if submission.get('version') %} <span class="text-muted">(Version {{ submission.version }})</span>{% endif %}</h4>
                    <p class="text-muted mb-2">
                        <span class="badge bg-primary me-2">{{ assignment.subject }}</span>
                        Submitted: {{ (submission.submitted_at|sgt).strftime('%d %B %Y, %H:%M') if submission.submitted_at else 'N/A' }} SGT
                    </p>
                    <div>
                        {% if submission.status == 'reviewed' %}
                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Reviewed by Teacher</span>
                        {% elif submission.status == 'ai_reviewed' %}
                        <span class="badge bg-info"><i class="bi bi-robot me-1"></i>AI Reviewed - Awaiting Teacher</span>
                        {% else %}
                        <span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Pending Review</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    {% if submission.get('feedback_sent', False) %}
                    <div class="d-flex flex-wrap gap-2 justify-content-md-end mb-2">
                        <button type="button" class="btn btn-primary" id="btn-send-corrections" 
                                data-submission-id="{{ submission.submission_id }}"
                                {% if submission.get('correction_sent', False) %}disabled title="Already sent"{% endif %}>
                            <i class="bi bi-send me-1"></i>{% if submission.get('correction_sent', False) %}Corrections Sent{% else %}Send Corrections / Challenge{% endif %}
                        </button>
                        {% if submission.get('correction_sent', False) and submission.get('correction_sent_at') %}
                        <small class="text-muted align-self-center">Sent {{ (submission.correction_sent_at|sgt).strftime('%d %b %Y, %H:%M') }} SGT</small>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if submission.get('feedback_sent', False) and submission.get('final_marks') is not none %}
                    <div class="score-box">
                        {% if assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}
                        <div class="score-value">{{ submission.get('final_marks', 0) }}<span class="score-total">/{{ assignment.get('total_marks', 100) }}</span></div>
                        <div class="score-label">Your Score</div>
                        {% set final_marks_num = submission.get('final_marks', 0)|float %}
                        {% set total_marks_num = assignment.get('total_marks', 100)|float %}
                        {% set percentage = (final_marks_num / total_marks_num * 100) if total_marks_num > 0 else 0 %}
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar {% if percentage >= 70 %}bg-success{% elif percentage >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ percentage }}%"></div>
                        </div>
                        <small class="text-muted">{{ "%.1f"|format(percentage) }}%</small>
                        {% else %}
                        {% set final_marks_num = submission.get('final_marks', 0)|float %}
                        {% set total_marks_num = assignment.get('total_marks', 100)|float %}
                        {% set percentage = (final_marks_num / total_marks_num * 100) if total_marks_num > 0 else 0 %}
                        {% if percentage >= 99.9 %}
                        <div class="score-value text-success"><i class="bi bi-check-circle me-1"></i>Correct</div>
                        {% elif percentage <= 0.01 %}
                        <div class="score-value text-danger"><i class="bi bi-x-circle me-1"></i>Incorrect</div>
                        {% else %}
                        <div class="score-value text-warning"><i class="bi bi-dash-circle me-1"></i>Partial correct</div>
                        {% endif %}
                        <div class="score-label">Your Result</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row" id="review-row">
        <!-- Left: Your Submission (same PDF/image viewer as teacher review page) -->
        <div class="col-lg-4 mb-4" id="submission-panel">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-earmark me-2"></i>Your Submission</h5>
                    {% if submission.file_ids %}
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="btn-open-annotator" title="Annotate your submission">
                            <i class="bi bi-pencil-fill me-1"></i>Annotate
                        </button>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="submissionPrevPage()" id="submission-prev-btn" disabled>
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <span class="btn btn-outline-secondary disabled" id="submission-page-indicator">Page 1/{{ submission.page_count or (submission.file_ids|length) or 1 }}</span>
                            <button class="btn btn-outline-secondary" onclick="submissionNextPage()" id="submission-next-btn" {% if (submission.page_count or (submission.file_ids|length) or 1) <= 1 %}disabled{% endif %}>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" id="submission-zoom-out-btn" onclick="submissionZoomOut()" title="Zoom Out">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="submission-zoom-in-btn" onclick="submissionZoomIn()" title="Zoom In">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="submission-fullscreen-btn" onclick="submissionToggleFullscreen()" title="Toggle Fullscreen">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body p-0" style="height: calc(100vh - 350px); min-height: 320px; overflow: auto; background: #f0f0f0;" id="submission-body">
                    {% if submission.file_ids %}
                    <div id="submission-viewer-wrap" style="display: flex; justify-content: center; align-items: flex-start; padding: 10px;">
                        {% set _page_count = submission.page_count or (submission.file_ids|length) or 1 %}
                        {% if submission.file_type == 'pdf' and _page_count > 1 %}
                        {# Single PDF with multiple pages: one page as image via backend #}
                        <img id="submission-pdf-page-image" 
                             src="{{ url_for('view_student_submission_file', submission_id=submission.submission_id, file_index=0) }}?as_image=1&amp;pdf_page=0"
                             style="width: 100%; height: auto; transform-origin: top center; object-fit: contain;" class="submission-img">
                        {% elif submission.file_type == 'pdf' %}
                        <iframe id="submission-pdf-viewer" 
                                src="{{ url_for('view_student_submission_file', submission_id=submission.submission_id, file_index=0) }}"
                                style="width: 100%; height: calc(100vh - 400px); min-height: 300px; border: none;"></iframe>
                        {% else %}
                        <img id="submission-page-image" src="{{ url_for('view_student_submission_file', submission_id=submission.submission_id, file_index=0) }}" 
                             style="width: 100%; height: auto; transform-origin: top center; object-fit: contain;" class="submission-img">
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-file-earmark-x" style="font-size: 3rem;"></i>
                        <p class="mt-2">No files available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right: Feedback + Your correction/challenge column -->
        <div class="col-lg-8 mb-4" id="feedback-panel">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-chat-left-text me-2"></i>Feedback</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% set feedback_sent = submission.get('feedback_sent', False) %}
                    
                    {% if feedback_sent %}
                        {# Only show feedback after teacher has sent it #}
                        {% set ai_feedback = submission.get('ai_feedback', {}) %}
                        {% set teacher_feedback = submission.get('teacher_feedback', {}) %}
                        {% set student_corrections = submission.get('student_corrections', {}) %}
                        {% set correction_sent = submission.get('correction_sent', False) %}
                        {% set questions = ai_feedback.get('questions', []) %}
                        {% set criteria = ai_feedback.get('criteria', []) %}
                        {% set is_rubric = assignment.marking_type == 'rubric' or (criteria and not questions) %}
                        
                        {% if questions %}
                        {% set include_answer_key = submission.get('include_answer_key', False) %}
                        {% set show_marks_column = assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}
                        <!-- Standard: Feedback Table by Question -->
                        <div class="table-responsive">
                            <table class="table table-sm feedback-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;">Q#</th>
                                        {% if include_answer_key %}
                                        <th style="width: 35%;">Answer Key</th>
                                        {% endif %}
                                        <th>Feedback</th>
                                        <th style="width: 70px;">{% if show_marks_column %}Marks{% else %}Result{% endif %}</th>
                                        <th style="width: 22%;">Your correction / challenge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for q in questions %}
                                    {% set teacher_q = teacher_feedback.get('questions', {}).get(q.question_num|string, {}) %}
                                    {% set q_correction = student_corrections.get('questions', {}).get(q.question_num|string, '') %}
                                    {% set marks = teacher_q.get('marks') if teacher_q.get('marks') is not none else q.get('marks_awarded') %}
                                    {% set marks_total_val = (q.marks_total|float) if (q.marks_total and q.marks_total|float > 0) else 1 %}
                                    {% set marks_num = marks|float if marks is not none else None %}
                                    {% set q_pct = (marks_num / marks_total_val * 100) if (marks_num is not none and marks_total_val > 0) else None %}
                                    <tr class="{% if q.is_correct %}table-success{% elif q.is_correct == false %}table-danger{% elif q.needs_review %}table-warning{% endif %}">
                                        <td class="text-center">
                                            <strong>{{ q.question_num }}</strong>
                                            {% if q.is_correct %}
                                            <br><i class="bi bi-check-circle text-success"></i>
                                            {% elif q.is_correct == false %}
                                            <br><i class="bi bi-x-circle text-danger"></i>
                                            {% elif q.needs_review %}
                                            <br><i class="bi bi-question-circle text-warning"></i>
                                            {% endif %}
                                        </td>
                                        {% if include_answer_key %}
                                        <td class="small">
                                            {% set answer_key = teacher_q.get('answer_key') or q.get('correct_answer', '') %}
                                            {% if answer_key %}
                                            <div class="answer-key-text">{{ answer_key }}</div>
                                            {% endif %}
                                            {% if teacher_q.get('answer_key_image') %}
                                            <div class="mt-1">
                                                <img src="{{ teacher_q.get('answer_key_image') }}" class="img-thumbnail" style="max-height: 100px; cursor: pointer;" 
                                                     onclick="window.open(this.src, '_blank')">
                                            </div>
                                            {% endif %}
                                            {% if not answer_key and not teacher_q.get('answer_key_image') %}
                                            <span class="text-muted fst-italic">-</span>
                                            {% endif %}
                                        </td>
                                        {% endif %}
                                        <td>
                                            {% set feedback = teacher_q.get('feedback') or q.get('feedback', '') %}
                                            {% if feedback %}
                                            <p class="mb-1">{{ feedback }}</p>
                                            {% endif %}
                                            
                                            {% if q.get('improvement') %}
                                            <small class="text-info">
                                                <i class="bi bi-lightbulb me-1"></i>{{ q.improvement }}
                                            </small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if show_marks_column %}
                                            {% if marks is not none %}
                                            <span class="badge {% if marks_num == marks_total_val %}bg-success{% elif marks_num and marks_num > 0 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                {{ marks }}/{{ q.marks_total or '?' }}
                                            </span>
                                            {% else %}
                                            <span class="badge bg-secondary">?/{{ q.marks_total or '?' }}</span>
                                            {% endif %}
                                            {% else %}
                                            {% if q_pct is not none %}
                                            {% if q_pct >= 99.9 %}
                                            <span class="badge bg-success">Correct</span>
                                            {% elif q_pct <= 0.01 %}
                                            <span class="badge bg-danger">Incorrect</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Partial correct</span>
                                            {% endif %}
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                            {% endif %}
                                        </td>
                                        <td class="correction-cell">
                                            {% if correction_sent %}
                                            <div class="small text-muted">{{ q_correction or '—' }}</div>
                                            {% else %}
                                            <textarea class="form-control form-control-sm correction-input" name="correction_q{{ q.question_num }}" rows="2" placeholder="Your correction or challenge...">{{ q_correction }}</textarea>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% elif is_rubric and criteria %}
                        <!-- Rubric: same structure as teacher review -->
                        <h6 class="mb-2"><i class="bi bi-list-check me-2"></i>Rubric Criteria Assessment</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered feedback-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 12%;">Criterion</th>
                                        <th style="width: 28%;">Reasoning for Mark</th>
                                        <th style="width: 28%;">Feedback / Area for Improvement</th>
                                        <th style="width: 12%;">Marks</th>
                                        <th style="width: 20%;">Your correction / challenge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for criterion in criteria %}
                                    {% set teacher_c = teacher_feedback.get('criteria', {}).get(criterion.name|string, {}) %}
                                    {% set c_correction = student_corrections.get('criteria', {}).get(criterion.name|string, '') %}
                                    <tr>
                                        <td class="fw-bold">{{ criterion.name }}</td>
                                        <td class="small">
                                            {{ teacher_c.get('reasoning') or criterion.reasoning or '—' }}
                                        </td>
                                        <td class="small">
                                            {{ teacher_c.get('afi') or criterion.afi or '—' }}
                                        </td>
                                        <td class="text-center">
                                            {% set m = teacher_c.get('marks') if teacher_c.get('marks') is not none else criterion.marks_awarded %}
                                            {% set mx = teacher_c.get('max_marks') or criterion.max_marks or 10 %}
                                            {% if m is not none %}
                                            <span class="badge bg-primary">{{ m }}/{{ mx }}</span>
                                            {% else %}
                                            <span class="text-muted">—/{{ mx }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="correction-cell">
                                            {% if correction_sent %}
                                            <div class="small text-muted">{{ c_correction or '—' }}</div>
                                            {% else %}
                                            <textarea class="form-control form-control-sm correction-input rubric-criterion" data-criterion="{{ criterion.name }}" rows="2" placeholder="Your correction or challenge...">{{ c_correction }}</textarea>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td class="fw-bold">Overall</td>
                                        <td colspan="2">
                                            {{ teacher_feedback.get('overall_feedback') or ai_feedback.get('overall_feedback') or '—' }}
                                        </td>
                                        <td class="text-center fw-bold">
                                            {{ submission.get('teacher_feedback', {}).get('total_marks') or ai_feedback.total_marks or '—' }}/{{ assignment.total_marks or 100 }}
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% set display_errors = teacher_feedback.get('errors') or ai_feedback.get('errors') or [] %}
                        {% set errors_corrections = student_corrections.get('errors', []) %}
                        {% if display_errors %}
                        <h6 class="mt-4 mb-2"><i class="bi bi-exclamation-triangle me-2"></i>Detailed Corrections</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 12%;">Location</th>
                                        <th style="width: 20%;">Error</th>
                                        <th style="width: 24%;">Suggested Correction</th>
                                        <th style="width: 24%;">Feedback</th>
                                        <th style="width: 20%;">Your correction / challenge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for err in display_errors %}
                                    {% set err_idx = loop.index0 %}
                                    {% set err_correction_raw = errors_corrections[err_idx] if err_idx < errors_corrections|length else '' %}
                                    {% set err_correction_text = err_correction_raw.get('text', err_correction_raw) if err_correction_raw is mapping else err_correction_raw %}
                                    <tr>
                                        <td class="small">{{ err.location or '—' }}</td>
                                        <td class="small">{{ err.error or '—' }}</td>
                                        <td class="small">{{ err.correction or '—' }}</td>
                                        <td class="small">{{ err.feedback or '—' }}</td>
                                        <td class="correction-cell">
                                            {% if correction_sent %}
                                            <div class="small text-muted">{{ err_correction_text or '—' }}</div>
                                            {% else %}
                                            <textarea class="form-control form-control-sm correction-input rubric-error" data-error-index="{{ err_idx }}" rows="2" placeholder="Your correction or challenge...">{{ err_correction_text }}</textarea>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        <!-- Overall Feedback (standard view only; rubric already has overall in table) -->
                        {% set overall = teacher_feedback.get('overall_feedback') or ai_feedback.get('overall_feedback', '') %}
                        {% if overall and not is_rubric %}
                        <div class="overall-feedback mt-4">
                            <h6><i class="bi bi-chat-quote me-2"></i>Overall Comments</h6>
                            <div class="alert alert-secondary">
                                {{ overall }}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Teacher Notes -->
                        <div class="teacher-section mt-4 p-3 bg-light rounded">
                            <h6 class="text-success"><i class="bi bi-person-check me-2"></i>Reviewed by Teacher</h6>
                            <small class="text-muted">
                                {% if submission.reviewed_at %}
                                Reviewed on {{ submission.reviewed_at.strftime('%d %B %Y') }}
                                {% endif %}
                            </small>
                        </div>
                    {% else %}
                        {# Feedback not yet sent by teacher #}
                        <div class="text-center py-5">
                            <i class="bi bi-hourglass-split text-warning" style="font-size: 4rem;"></i>
                            <h5 class="mt-3">Awaiting Feedback</h5>
                            <p class="text-muted mb-0">
                                Your submission has been received and is being reviewed by your teacher.
                                <br>You will be notified when feedback is available.
                            </p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Download Button -->
                {% if submission.get('feedback_sent', False) %}
                <div class="card-footer">
                    <a href="{{ url_for('download_student_feedback_pdf', submission_id=submission.submission_id) }}" 
                       class="btn btn-primary w-100">
                        <i class="bi bi-download me-1"></i>Download Feedback PDF
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Rubric: Resubmit new version (Version 2, 3...) -->
    {% if assignment.marking_type == 'rubric' and submission.get('feedback_sent', False) %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Submit a new version for feedback</h5>
                    <small>Upload a revised essay (PDF or images) to get another round of feedback. Each version is tracked (Version 2, 3...).</small>
                </div>
                <div class="card-body">
                    <form id="resubmit-rubric-form" enctype="multipart/form-data">
                        <input type="hidden" name="assignment_id" value="{{ assignment.assignment_id }}">
                        <div class="mb-3">
                            <label class="form-label">Upload your revised assignment (PDF or images)</label>
                            <input type="file" class="form-control" name="files" id="resubmit-files" accept=".pdf,image/*" multiple required>
                            <small class="text-muted">You can select one PDF or multiple image files.</small>
                        </div>
                        <button type="submit" class="btn btn-primary" id="btn-resubmit-rubric">
                            <i class="bi bi-upload me-1"></i>Submit new version
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Annotation Editor Modal (fullscreen) -->
    {% if submission.file_ids %}
    <div class="modal fade" id="annotationModal" tabindex="-1" aria-labelledby="annotationModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header py-2 border-bottom">
                    <h5 class="modal-title" id="annotationModalLabel"><i class="bi bi-pencil-fill me-2"></i>Annotate your submission</h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" id="annotator-prev-page" disabled><i class="bi bi-chevron-left"></i></button>
                            <span class="btn btn-outline-secondary disabled" id="annotator-page-label">Page 1 / 1</span>
                            <button type="button" class="btn btn-outline-secondary" id="annotator-next-page"><i class="bi bi-chevron-right"></i></button>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="annotator-undo" title="Undo (Ctrl+Z)"><i class="bi bi-arrow-counterclockwise"></i></button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="annotator-redo" title="Redo (Ctrl+Y)"><i class="bi bi-arrow-clockwise"></i></button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="annotator-clear-page" title="Clear this page"><i class="bi bi-trash3 me-1"></i>Clear</button>
                        <button type="button" class="btn btn-success btn-sm" id="annotator-save-close"><i class="bi bi-check-lg me-1"></i>Save & Close</button>
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
                <div class="modal-body p-0 d-flex overflow-hidden" style="height: calc(100vh - 60px);">
                    <div class="annotator-toolbar border-end bg-light d-flex flex-column align-items-center py-2" style="width: 56px;">
                        <button type="button" class="tool-btn btn btn-outline-secondary active" data-tool="draw" title="Draw (D)"><i class="bi bi-pencil-fill"></i></button>
                        <button type="button" class="tool-btn btn btn-outline-secondary" data-tool="highlight" title="Highlight (H)"><i class="bi bi-highlighter"></i></button>
                        <button type="button" class="tool-btn btn btn-outline-secondary" data-tool="eraser" title="Eraser (E)"><i class="bi bi-eraser-fill"></i></button>
                        <hr class="my-1 w-75">
                        <button type="button" class="tool-btn btn btn-outline-secondary" data-tool="text" title="Text (T)"><i class="bi bi-fonts"></i></button>
                        <button type="button" class="tool-btn btn btn-outline-secondary" data-tool="arrow" title="Arrow (A)"><i class="bi bi-arrow-up-right"></i></button>
                        <button type="button" class="tool-btn btn btn-outline-secondary" data-tool="rect" title="Rectangle (R)"><i class="bi bi-square"></i></button>
                        <button type="button" class="tool-btn btn btn-outline-secondary" data-tool="circle" title="Circle (C)"><i class="bi bi-circle"></i></button>
                        <hr class="my-1 w-75">
                        <button type="button" class="tool-btn btn btn-outline-secondary" data-tool="select" title="Select (V)"><i class="bi bi-cursor"></i></button>
                        <div class="dropdown mt-2">
                            <button class="btn btn-outline-secondary btn-sm py-1 px-2" id="annotator-color-toggle" title="Color" data-bs-toggle="dropdown">
                                <i class="bi bi-palette-fill"></i>
                                <span class="d-inline-block rounded-circle border ms-1" id="annotator-color-dot" style="width:10px;height:10px;background:#0d6efd;"></span>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end p-2" id="annotator-color-panel">
                                <div class="color-grid-annotator d-flex flex-wrap gap-1" id="annotator-color-grid"></div>
                                <div class="mt-2 small">Brush size</div>
                                <input type="range" class="form-range" min="1" max="20" value="3" id="annotator-brush-size">
                                <span class="small" id="annotator-brush-size-val">3</span>
                                <div class="mt-2 small">Opacity</div>
                                <input type="range" class="form-range" min="10" max="100" value="100" id="annotator-opacity">
                                <span class="small" id="annotator-opacity-val">100%</span>
                            </div>
                        </div>
                    </div>
                    <div class="annotator-canvas-area flex-grow-1 overflow-auto bg-dark bg-opacity-10 d-flex align-items-start justify-content-center p-3" id="annotator-canvas-area">
                        <div class="canvas-wrap bg-white shadow" id="annotator-canvas-wrap">
                            <canvas id="annotationCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.score-box {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 15px 20px;
    border-radius: 12px;
    text-align: center;
}

.score-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #28a745;
    line-height: 1;
}

.score-total {
    font-size: 1.2rem;
    color: #6c757d;
}

.score-label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 5px;
}

.feedback-table {
    font-size: 0.9rem;
}

.feedback-table td {
    vertical-align: top;
}

.table-success {
    background-color: rgba(40, 167, 69, 0.1) !important;
}

.table-danger {
    background-color: rgba(220, 53, 69, 0.1) !important;
}

.table-warning {
    background-color: rgba(255, 193, 7, 0.15) !important;
}

.answer-key-text {
    white-space: pre-wrap;
    word-break: break-word;
    color: #198754;
    font-weight: 500;
}

/* Annotation editor */
.annotator-toolbar .tool-btn { width: 40px; height: 40px; padding: 0; }
.annotator-toolbar .tool-btn.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
.color-grid-annotator .color-swatch { width: 24px; height: 24px; border-radius: 4px; border: 2px solid transparent; cursor: pointer; }
.color-grid-annotator .color-swatch.active { border-color: #212529; box-shadow: 0 0 0 1px #fff; }
#annotator-canvas-area.drawing { touch-action: none; }
</style>
{% endblock %}

{% block scripts %}
{% if submission.file_ids %}
<script>
(function() {
    var submissionId = "{{ submission.submission_id }}";
    var pageCount = {{ submission.page_count or (submission.file_ids|length) or 1 }};
    var fileType = "{{ submission.file_type }}";
    var currentPage = 0;

    function submissionUpdatePageView() {
        var ind = document.getElementById('submission-page-indicator');
        var prevBtn = document.getElementById('submission-prev-btn');
        var nextBtn = document.getElementById('submission-next-btn');
        if (ind) ind.textContent = 'Page ' + (currentPage + 1) + '/' + pageCount;
        if (prevBtn) prevBtn.disabled = currentPage === 0;
        if (nextBtn) nextBtn.disabled = currentPage >= pageCount - 1;
        var base = '/student/submission/' + submissionId + '/file/';
        if (fileType === 'pdf' && pageCount > 1) {
            var pdfImg = document.getElementById('submission-pdf-page-image');
            if (pdfImg) pdfImg.src = base + '0?as_image=1&pdf_page=' + currentPage;
        } else if (fileType === 'pdf') {
            var iframe = document.getElementById('submission-pdf-viewer');
            if (iframe) iframe.src = base + currentPage;
        } else {
            var img = document.getElementById('submission-page-image');
            if (img) img.src = base + currentPage;
        }
    }
    function submissionNextPage() {
        if (currentPage < pageCount - 1) { currentPage++; submissionUpdatePageView(); }
    }
    function submissionPrevPage() {
        if (currentPage > 0) { currentPage--; submissionUpdatePageView(); }
    }

    var submissionZoom = 1;
    var submissionZoomStep = 0.25;
    var submissionMaxZoom = 3;
    var submissionMinZoom = 0.5;
    function submissionZoomIn() {
        if (submissionZoom < submissionMaxZoom) { submissionZoom += submissionZoomStep; submissionApplyZoom(); }
    }
    function submissionZoomOut() {
        if (submissionZoom > submissionMinZoom) { submissionZoom -= submissionZoomStep; submissionApplyZoom(); }
    }
    function submissionApplyZoom() {
        var img = document.getElementById('submission-page-image') || document.getElementById('submission-pdf-page-image');
        if (img) {
            img.style.transform = 'scale(' + submissionZoom + ')';
            img.style.transformOrigin = 'top center';
        }
    }

    var submissionFullscreen = false;
    function submissionToggleFullscreen() {
        var submissionBody = document.getElementById('submission-body');
        var fullscreenBtn = document.getElementById('submission-fullscreen-btn');
        if (!document.fullscreenElement) {
            submissionBody.requestFullscreen().then(function() {
                submissionBody.style.height = '100vh';
                submissionBody.style.background = '#1a1a1a';
                if (fullscreenBtn) fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
                submissionFullscreen = true;
            }).catch(function() {
                submissionExpandView();
            });
        } else {
            document.exitFullscreen().then(function() { submissionRestoreView(); });
        }
    }
    function submissionExpandView() {
        var submissionPanel = document.getElementById('submission-panel');
        var feedbackPanel = document.getElementById('feedback-panel');
        var fullscreenBtn = document.getElementById('submission-fullscreen-btn');
        if (submissionPanel) submissionPanel.className = 'col-12 mb-4';
        if (feedbackPanel) feedbackPanel.style.display = 'none';
        var body = document.getElementById('submission-body');
        if (body) { body.style.height = '90vh'; }
        if (fullscreenBtn) fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
        submissionFullscreen = true;
    }
    function submissionRestoreView() {
        var submissionPanel = document.getElementById('submission-panel');
        var feedbackPanel = document.getElementById('feedback-panel');
        var fullscreenBtn = document.getElementById('submission-fullscreen-btn');
        var submissionBody = document.getElementById('submission-body');
        if (submissionPanel) submissionPanel.className = 'col-lg-4 mb-4';
        if (feedbackPanel) feedbackPanel.style.display = '';
        if (submissionBody) {
            submissionBody.style.height = 'calc(100vh - 350px)';
            submissionBody.style.background = '#f0f0f0';
        }
        if (fullscreenBtn) fullscreenBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
        submissionFullscreen = false;
    }
    document.addEventListener('fullscreenchange', function() {
        if (!document.fullscreenElement && submissionFullscreen) submissionRestoreView();
    });

    // Expose to window for onclick (in case script order varies)
    window.submissionNextPage = submissionNextPage;
    window.submissionPrevPage = submissionPrevPage;
    window.submissionZoomIn = submissionZoomIn;
    window.submissionZoomOut = submissionZoomOut;
    window.submissionToggleFullscreen = submissionToggleFullscreen;

    // Bind buttons directly so controls work even if onclick fails (e.g. CSP, old cache)
    function bindControls() {
        var prevBtn = document.getElementById('submission-prev-btn');
        var nextBtn = document.getElementById('submission-next-btn');
        var zoomInBtn = document.getElementById('submission-zoom-in-btn');
        var zoomOutBtn = document.getElementById('submission-zoom-out-btn');
        var fullscreenBtn = document.getElementById('submission-fullscreen-btn');
        if (prevBtn) prevBtn.addEventListener('click', submissionPrevPage);
        if (nextBtn) nextBtn.addEventListener('click', submissionNextPage);
        if (zoomInBtn) zoomInBtn.addEventListener('click', submissionZoomIn);
        if (zoomOutBtn) zoomOutBtn.addEventListener('click', submissionZoomOut);
        if (fullscreenBtn) fullscreenBtn.addEventListener('click', submissionToggleFullscreen);
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bindControls);
    } else {
        bindControls();
    }
})();
</script>
{% endif %}
<script>
(function() {
    // Send Corrections / Challenge
    var btnSend = document.getElementById('btn-send-corrections');
    if (btnSend && !btnSend.disabled) {
        btnSend.addEventListener('click', function() {
            var submissionId = this.getAttribute('data-submission-id');
            if (!submissionId) return;
            var payload = { questions: {}, criteria: {}, errors: [] };
            // Standard: correction_q1, correction_q2, ...
            document.querySelectorAll('.correction-input[name^="correction_q"]').forEach(function(t) {
                var num = (t.getAttribute('name') || '').replace('correction_q', '');
                if (num) payload.questions[num] = (t.value || '').trim();
            });
            // Rubric criteria: .rubric-criterion[data-criterion]
            document.querySelectorAll('.correction-input.rubric-criterion').forEach(function(t) {
                var name = t.getAttribute('data-criterion');
                if (name) payload.criteria[name] = (t.value || '').trim();
            });
            // Rubric errors: .rubric-error[data-error-index]
            document.querySelectorAll('.correction-input.rubric-error').forEach(function(t) {
                var idx = parseInt(t.getAttribute('data-error-index'), 10);
                if (!isNaN(idx)) {
                    while (payload.errors.length <= idx) payload.errors.push('');
                    payload.errors[idx] = (t.value || '').trim();
                }
            });
            btnSend.disabled = true;
            btnSend.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
            fetch('/submissions/' + submissionId + '/send-corrections', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify(payload)
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.success) {
                    window.location.reload();
                } else {
                    btnSend.disabled = false;
                    btnSend.innerHTML = '<i class="bi bi-send me-1"></i>Send Corrections / Challenge';
                    alert(data.error || 'Failed to send.');
                }
            }).catch(function() {
                btnSend.disabled = false;
                btnSend.innerHTML = '<i class="bi bi-send me-1"></i>Send Corrections / Challenge';
                alert('Network error. Please try again.');
            });
        });
    }

    // Rubric resubmit (new version)
    var resubmitForm = document.getElementById('resubmit-rubric-form');
    if (resubmitForm) {
        resubmitForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var files = document.getElementById('resubmit-files');
            if (!files || !files.files || files.files.length === 0) {
                alert('Please select at least one file (PDF or images).');
                return;
            }
            var formData = new FormData();
            formData.append('assignment_id', resubmitForm.querySelector('input[name="assignment_id"]').value);
            formData.append('file_type', files.files[0].name.toLowerCase().endsWith('.pdf') ? 'pdf' : 'images');
            for (var i = 0; i < files.files.length; i++) formData.append('files', files.files[i]);
            formData.append('is_rubric_resubmit', '1');
            var btn = document.getElementById('btn-resubmit-rubric');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Submitting...'; }
            fetch('/student/submit', {
                method: 'POST',
                body: formData
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.success && data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-upload me-1"></i>Submit new version'; }
                    alert(data.error || 'Submission failed.');
                }
            }).catch(function() {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-upload me-1"></i>Submit new version'; }
                alert('Network error. Please try again.');
            });
        });
    }
})();
</script>
{% if submission.file_ids %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
(function() {
    var submissionId = "{{ submission.submission_id }}";
    var totalPages = {{ submission.page_count or (submission.file_ids|length) or 1 }};
    var fileType = "{{ submission.file_type }}";
    var savedAnnotations = {{ submission.get('student_annotations', {}) | tojson }};

    var COLORS = ['#0d6efd','#dc3545','#198754','#ffc107','#6f42c1','#fd7e14','#20c997','#e83e8c','#fff','#adb5bd','#495057','#212529'];
    var currentPage = 0, currentTool = 'draw', currentColor = COLORS[0], brushSize = 3, brushOpacity = 1;
    var canvas, pageAnnotations = {}, undoStack = [], redoStack = [], isDrawingShape = false, shapeStart = null, tempShape = null;

    function getPageImageUrl(pageNum) {
        if (fileType === 'pdf' && totalPages > 1)
            return '/student/submission/' + submissionId + '/file/0?as_image=1&pdf_page=' + pageNum;
        return '/student/submission/' + submissionId + '/file/' + pageNum;
    }

    function loadPageBackground(pageNum, done) {
        var url = getPageImageUrl(pageNum);
        fabric.Image.fromURL(url, function(img) {
            if (!canvas) return;
            var w = img.getScaledWidth(), h = img.getScaledHeight();
            canvas.setDimensions({ width: w, height: h });
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), { scaleX: 1, scaleY: 1 });
            canvas.renderAll();
            if (typeof done === 'function') done();
        }, { crossOrigin: 'anonymous' });
    }

    function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn[data-tool]').forEach(function(b) {
            b.classList.toggle('active', b.getAttribute('data-tool') === tool);
        });
        canvas.isDrawingMode = false;
        canvas.selection = false;
        canvas.defaultCursor = 'crosshair';
        canvas.hoverCursor = 'crosshair';
        isDrawingShape = false;
        canvas.off('mouse:down', onShapeMouseDown);
        canvas.off('mouse:move', onShapeMouseMove);
        canvas.off('mouse:up', onShapeMouseUp);
        canvas.off('mouse:down', onTextClick);

        if (tool === 'draw') {
            canvas.isDrawingMode = true;
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.color = currentColor;
            canvas.freeDrawingBrush.width = brushSize;
            canvas.freeDrawingBrush.globalCompositeOperation = 'source-over';
            canvas.freeDrawingBrush.opacity = brushOpacity;
        } else if (tool === 'highlight') {
            canvas.isDrawingMode = true;
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.color = '#fbbf24';
            canvas.freeDrawingBrush.width = 20;
            canvas.freeDrawingBrush.globalCompositeOperation = 'multiply';
            canvas.freeDrawingBrush.opacity = 0.35;
        } else if (tool === 'eraser') {
            canvas.isDrawingMode = true;
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.color = '#ffffff';
            canvas.freeDrawingBrush.width = 20;
            canvas.freeDrawingBrush.globalCompositeOperation = 'source-over';
        } else if (tool === 'text') {
            canvas.defaultCursor = 'text';
            canvas.on('mouse:down', onTextClick);
        } else if (tool === 'select') {
            canvas.selection = true;
            canvas.defaultCursor = 'default';
            canvas.hoverCursor = 'move';
            canvas.forEachObject(function(o) {
                if (!o.data || !o.data.isBackground) {
                    o.selectable = true;
                    o.evented = true;
                    o.hasControls = true;
                    o.hasBorders = true;
                    o.borderColor = '#0d6efd';
                    o.cornerColor = '#0d6efd';
                }
            });
        } else if (['arrow','rect','circle'].indexOf(tool) !== -1) {
            canvas.on('mouse:down', onShapeMouseDown);
            canvas.on('mouse:move', onShapeMouseMove);
            canvas.on('mouse:up', onShapeMouseUp);
        }

        if (tool !== 'select' && tool !== 'text') {
            canvas.forEachObject(function(o) { o.selectable = false; o.evented = false; });
        } else if (tool === 'text') {
            canvas.forEachObject(function(o) {
                if (o.data && o.data.isBackground) { o.selectable = false; o.evented = false; }
                else if (o.type === 'i-text') { o.selectable = true; o.evented = true; }
                else { o.selectable = false; o.evented = false; }
            });
        }
        document.getElementById('annotator-canvas-area').classList.toggle('drawing', ['draw','highlight','eraser'].indexOf(tool) !== -1);
    }

    function onTextClick(opt) {
        if (currentTool !== 'text') return;
        if (opt.target && opt.target.type === 'i-text' && (!opt.target.data || !opt.target.data.isBackground)) {
            canvas.setActiveObject(opt.target);
            opt.target.enterEditing();
            return;
        }
        canvas.off('mouse:down', onTextClick);
        var pointer = canvas.getPointer(opt.e);
        var text = new fabric.IText('Type here...', {
            left: pointer.x, top: pointer.y, fontSize: 16, fill: currentColor,
            selectable: true, evented: true, hasControls: true, hasBorders: true,
            borderColor: '#0d6efd', cornerColor: '#0d6efd', cornerStyle: 'circle', cornerSize: 8
        });
        canvas.add(text);
        canvas.setActiveObject(text);
        text.enterEditing();
        text.selectAll();
        text.on('editing:exited', function() {
            if (!text.text || text.text.trim() === '') canvas.remove(text);
            canvas.renderAll();
            if (currentTool === 'text') setTimeout(function() { canvas.on('mouse:down', onTextClick); }, 150);
        });
    }

    function onShapeMouseDown(opt) {
        if (['arrow','rect','circle'].indexOf(currentTool) === -1) return;
        isDrawingShape = true;
        var p = canvas.getPointer(opt.e);
        shapeStart = { x: p.x, y: p.y };
        if (currentTool === 'rect') {
            tempShape = new fabric.Rect({ left: p.x, top: p.y, width: 0, height: 0, fill: 'transparent', stroke: currentColor, strokeWidth: brushSize, selectable: false });
        } else if (currentTool === 'circle') {
            tempShape = new fabric.Ellipse({ left: p.x, top: p.y, rx: 0, ry: 0, fill: 'transparent', stroke: currentColor, strokeWidth: brushSize, selectable: false });
        } else if (currentTool === 'arrow') {
            tempShape = new fabric.Line([p.x, p.y, p.x, p.y], { stroke: currentColor, strokeWidth: brushSize, selectable: false });
        }
        if (tempShape) canvas.add(tempShape);
    }
    function onShapeMouseMove(opt) {
        if (!isDrawingShape || !tempShape) return;
        var p = canvas.getPointer(opt.e);
        if (currentTool === 'rect') {
            var w = p.x - shapeStart.x, h = p.y - shapeStart.y;
            tempShape.set({ left: w > 0 ? shapeStart.x : p.x, top: h > 0 ? shapeStart.y : p.y, width: Math.abs(w), height: Math.abs(h) });
        } else if (currentTool === 'circle') {
            var rx = Math.abs(p.x - shapeStart.x) / 2, ry = Math.abs(p.y - shapeStart.y) / 2;
            tempShape.set({ left: Math.min(shapeStart.x, p.x), top: Math.min(shapeStart.y, p.y), rx: rx, ry: ry });
        } else if (currentTool === 'arrow') {
            tempShape.set({ x2: p.x, y2: p.y });
        }
        canvas.renderAll();
    }
    function onShapeMouseUp() {
        if (!isDrawingShape) return;
        isDrawingShape = false;
        if (currentTool === 'arrow' && tempShape) {
            var x1 = tempShape.x1, y1 = tempShape.y1, x2 = tempShape.x2, y2 = tempShape.y2;
            var angle = Math.atan2(y2 - y1, x2 - x1), headLen = 14;
            var head = new fabric.Polygon([
                { x: x2, y: y2 },
                { x: x2 - headLen * Math.cos(angle - Math.PI / 6), y: y2 - headLen * Math.sin(angle - Math.PI / 6) },
                { x: x2 - headLen * Math.cos(angle + Math.PI / 6), y: y2 - headLen * Math.sin(angle + Math.PI / 6) }
            ], { fill: currentColor, selectable: false });
            canvas.add(head);
        }
        tempShape = null;
        canvas.renderAll();
    }

    function pushUndo() {
        undoStack.push(canvas.toJSON(['data']));
        if (undoStack.length > 50) undoStack.shift();
    }
    function undoAction() {
        if (undoStack.length <= 1) return;
        redoStack.push(undoStack.pop());
        var state = undoStack[undoStack.length - 1];
        canvas.loadFromJSON(state, function() { canvas.renderAll(); setTool(currentTool); });
    }
    function redoAction() {
        if (redoStack.length === 0) return;
        var state = redoStack.pop();
        undoStack.push(state);
        canvas.loadFromJSON(state, function() { canvas.renderAll(); setTool(currentTool); });
    }
    function clearPage() {
        if (!confirm('Clear all annotations on this page?')) return;
        var bg = canvas.backgroundImage;
        canvas.clear();
        canvas.setBackgroundImage(bg, canvas.renderAll.bind(canvas));
        canvas.renderAll();
        pushUndo();
    }

    function updatePageLabel() {
        var el = document.getElementById('annotator-page-label');
        if (el) el.textContent = 'Page ' + (currentPage + 1) + ' / ' + totalPages;
        var prev = document.getElementById('annotator-prev-page');
        var next = document.getElementById('annotator-next-page');
        if (prev) prev.disabled = currentPage === 0;
        if (next) next.disabled = currentPage >= totalPages - 1;
    }
    function changePage(delta) {
        pageAnnotations[currentPage] = canvas.toJSON(['data']);
        currentPage += delta;
        currentPage = Math.max(0, Math.min(totalPages - 1, currentPage));
        updatePageLabel();
        loadPageBackground(currentPage, function() {
            if (pageAnnotations[currentPage]) {
                canvas.loadFromJSON(pageAnnotations[currentPage], function() { canvas.renderAll(); setTool(currentTool); });
            } else {
                canvas.getObjects().forEach(function(o) { canvas.remove(o); });
                canvas.renderAll();
            }
            undoStack = [canvas.toJSON(['data'])];
            redoStack = [];
        });
    }

    function showAnnotatorToast(msg, type) {
        var container = document.querySelector('.toast-container');
        if (!container) return;
        var toastEl = document.getElementById('notification-toast');
        if (toastEl) {
            var title = toastEl.querySelector('#toast-title');
            var body = toastEl.querySelector('#toast-body');
            if (title) title.textContent = type === 'success' ? 'Saved' : 'Info';
            if (body) body.textContent = msg;
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    }

    document.getElementById('btn-open-annotator').addEventListener('click', function() {
        var modal = new bootstrap.Modal(document.getElementById('annotationModal'));
        modal.show();
    });

    document.getElementById('annotationModal').addEventListener('shown.bs.modal', function() {
        pageAnnotations = JSON.parse(JSON.stringify(savedAnnotations));
        if (Object.keys(pageAnnotations).length === 0) pageAnnotations = {};
        var wrap = document.getElementById('annotator-canvas-wrap');
        wrap.innerHTML = '<canvas id="annotationCanvas"></canvas>';
        canvas = new fabric.Canvas('annotationCanvas', { width: 800, height: 1056, backgroundColor: '#fff', isDrawingMode: true, selection: false });
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        canvas.freeDrawingBrush.color = currentColor;
        canvas.freeDrawingBrush.width = brushSize;
        canvas.freeDrawingBrush.opacity = brushOpacity;
        canvas.on('object:added', function() { pushUndo(); redoStack = []; });

        var grid = document.getElementById('annotator-color-grid');
        if (grid) {
            grid.innerHTML = '';
            COLORS.forEach(function(c) {
                var el = document.createElement('div');
                el.className = 'color-swatch' + (c === currentColor ? ' active' : '');
                el.style.background = c;
                if (c === '#fff' || c === '#ffffff') el.style.border = '1px solid #dee2e6';
                el.onclick = function() {
                    currentColor = c;
                    document.querySelectorAll('#annotator-color-grid .color-swatch').forEach(function(s) { s.classList.remove('active'); });
                    this.classList.add('active');
                    document.getElementById('annotator-color-dot').style.background = c;
                    if (canvas.freeDrawingBrush) canvas.freeDrawingBrush.color = c;
                };
                grid.appendChild(el);
            });
        }
        document.getElementById('annotator-brush-size').addEventListener('input', function() {
            brushSize = parseInt(this.value, 10);
            document.getElementById('annotator-brush-size-val').textContent = brushSize;
            if (canvas.freeDrawingBrush) canvas.freeDrawingBrush.width = brushSize;
        });
        document.getElementById('annotator-opacity').addEventListener('input', function() {
            brushOpacity = parseInt(this.value, 10) / 100;
            document.getElementById('annotator-opacity-val').textContent = this.value + '%';
            if (canvas.freeDrawingBrush) canvas.freeDrawingBrush.opacity = brushOpacity;
        });

        currentPage = 0;
        updatePageLabel();
        loadPageBackground(0, function() {
            if (pageAnnotations['0'] || pageAnnotations[0]) {
                var data = pageAnnotations['0'] || pageAnnotations[0];
                canvas.loadFromJSON(data, function() { canvas.renderAll(); setTool(currentTool); });
            }
            undoStack = [canvas.toJSON(['data'])];
            redoStack = [];
            setTool('draw');
        });
    });

    document.querySelectorAll('.tool-btn[data-tool]').forEach(function(btn) {
        btn.addEventListener('click', function() { setTool(this.getAttribute('data-tool')); });
    });
    document.getElementById('annotator-prev-page').addEventListener('click', function() { changePage(-1); });
    document.getElementById('annotator-next-page').addEventListener('click', function() { changePage(1); });
    document.getElementById('annotator-undo').addEventListener('click', undoAction);
    document.getElementById('annotator-redo').addEventListener('click', redoAction);
    document.getElementById('annotator-clear-page').addEventListener('click', clearPage);

    document.getElementById('annotator-save-close').addEventListener('click', function() {
        pageAnnotations[currentPage] = canvas.toJSON(['data']);
        var btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
        fetch('/student/submission/' + submissionId + '/save-annotations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({ annotations: pageAnnotations })
        }).then(function(r) { return r.json(); }).then(function(data) {
            if (!data.success) throw new Error(data.error || 'Save failed');
            var pageImages = {};
            var idx = 0;
            function next() {
                if (idx >= totalPages) {
                    return fetch('/student/submission/' + submissionId + '/export-annotated', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify({ page_images: pageImages })
                    }).then(function(r) { return r.json(); });
                }
                var pageNum = idx;
                idx++;
                loadPageBackground(pageNum, function() {
                    var data = pageAnnotations[pageNum] || pageAnnotations[String(pageNum)];
                    if (data) {
                        canvas.loadFromJSON(data, function() {
                            pageImages[pageNum] = canvas.toDataURL({ format: 'png', quality: 1 });
                            canvas.renderAll();
                            setTimeout(next, 0);
                        });
                    } else {
                        canvas.getObjects().forEach(function(o) { canvas.remove(o); });
                        canvas.renderAll();
                        pageImages[pageNum] = canvas.toDataURL({ format: 'png', quality: 1 });
                        setTimeout(next, 0);
                    }
                });
            }
            return next();
        }).then(function(r) {
            if (r && !r.success) throw new Error(r.error || 'Export failed');
            bootstrap.Modal.getInstance(document.getElementById('annotationModal')).hide();
            showAnnotatorToast('Annotations saved successfully.', 'success');
            window.location.reload();
        }).catch(function(err) {
            showAnnotatorToast(err.message || 'Save failed.', 'danger');
        }).finally(function() {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save & Close';
        });
    });

    document.addEventListener('keydown', function(e) {
        if (!canvas || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        var active = canvas.getActiveObject();
        if (active && active.isEditing) return;
        if (e.key === 'd' || e.key === 'D') setTool('draw');
        else if (e.key === 'h' || e.key === 'H') setTool('highlight');
        else if (e.key === 'e' || e.key === 'E') setTool('eraser');
        else if (e.key === 't' || e.key === 'T') setTool('text');
        else if (e.key === 'a' || e.key === 'A') setTool('arrow');
        else if (e.key === 'r' || e.key === 'R') setTool('rect');
        else if (e.key === 'c' || e.key === 'C') setTool('circle');
        else if (e.key === 'v' || e.key === 'V') setTool('select');
        else if ((e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey)) { e.preventDefault(); undoAction(); }
        else if ((e.key === 'y' || e.key === 'Y') && (e.ctrlKey || e.metaKey)) { e.preventDefault(); redoAction(); }
        else if (e.key === 'Delete' || (e.key === 'Backspace' && currentTool === 'select')) {
            if (active && !active.isEditing && (!active.data || !active.data.isBackground)) {
                if (active.type === 'activeSelection') {
                    active.forEachObject(function(obj) { if (!obj.data || !obj.data.isBackground) canvas.remove(obj); });
                    canvas.discardActiveObject();
                } else canvas.remove(active);
                canvas.renderAll();
                pushUndo();
            }
        }
    });
})();
</script>
{% endif %}
{% endblock %}
