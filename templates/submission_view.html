{% extends "base.html" %}

{% block title %}Submission Feedback - School Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>School Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('assignments_list') }}">Assignments</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('student_submissions') }}">Submissions</a>
                </li>
            </ul>
            <div class="navbar-nav">
                <span class="navbar-text me-3">{{ session.student_name }}</span>
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student_submissions') }}">My Submissions</a></li>
            <li class="breadcrumb-item active">{{ assignment.title }}{% if submission.get('version') %} (Version {{ submission.version }}){% endif %}</li>
        </ol>
    </nav>
    
    <!-- Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-1">{{ assignment.title }}{% if submission.get('version') %} <span class="text-muted">(Version {{ submission.version }})</span>{% endif %}</h4>
                    <p class="text-muted mb-2">
                        <span class="badge bg-primary me-2">{{ assignment.subject }}</span>
                        Submitted: {{ (submission.submitted_at|sgt).strftime('%d %B %Y, %H:%M') if submission.submitted_at else 'N/A' }} SGT
                    </p>
                    <div>
                        {% if submission.status == 'reviewed' %}
                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Reviewed by Teacher</span>
                        {% elif submission.status == 'ai_reviewed' %}
                        <span class="badge bg-info"><i class="bi bi-robot me-1"></i>AI Reviewed - Awaiting Teacher</span>
                        {% else %}
                        <span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Pending Review</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    {% if submission.get('feedback_sent', False) %}
                    <div class="d-flex flex-wrap gap-2 justify-content-md-end mb-2">
                        <button type="button" class="btn btn-primary" id="btn-send-corrections" 
                                data-submission-id="{{ submission.submission_id }}"
                                {% if submission.get('correction_sent', False) %}disabled title="Already sent"{% endif %}>
                            <i class="bi bi-send me-1"></i>{% if submission.get('correction_sent', False) %}Corrections Sent{% else %}Send Corrections / Challenge{% endif %}
                        </button>
                        {% if submission.get('correction_sent', False) and submission.get('correction_sent_at') %}
                        <small class="text-muted align-self-center">Sent {{ (submission.correction_sent_at|sgt).strftime('%d %b %Y, %H:%M') }} SGT</small>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if submission.get('feedback_sent', False) and submission.get('final_marks') is not none %}
                    <div class="score-box">
                        {% if assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}
                        <div class="score-value">{{ submission.get('final_marks', 0) }}<span class="score-total">/{{ assignment.get('total_marks', 100) }}</span></div>
                        <div class="score-label">Your Score</div>
                        {% set final_marks_num = submission.get('final_marks', 0)|float %}
                        {% set total_marks_num = assignment.get('total_marks', 100)|float %}
                        {% set percentage = (final_marks_num / total_marks_num * 100) if total_marks_num > 0 else 0 %}
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar {% if percentage >= 70 %}bg-success{% elif percentage >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ percentage }}%"></div>
                        </div>
                        <small class="text-muted">{{ "%.1f"|format(percentage) }}%</small>
                        {% else %}
                        {% set final_marks_num = submission.get('final_marks', 0)|float %}
                        {% set total_marks_num = assignment.get('total_marks', 100)|float %}
                        {% set percentage = (final_marks_num / total_marks_num * 100) if total_marks_num > 0 else 0 %}
                        {% if percentage >= 99.9 %}
                        <div class="score-value text-success"><i class="bi bi-check-circle me-1"></i>Correct</div>
                        {% elif percentage <= 0.01 %}
                        <div class="score-value text-danger"><i class="bi bi-x-circle me-1"></i>Incorrect</div>
                        {% else %}
                        <div class="score-value text-warning"><i class="bi bi-dash-circle me-1"></i>Partial correct</div>
                        {% endif %}
                        <div class="score-label">Your Result</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Left: Your Submission (reduced by 1/4 for correction column) -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-earmark me-2"></i>Your Submission</h5>
                    {% if submission.file_ids %}
                    <small class="text-muted">
                        {% if submission.file_type == 'pdf' %}
                        <i class="bi bi-file-pdf me-1"></i>PDF Document
                        {% else %}
                        <i class="bi bi-images me-1"></i>{{ submission.page_count }} page(s)
                        {% endif %}
                    </small>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if submission.file_ids %}
                    <div class="submission-viewer-container" style="height: calc(100vh - 350px); min-height: 320px; overflow: auto; background: #f5f5f5;">
                        {% if submission.file_type == 'pdf' %}
                        <!-- PDF Viewer - Full scrollable document -->
                        <iframe id="submission-viewer" 
                                src="{{ url_for('view_student_submission_file', submission_id=submission.submission_id, file_index=0) }}"
                                style="width: 100%; height: 100%; border: none;"></iframe>
                        {% else %}
                        <!-- Image Viewer - All pages stacked for scrolling -->
                        <div class="image-pages p-3">
                            {% for i in range(submission.page_count or 1) %}
                            <div class="page-container mb-3 {% if i > 0 %}border-top pt-3{% endif %}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted fw-semibold">Page {{ i + 1 }} of {{ submission.page_count }}</small>
                                </div>
                                <img src="{{ url_for('view_student_submission_file', submission_id=submission.submission_id, file_index=i) }}"
                                     style="width: 100%; height: auto; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" 
                                     alt="Submission page {{ i + 1 }}"
                                     loading="lazy">
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-file-earmark-x" style="font-size: 3rem;"></i>
                        <p class="mt-2">No files available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right: Feedback + Your correction/challenge column -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-chat-left-text me-2"></i>Feedback</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% set feedback_sent = submission.get('feedback_sent', False) %}
                    
                    {% if feedback_sent %}
                        {# Only show feedback after teacher has sent it #}
                        {% set ai_feedback = submission.get('ai_feedback', {}) %}
                        {% set teacher_feedback = submission.get('teacher_feedback', {}) %}
                        {% set student_corrections = submission.get('student_corrections', {}) %}
                        {% set correction_sent = submission.get('correction_sent', False) %}
                        {% set questions = ai_feedback.get('questions', []) %}
                        {% set criteria = ai_feedback.get('criteria', []) %}
                        {% set is_rubric = assignment.marking_type == 'rubric' or (criteria and not questions) %}
                        
                        {% if questions %}
                        {% set include_answer_key = submission.get('include_answer_key', False) %}
                        {% set show_marks_column = assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}
                        <!-- Standard: Feedback Table by Question -->
                        <div class="table-responsive">
                            <table class="table table-sm feedback-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;">Q#</th>
                                        {% if include_answer_key %}
                                        <th style="width: 35%;">Answer Key</th>
                                        {% endif %}
                                        <th>Feedback</th>
                                        <th style="width: 70px;">{% if show_marks_column %}Marks{% else %}Result{% endif %}</th>
                                        <th style="width: 22%;">Your correction / challenge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for q in questions %}
                                    {% set teacher_q = teacher_feedback.get('questions', {}).get(q.question_num|string, {}) %}
                                    {% set q_correction = student_corrections.get('questions', {}).get(q.question_num|string, '') %}
                                    {% set marks = teacher_q.get('marks') if teacher_q.get('marks') is not none else q.get('marks_awarded') %}
                                    {% set marks_total_val = (q.marks_total|float) if (q.marks_total and q.marks_total|float > 0) else 1 %}
                                    {% set marks_num = marks|float if marks is not none else None %}
                                    {% set q_pct = (marks_num / marks_total_val * 100) if (marks_num is not none and marks_total_val > 0) else None %}
                                    <tr class="{% if q.is_correct %}table-success{% elif q.is_correct == false %}table-danger{% elif q.needs_review %}table-warning{% endif %}">
                                        <td class="text-center">
                                            <strong>{{ q.question_num }}</strong>
                                            {% if q.is_correct %}
                                            <br><i class="bi bi-check-circle text-success"></i>
                                            {% elif q.is_correct == false %}
                                            <br><i class="bi bi-x-circle text-danger"></i>
                                            {% elif q.needs_review %}
                                            <br><i class="bi bi-question-circle text-warning"></i>
                                            {% endif %}
                                        </td>
                                        {% if include_answer_key %}
                                        <td class="small">
                                            {% set answer_key = teacher_q.get('answer_key') or q.get('correct_answer', '') %}
                                            {% if answer_key %}
                                            <div class="answer-key-text">{{ answer_key }}</div>
                                            {% endif %}
                                            {% if teacher_q.get('answer_key_image') %}
                                            <div class="mt-1">
                                                <img src="{{ teacher_q.get('answer_key_image') }}" class="img-thumbnail" style="max-height: 100px; cursor: pointer;" 
                                                     onclick="window.open(this.src, '_blank')">
                                            </div>
                                            {% endif %}
                                            {% if not answer_key and not teacher_q.get('answer_key_image') %}
                                            <span class="text-muted fst-italic">-</span>
                                            {% endif %}
                                        </td>
                                        {% endif %}
                                        <td>
                                            {% set feedback = teacher_q.get('feedback') or q.get('feedback', '') %}
                                            {% if feedback %}
                                            <p class="mb-1">{{ feedback }}</p>
                                            {% endif %}
                                            
                                            {% if q.get('improvement') %}
                                            <small class="text-info">
                                                <i class="bi bi-lightbulb me-1"></i>{{ q.improvement }}
                                            </small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if show_marks_column %}
                                            {% if marks is not none %}
                                            <span class="badge {% if marks_num == marks_total_val %}bg-success{% elif marks_num and marks_num > 0 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                {{ marks }}/{{ q.marks_total or '?' }}
                                            </span>
                                            {% else %}
                                            <span class="badge bg-secondary">?/{{ q.marks_total or '?' }}</span>
                                            {% endif %}
                                            {% else %}
                                            {% if q_pct is not none %}
                                            {% if q_pct >= 99.9 %}
                                            <span class="badge bg-success">Correct</span>
                                            {% elif q_pct <= 0.01 %}
                                            <span class="badge bg-danger">Incorrect</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Partial correct</span>
                                            {% endif %}
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                            {% endif %}
                                        </td>
                                        <td class="correction-cell">
                                            {% if correction_sent %}
                                            <div class="small text-muted">{{ q_correction or '—' }}</div>
                                            {% else %}
                                            <textarea class="form-control form-control-sm correction-input" name="correction_q{{ q.question_num }}" rows="2" placeholder="Your correction or challenge...">{{ q_correction }}</textarea>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% elif is_rubric and criteria %}
                        <!-- Rubric: same structure as teacher review -->
                        <h6 class="mb-2"><i class="bi bi-list-check me-2"></i>Rubric Criteria Assessment</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered feedback-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 12%;">Criterion</th>
                                        <th style="width: 28%;">Reasoning for Mark</th>
                                        <th style="width: 28%;">Feedback / Area for Improvement</th>
                                        <th style="width: 12%;">Marks</th>
                                        <th style="width: 20%;">Your correction / challenge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for criterion in criteria %}
                                    {% set teacher_c = teacher_feedback.get('criteria', {}).get(criterion.name|string, {}) %}
                                    {% set c_correction = student_corrections.get('criteria', {}).get(criterion.name|string, '') %}
                                    <tr>
                                        <td class="fw-bold">{{ criterion.name }}</td>
                                        <td class="small">
                                            {{ teacher_c.get('reasoning') or criterion.reasoning or '—' }}
                                        </td>
                                        <td class="small">
                                            {{ teacher_c.get('afi') or criterion.afi or '—' }}
                                        </td>
                                        <td class="text-center">
                                            {% set m = teacher_c.get('marks') if teacher_c.get('marks') is not none else criterion.marks_awarded %}
                                            {% set mx = teacher_c.get('max_marks') or criterion.max_marks or 10 %}
                                            {% if m is not none %}
                                            <span class="badge bg-primary">{{ m }}/{{ mx }}</span>
                                            {% else %}
                                            <span class="text-muted">—/{{ mx }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="correction-cell">
                                            {% if correction_sent %}
                                            <div class="small text-muted">{{ c_correction or '—' }}</div>
                                            {% else %}
                                            <textarea class="form-control form-control-sm correction-input rubric-criterion" data-criterion="{{ criterion.name }}" rows="2" placeholder="Your correction or challenge...">{{ c_correction }}</textarea>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td class="fw-bold">Overall</td>
                                        <td colspan="2">
                                            {{ teacher_feedback.get('overall_feedback') or ai_feedback.get('overall_feedback') or '—' }}
                                        </td>
                                        <td class="text-center fw-bold">
                                            {{ submission.get('teacher_feedback', {}).get('total_marks') or ai_feedback.total_marks or '—' }}/{{ assignment.total_marks or 100 }}
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% set display_errors = teacher_feedback.get('errors') or ai_feedback.get('errors') or [] %}
                        {% set errors_corrections = student_corrections.get('errors', []) %}
                        {% if display_errors %}
                        <h6 class="mt-4 mb-2"><i class="bi bi-exclamation-triangle me-2"></i>Detailed Corrections</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 12%;">Location</th>
                                        <th style="width: 20%;">Error</th>
                                        <th style="width: 24%;">Suggested Correction</th>
                                        <th style="width: 24%;">Feedback</th>
                                        <th style="width: 20%;">Your correction / challenge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for err in display_errors %}
                                    {% set err_idx = loop.index0 %}
                                    {% set err_correction_raw = errors_corrections[err_idx] if err_idx < errors_corrections|length else '' %}
                                    {% set err_correction_text = err_correction_raw.get('text', err_correction_raw) if err_correction_raw is mapping else err_correction_raw %}
                                    <tr>
                                        <td class="small">{{ err.location or '—' }}</td>
                                        <td class="small">{{ err.error or '—' }}</td>
                                        <td class="small">{{ err.correction or '—' }}</td>
                                        <td class="small">{{ err.feedback or '—' }}</td>
                                        <td class="correction-cell">
                                            {% if correction_sent %}
                                            <div class="small text-muted">{{ err_correction_text or '—' }}</div>
                                            {% else %}
                                            <textarea class="form-control form-control-sm correction-input rubric-error" data-error-index="{{ err_idx }}" rows="2" placeholder="Your correction or challenge...">{{ err_correction_text }}</textarea>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        <!-- Overall Feedback (standard view only; rubric already has overall in table) -->
                        {% set overall = teacher_feedback.get('overall_feedback') or ai_feedback.get('overall_feedback', '') %}
                        {% if overall and not is_rubric %}
                        <div class="overall-feedback mt-4">
                            <h6><i class="bi bi-chat-quote me-2"></i>Overall Comments</h6>
                            <div class="alert alert-secondary">
                                {{ overall }}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Teacher Notes -->
                        <div class="teacher-section mt-4 p-3 bg-light rounded">
                            <h6 class="text-success"><i class="bi bi-person-check me-2"></i>Reviewed by Teacher</h6>
                            <small class="text-muted">
                                {% if submission.reviewed_at %}
                                Reviewed on {{ submission.reviewed_at.strftime('%d %B %Y') }}
                                {% endif %}
                            </small>
                        </div>
                    {% else %}
                        {# Feedback not yet sent by teacher #}
                        <div class="text-center py-5">
                            <i class="bi bi-hourglass-split text-warning" style="font-size: 4rem;"></i>
                            <h5 class="mt-3">Awaiting Feedback</h5>
                            <p class="text-muted mb-0">
                                Your submission has been received and is being reviewed by your teacher.
                                <br>You will be notified when feedback is available.
                            </p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Download Button -->
                {% if submission.get('feedback_sent', False) %}
                <div class="card-footer">
                    <a href="{{ url_for('download_student_feedback_pdf', submission_id=submission.submission_id) }}" 
                       class="btn btn-primary w-100">
                        <i class="bi bi-download me-1"></i>Download Feedback PDF
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Rubric: Resubmit new version (Version 2, 3...) -->
    {% if assignment.marking_type == 'rubric' and submission.get('feedback_sent', False) %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Submit a new version for feedback</h5>
                    <small>Upload a revised essay (PDF or images) to get another round of feedback. Each version is tracked (Version 2, 3...).</small>
                </div>
                <div class="card-body">
                    <form id="resubmit-rubric-form" enctype="multipart/form-data">
                        <input type="hidden" name="assignment_id" value="{{ assignment.assignment_id }}">
                        <div class="mb-3">
                            <label class="form-label">Upload your revised assignment (PDF or images)</label>
                            <input type="file" class="form-control" name="files" id="resubmit-files" accept=".pdf,image/*" multiple required>
                            <small class="text-muted">You can select one PDF or multiple image files.</small>
                        </div>
                        <button type="submit" class="btn btn-primary" id="btn-resubmit-rubric">
                            <i class="bi bi-upload me-1"></i>Submit new version
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.score-box {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 15px 20px;
    border-radius: 12px;
    text-align: center;
}

.score-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #28a745;
    line-height: 1;
}

.score-total {
    font-size: 1.2rem;
    color: #6c757d;
}

.score-label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 5px;
}

.feedback-table {
    font-size: 0.9rem;
}

.feedback-table td {
    vertical-align: top;
}

.table-success {
    background-color: rgba(40, 167, 69, 0.1) !important;
}

.table-danger {
    background-color: rgba(220, 53, 69, 0.1) !important;
}

.table-warning {
    background-color: rgba(255, 193, 7, 0.15) !important;
}

.answer-key-text {
    white-space: pre-wrap;
    word-break: break-word;
    color: #198754;
    font-weight: 500;
}
</style>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Send Corrections / Challenge
    var btnSend = document.getElementById('btn-send-corrections');
    if (btnSend && !btnSend.disabled) {
        btnSend.addEventListener('click', function() {
            var submissionId = this.getAttribute('data-submission-id');
            if (!submissionId) return;
            var payload = { questions: {}, criteria: {}, errors: [] };
            // Standard: correction_q1, correction_q2, ...
            document.querySelectorAll('.correction-input[name^="correction_q"]').forEach(function(t) {
                var num = (t.getAttribute('name') || '').replace('correction_q', '');
                if (num) payload.questions[num] = (t.value || '').trim();
            });
            // Rubric criteria: .rubric-criterion[data-criterion]
            document.querySelectorAll('.correction-input.rubric-criterion').forEach(function(t) {
                var name = t.getAttribute('data-criterion');
                if (name) payload.criteria[name] = (t.value || '').trim();
            });
            // Rubric errors: .rubric-error[data-error-index]
            document.querySelectorAll('.correction-input.rubric-error').forEach(function(t) {
                var idx = parseInt(t.getAttribute('data-error-index'), 10);
                if (!isNaN(idx)) {
                    while (payload.errors.length <= idx) payload.errors.push('');
                    payload.errors[idx] = (t.value || '').trim();
                }
            });
            btnSend.disabled = true;
            btnSend.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
            fetch('/submissions/' + submissionId + '/send-corrections', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify(payload)
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.success) {
                    window.location.reload();
                } else {
                    btnSend.disabled = false;
                    btnSend.innerHTML = '<i class="bi bi-send me-1"></i>Send Corrections / Challenge';
                    alert(data.error || 'Failed to send.');
                }
            }).catch(function() {
                btnSend.disabled = false;
                btnSend.innerHTML = '<i class="bi bi-send me-1"></i>Send Corrections / Challenge';
                alert('Network error. Please try again.');
            });
        });
    }

    // Rubric resubmit (new version)
    var resubmitForm = document.getElementById('resubmit-rubric-form');
    if (resubmitForm) {
        resubmitForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var files = document.getElementById('resubmit-files');
            if (!files || !files.files || files.files.length === 0) {
                alert('Please select at least one file (PDF or images).');
                return;
            }
            var formData = new FormData();
            formData.append('assignment_id', resubmitForm.querySelector('input[name="assignment_id"]').value);
            formData.append('file_type', files.files[0].name.toLowerCase().endsWith('.pdf') ? 'pdf' : 'images');
            for (var i = 0; i < files.files.length; i++) formData.append('files', files.files[i]);
            formData.append('is_rubric_resubmit', '1');
            var btn = document.getElementById('btn-resubmit-rubric');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Submitting...'; }
            fetch('/student/submit', {
                method: 'POST',
                body: formData
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.success && data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-upload me-1"></i>Submit new version'; }
                    alert(data.error || 'Submission failed.');
                }
            }).catch(function() {
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-upload me-1"></i>Submit new version'; }
                alert('Network error. Please try again.');
            });
        });
    }
})();
</script>
{% endblock %}
