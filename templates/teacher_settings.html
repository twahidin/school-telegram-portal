{% extends "base.html" %}

{% block title %}Settings - Teacher Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark teacher-nav">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('teacher_dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>Teacher Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_dashboard') }}">
                        <i class="bi bi-speedometer2 me-1"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_assignments') }}">
                        <i class="bi bi-journal-text me-1"></i>Assignments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_submissions') }}">
                        <i class="bi bi-inbox me-1"></i>Submissions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_messages') }}">
                        <i class="bi bi-chat-dots me-1"></i>Messages
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('teacher_settings') }}">
                        <i class="bi bi-gear me-1"></i>Settings
                    </a>
                </li>
            </ul>
            <div class="navbar-nav">
                <a class="nav-link" href="{{ url_for('teacher_logout') }}">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="page-header mb-4">
        <h1><i class="bi bi-gear me-2"></i>Settings</h1>
        <p class="text-muted">Manage your account and integrations</p>
    </div>
    
    {% if success %}
    <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle me-2"></i>{{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-circle me-2"></i>{{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-lg-8">
            <form method="POST">
                <!-- Account Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-person me-2"></i>Account Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Teacher ID</label>
                                <input type="text" class="form-control" value="{{ teacher.teacher_id }}" disabled>
                                <small class="text-muted">Cannot be changed</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" value="{{ teacher.name }}" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Subjects (comma-separated)</label>
                            <input type="text" class="form-control" name="subjects" 
                                   value="{{ teacher.subjects | join(', ') if teacher.subjects else '' }}"
                                   placeholder="e.g., Mathematics, Physics">
                        </div>
                    </div>
                </div>
                
                <!-- Change Password -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-key me-2"></i>Change Password</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="current_password" placeholder="Enter current password">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="new_password" placeholder="Enter new password" minlength="6">
                                    <small class="text-muted">Min 6 characters, letters and numbers</small>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-warning" id="change-password-btn">
                            <i class="bi bi-key me-1"></i>Change Password
                        </button>
                        <div id="password-result" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- Messaging Hours -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock me-2"></i>Messaging Hours</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Set the hours when students can expect you to respond to messages. Outside these hours, students will see a notice.</p>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="messaging_hours_enabled" name="messaging_hours_enabled"
                                   {% if teacher.get('messaging_hours_enabled', True) %}checked{% endif %}>
                            <label class="form-check-label" for="messaging_hours_enabled">Enable messaging hours</label>
                        </div>
                        
                        <div class="row mb-3" id="messaging-hours-inputs">
                            <div class="col-md-6">
                                <label class="form-label">Available From</label>
                                <input type="time" class="form-control" name="messaging_start_time" 
                                       value="{{ teacher.get('messaging_start_time', '07:00') }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Available Until</label>
                                <input type="time" class="form-control" name="messaging_end_time" 
                                       value="{{ teacher.get('messaging_end_time', '19:00') }}">
                            </div>
                        </div>
                        <small class="text-muted d-block mb-3">
                            <i class="bi bi-globe me-1"></i>All times are in <strong>Singapore Time (SGT, UTC+8)</strong>
                        </small>
                        
                        <div class="mb-3">
                            <label class="form-label">Outside Hours Message</label>
                            <textarea class="form-control" name="outside_hours_message" rows="2" 
                                      placeholder="Message shown to students outside your available hours">{{ teacher.get('outside_hours_message', 'I am currently unavailable. I will respond to your message during my available hours.') }}</textarea>
                            <small class="text-muted">This message will be shown to students when they try to message you outside your available hours.</small>
                        </div>
                    </div>
                </div>
                
                <!-- Telegram Integration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-telegram me-2"></i>Telegram Integration</h5>
                    </div>
                    <div class="card-body">
                        {% if teacher.telegram_id %}
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Connected!</strong> Telegram ID: {{ teacher.telegram_id }}
                        </div>
                        <p class="text-muted">You will receive student messages and notifications via Telegram.</p>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Not Connected</strong>
                        </div>
                        <div class="telegram-setup">
                            <h6>How to connect Telegram:</h6>
                            <ol>
                                <li>Open Telegram and search for the school bot</li>
                                <li>Start a conversation with the bot</li>
                                <li>Send the command: <code>/verify {{ teacher.teacher_id }}</code></li>
                                <li>Refresh this page to confirm connection</li>
                            </ol>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- AI Marking -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Marking Configuration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Configure API keys for different LLM providers. You can set a default model that will be used for all assignments, or choose a specific model for each assignment.
                        </p>
                        
                        <!-- Default Model Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Default AI Model *</label>
                            <select class="form-select" name="default_ai_model" required>
                                <option value="anthropic" {% if teacher.get('default_ai_model', 'anthropic') == 'anthropic' %}selected{% endif %}>Anthropic (Claude)</option>
                                <option value="openai" {% if teacher.get('default_ai_model') == 'openai' %}selected{% endif %}>OpenAI (GPT)</option>
                                <option value="deepseek" {% if teacher.get('default_ai_model') == 'deepseek' %}selected{% endif %}>DeepSeek</option>
                                <option value="google" {% if teacher.get('default_ai_model') == 'google' %}selected{% endif %}>Google Gemini</option>
                            </select>
                            <small class="text-muted">This will be the default model used for assignments. You can override it when creating each assignment.</small>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Anthropic API Key -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-robot me-1"></i>Anthropic API Key
                            </label>
                            <input type="password" class="form-control" name="anthropic_api_key" 
                                   placeholder="sk-ant-api...">
                            {% if teacher.anthropic_api_key %}
                            <small class="text-success d-block mt-1"><i class="bi bi-check-circle me-1"></i>API key configured</small>
                            {% else %}
                            <small class="text-muted d-block mt-1">Leave blank to use system default (if available)</small>
                            {% endif %}
                        </div>
                        
                        <!-- OpenAI API Key -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-lightning-charge me-1"></i>OpenAI API Key
                            </label>
                            <input type="password" class="form-control" name="openai_api_key" 
                                   placeholder="sk-...">
                            {% if teacher.openai_api_key %}
                            <small class="text-success d-block mt-1"><i class="bi bi-check-circle me-1"></i>API key configured</small>
                            {% else %}
                            <small class="text-muted d-block mt-1">Leave blank to use system default (if available)</small>
                            {% endif %}
                        </div>
                        
                        <!-- DeepSeek API Key -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-search me-1"></i>DeepSeek API Key
                            </label>
                            <input type="password" class="form-control" name="deepseek_api_key" 
                                   placeholder="sk-...">
                            {% if teacher.deepseek_api_key %}
                            <small class="text-success d-block mt-1"><i class="bi bi-check-circle me-1"></i>API key configured</small>
                            {% else %}
                            <small class="text-muted d-block mt-1">Leave blank to use system default (if available)</small>
                            {% endif %}
                        </div>
                        
                        <!-- Google Gemini API Key -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-google me-1"></i>Google Gemini API Key
                            </label>
                            <input type="password" class="form-control" name="google_api_key" 
                                   placeholder="AIza...">
                            {% if teacher.google_api_key %}
                            <small class="text-success d-block mt-1"><i class="bi bi-check-circle me-1"></i>API key configured</small>
                            {% else %}
                            <small class="text-muted d-block mt-1">Leave blank to use system default (if available)</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Google Drive -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-google me-2"></i>Google Drive Integration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Configure a Google Drive folder to browse and select files when creating assignments.
                        </p>
                        
                        <!-- Service Account Info -->
                        <div class="alert alert-info mb-3" id="service-account-info">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Loading service account info...</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Google Drive Source Files Folder ID</label>
                            <input type="text" class="form-control" name="google_drive_source_folder_id" 
                                   value="{{ teacher.google_drive_source_folder_id or '' }}"
                                   placeholder="e.g., 1aBcDeFgHiJkLmNoPqRsTuVwXyZ">
                            <small class="text-muted">
                                Folder containing your question papers, answer keys, and reference materials. 
                                You can browse and select files from this folder when creating assignments instead of uploading from your computer.
                                <br>Find this in the URL when viewing the folder: <code>drive.google.com/drive/folders/[FOLDER_ID]</code>
                                <br><strong class="text-info">ℹ️ Files are referenced directly from your Drive (not copied). Viewer permission is sufficient.</strong>
                            </small>
                        </div>
                        
                        {% if teacher.google_drive_source_folder_id %}
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-1"></i>Source files folder configured
                        </div>
                        {% endif %}
                        
                        <!-- Setup Instructions -->
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#driveSetupHelp">
                                <i class="bi bi-question-circle me-1"></i>Setup Instructions
                            </button>
                            <div class="collapse mt-2" id="driveSetupHelp">
                                <div class="card card-body bg-light small">
                                    <h6 class="fw-bold">For Submissions Folder:</h6>
                                    <ol class="mb-3">
                                        <li>Create a folder in your Google Drive where you want submissions saved</li>
                                        <li>Right-click the folder and select <strong>Share</strong></li>
                                        <li>Paste the service account email shown above</li>
                                        <li>Set permission to <strong>Editor</strong></li>
                                        <li>Uncheck "Notify people" and click <strong>Share</strong></li>
                                        <li>Copy the Folder ID from the URL (drive.google.com/drive/folders/<strong>[FOLDER_ID]</strong>)</li>
                                        <li>Paste it in the "Google Drive Folder ID (for Submissions)" field above</li>
                                    </ol>
                                    
                                    <h6 class="fw-bold">For Source Files Folder:</h6>
                                    <ol class="mb-0">
                                        <li>Create a folder in your Google Drive where you store your question papers, answer keys, etc.</li>
                                        <li>Upload your PDFs, Google Docs, or Google Sheets to this folder</li>
                                        <li>Right-click the folder and select <strong>Share</strong></li>
                                        <li>Paste the <strong>same service account email</strong> shown above</li>
                                        <li>Set permission to <strong>Viewer</strong> (sufficient for reading files - files are referenced, not copied)</li>
                                        <li>Uncheck "Notify people" and click <strong>Share</strong></li>
                                        <li>Copy the Folder ID from the URL</li>
                                        <li>Paste it in the "Google Drive Source Files Folder ID" field above</li>
                                    </ol>
                                    <div class="alert alert-info mt-2 mb-0">
                                        <small><i class="bi bi-info-circle me-1"></i><strong>Note:</strong> Files from this folder are referenced directly from Google Drive (not copied). The system only reads them when needed, so Viewer permission is sufficient.</small>
                                    </div>
                                    <div class="alert alert-info mt-3 mb-0">
                                        <small><i class="bi bi-info-circle me-1"></i><strong>Note:</strong> You can use the same folder for both, but it's recommended to keep them separate for better organization.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save me-2"></i>Save Settings
                    </button>
                </div>
            </form>
            
            <!-- Manage My Classes (outside main form) -->
            <div class="card mb-4 mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-collection me-2"></i>My Classes</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Select which classes you teach. Students in these classes will be assigned to you.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign Class to Yourself</label>
                        <div class="input-group">
                            <select class="form-select" id="assign-class-select">
                                <option value="">Select a class...</option>
                                {% for c in classes %}
                                <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-primary" id="assign-class-btn">
                                <i class="bi bi-plus-lg"></i> Assign
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Currently Assigned Classes</label>
                        <div id="my-classes-list">
                            {% if teacher.classes %}
                            {% for cls in teacher.classes %}
                            <span class="badge bg-info me-1 mb-1 d-inline-flex align-items-center" style="font-size: 0.9rem;">
                                {{ cls }}
                                <button type="button" class="btn-close btn-close-white ms-2 remove-class-btn" 
                                        data-class-id="{{ cls }}" style="font-size: 0.6rem;"></button>
                            </span>
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">No classes assigned</span>
                            {% endif %}
                        </div>
                    </div>
                    <div id="class-result"></div>
                </div>
            </div>
            
            <!-- Assign Students to My Classes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>Assign Students to My Classes</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Select existing students and assign them to one of your classes. Students can belong to multiple classes.</p>
                    
                    <form id="assign-student-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Student *</label>
                                <select class="form-select" id="student_select" required>
                                    <option value="">Choose a student...</option>
                                    {% for s in all_students %}
                                    <option value="{{ s.student_id }}">{{ s.name }} ({{ s.student_id }}){% if s.classes %} - {{ s.classes | join(', ') }}{% elif s.class %} - {{ s.class }}{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Assign to Class *</label>
                                <select class="form-select" id="target_class" required>
                                    <option value="">Choose one of your classes...</option>
                                    {% for cls in teacher.classes or [] %}
                                    <option value="{{ cls }}">{{ cls }}</option>
                                    {% endfor %}
                                </select>
                                {% if not teacher.classes %}
                                <small class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>You need to assign yourself to a class first (above)</small>
                                {% endif %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" {% if not teacher.classes %}disabled{% endif %}>
                            <i class="bi bi-person-plus me-1"></i>Assign Student
                        </button>
                    </form>
                    <div id="assign-student-result" class="mt-2"></div>
                    
                    <!-- My Students List -->
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="bi bi-people me-2"></i>My Students</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-warning" id="reset-selected-passwords" disabled data-bs-toggle="modal" data-bs-target="#mass-reset-modal">
                                <i class="bi bi-key me-1"></i>Reset Passwords
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-hover">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th style="width: 30px;">
                                        <input type="checkbox" class="form-check-input" id="select-all-students">
                                    </th>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Classes</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="my-students-tbody">
                                {% for s in my_students %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input student-checkbox" value="{{ s.student_id }}">
                                    </td>
                                    <td><code>{{ s.student_id }}</code></td>
                                    <td>{{ s.name }}</td>
                                    <td>
                                        {% if s.classes %}
                                        {{ s.classes | join(', ') }}
                                        {% elif s.class %}
                                        {{ s.class }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-warning btn-sm reset-single-pwd-btn me-1" 
                                                data-student-id="{{ s.student_id }}" data-student-name="{{ s.name }}" title="Reset Password">
                                            <i class="bi bi-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm remove-student-btn" 
                                                data-student-id="{{ s.student_id }}" title="Remove from my students">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="5" class="text-center text-muted">No students assigned to you yet</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Help</h5>
                </div>
                <div class="card-body">
                    <h6>Telegram Bot</h6>
                    <p class="small text-muted">
                        Connect Telegram to receive instant notifications when students submit assignments or send messages.
                    </p>
                    
                    <h6>AI Marking</h6>
                    <p class="small text-muted">
                        Configure API keys for multiple LLM providers (Anthropic, OpenAI, DeepSeek, Google Gemini). Set a default model that will be used for all assignments, or choose a specific model when creating each assignment. You can also provide additional instructions for feedback and grading per assignment.
                    </p>
                    
                    <h6>Google Drive</h6>
                    <p class="small text-muted">
                        Browse and select files from your Google Drive folder when creating assignments. Files are referenced directly from your Drive (not copied).
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Mass Reset Password Modal -->
<div class="modal fade" id="mass-reset-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-key me-2"></i>Reset Student Passwords</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="reset-count-text" class="text-muted">0 students selected</p>
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input type="text" class="form-control" id="mass-reset-password" placeholder="Leave blank for 'student123'">
                    <small class="text-muted">Default: student123</small>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    This will reset passwords for all selected students.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-mass-reset">
                    <i class="bi bi-key me-1"></i>Reset Passwords
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Single Reset Password Modal -->
<div class="modal fade" id="single-reset-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-key me-2"></i>Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="single-reset-body">
                <!-- Content will be set dynamically -->
            </div>
            <div class="modal-footer" id="single-reset-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-single-reset">Reset Password</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load Google Drive service account info
    async function loadServiceAccountInfo() {
        const infoDiv = document.getElementById('service-account-info');
        try {
            const response = await fetch('/api/drive/service-account-info');
            const data = await response.json();
            
            if (data.configured && data.email) {
                infoDiv.innerHTML = `
                    <div>
                        <strong><i class="bi bi-key me-1"></i>Service Account Email:</strong>
                        <p class="mb-2 mt-1">Share your Google Drive folder with this email address:</p>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control bg-white" value="${data.email}" id="service-account-email" readonly>
                            <button class="btn btn-outline-primary" type="button" onclick="copyServiceAccountEmail()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                        <small class="text-muted mt-1 d-block">Grant <strong>Editor</strong> access when sharing the folder.</small>
                    </div>
                `;
            } else {
                infoDiv.className = 'alert alert-warning mb-3';
                infoDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    ${data.message || 'Google Drive integration not configured by administrator.'}
                `;
            }
        } catch (e) {
            infoDiv.className = 'alert alert-warning mb-3';
            infoDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i>Could not load service account info.`;
        }
    }
    
    function copyServiceAccountEmail() {
        const emailInput = document.getElementById('service-account-email');
        emailInput.select();
        document.execCommand('copy');
        
        // Show feedback
        const btn = emailInput.nextElementSibling;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Show temporary success message
            const event = new CustomEvent('showToast', {
                detail: { title: 'Copied!', message: 'Email copied to clipboard', type: 'success' }
            });
            window.dispatchEvent(event);
        }).catch(() => {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Copied to clipboard!');
        });
    }
    
    // Load on page load
    loadServiceAccountInfo();

    // Change Password
    document.getElementById('change-password-btn').addEventListener('click', async () => {
        const currentPassword = document.getElementById('current_password').value;
        const newPassword = document.getElementById('new_password').value;
        const resultDiv = document.getElementById('password-result');
        
        if (!currentPassword || !newPassword) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Please enter both current and new password</div>';
            return;
        }
        
        if (newPassword.length < 6) {
            resultDiv.innerHTML = '<div class="alert alert-warning">New password must be at least 6 characters</div>';
            return;
        }
        if (!/[a-zA-Z]/.test(newPassword) || !/\d/.test(newPassword)) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Password must contain both letters and numbers</div>';
            return;
        }
        
        try {
            const response = await fetch('/teacher/change_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-1"></i>Password changed successfully!</div>';
                document.getElementById('current_password').value = '';
                document.getElementById('new_password').value = '';
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle me-1"></i>${data.error || 'Failed to change password'}</div>`;
            }
        } catch (e) {
            resultDiv.innerHTML = '<div class="alert alert-danger">Error changing password</div>';
        }
    });
    
    // Assign Class to Self
    document.getElementById('assign-class-btn').addEventListener('click', async () => {
        const classId = document.getElementById('assign-class-select').value;
        const resultDiv = document.getElementById('class-result');
        
        if (!classId) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Please select a class</div>';
            return;
        }
        
        try {
            const response = await fetch('/teacher/assign_class', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ class_id: classId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                location.reload();
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to assign class'}</div>`;
            }
        } catch (e) {
            resultDiv.innerHTML = '<div class="alert alert-danger">Error assigning class</div>';
        }
    });
    
    // Remove Class from Self
    document.querySelectorAll('.remove-class-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const classId = btn.dataset.classId;
            
            try {
                const response = await fetch('/teacher/remove_class', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: classId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Failed to remove class');
                }
            } catch (e) {
                alert('Error removing class');
            }
        });
    });
    
    // Assign Student to Class
    const assignForm = document.getElementById('assign-student-form');
    if (assignForm) {
        assignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('assign-student-result');
            
            const studentId = document.getElementById('student_select').value;
            const classId = document.getElementById('target_class').value;
            
            if (!studentId || !classId) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select both a student and a class</div>';
                return;
            }
            
            try {
                const response = await fetch('/teacher/assign_student_to_class', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId, class_id: classId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle me-1"></i>${result.message}</div>`;
                    // Reload page to update student list
                    setTimeout(() => location.reload(), 1500);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle me-1"></i>${result.error || 'Failed to assign student'}</div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Error assigning student</div>';
            }
        });
    }
    
    // Remove Student from My Students
    document.querySelectorAll('.remove-student-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const studentId = btn.dataset.studentId;
            if (!confirm(`Remove student ${studentId} from your students?`)) return;
            
            try {
                const response = await fetch('/teacher/remove_student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || 'Failed to remove student');
                }
            } catch (e) {
                alert('Error removing student');
            }
        });
    });
    
    // ================== PASSWORD RESET FEATURES ==================
    
    // Select all students checkbox
    const selectAllCheckbox = document.getElementById('select-all-students');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
            document.querySelectorAll('.student-checkbox').forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
            updateSelectionUI();
        });
    }
    
    // Individual student checkboxes
    document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.addEventListener('change', updateSelectionUI);
    });
    
    function updateSelectionUI() {
        const selectedCount = document.querySelectorAll('.student-checkbox:checked').length;
        const resetBtn = document.getElementById('reset-selected-passwords');
        if (resetBtn) {
            resetBtn.disabled = selectedCount === 0;
        }
        
        const countText = document.getElementById('reset-count-text');
        if (countText) {
            countText.textContent = `${selectedCount} student(s) selected`;
        }
    }
    
    // Mass reset passwords
    const confirmMassResetBtn = document.getElementById('confirm-mass-reset');
    if (confirmMassResetBtn) {
        confirmMassResetBtn.addEventListener('click', async () => {
            const selected = [...document.querySelectorAll('.student-checkbox:checked')].map(cb => cb.value);
            if (selected.length === 0) return;
            
            const customPassword = document.getElementById('mass-reset-password').value.trim();
            
            try {
                const response = await fetch('/teacher/reset_student_passwords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        student_ids: selected,
                        password: customPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('mass-reset-modal')).hide();
                    alert(`Successfully reset ${data.count} password(s) to: ${data.password}`);
                    document.getElementById('mass-reset-password').value = '';
                    // Uncheck all checkboxes
                    document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
                    if (selectAllCheckbox) selectAllCheckbox.checked = false;
                    updateSelectionUI();
                } else {
                    alert(data.error || 'Failed to reset passwords');
                }
            } catch (e) {
                console.error('Mass reset failed:', e);
                alert('Failed to reset passwords');
            }
        });
    }
    
    // Single reset password
    const singleResetModal = document.getElementById('single-reset-modal') ? new bootstrap.Modal(document.getElementById('single-reset-modal')) : null;
    let singleResetStudentId = null;
    
    document.querySelectorAll('.reset-single-pwd-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            singleResetStudentId = btn.dataset.studentId;
            const studentName = btn.dataset.studentName;
            
            document.getElementById('single-reset-body').innerHTML = `
                <p>Reset password for student:</p>
                <p><strong>${studentName}</strong> (<code>${singleResetStudentId}</code>)</p>
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input type="text" class="form-control" id="single-reset-password" placeholder="Leave blank for 'student123'">
                    <small class="text-muted">Default: student123</small>
                </div>
            `;
            
            if (singleResetModal) singleResetModal.show();
        });
    });
    
    const confirmSingleResetBtn = document.getElementById('confirm-single-reset');
    if (confirmSingleResetBtn) {
        confirmSingleResetBtn.addEventListener('click', async () => {
            if (!singleResetStudentId) return;
            
            const passwordInput = document.getElementById('single-reset-password');
            const customPassword = passwordInput ? passwordInput.value.trim() : '';
            
            try {
                const response = await fetch('/teacher/reset_student_passwords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        student_ids: [singleResetStudentId],
                        password: customPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('single-reset-body').innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">Password Reset Successful!</h5>
                            <p>New password for <strong>${singleResetStudentId}</strong>:</p>
                            <div class="alert alert-warning">
                                <code style="font-size: 1.2rem;">${data.password}</code>
                            </div>
                            <small class="text-muted">Please share this password with the student securely.</small>
                        </div>
                    `;
                    document.getElementById('single-reset-footer').innerHTML = `
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
                    `;
                } else {
                    alert(data.error || 'Password reset failed');
                }
            } catch (e) {
                console.error('Single reset failed:', e);
                alert('Failed to reset password');
            }
        });
    }
</script>
{% endblock %}
