{% extends "base.html" %}

{% block title %}{{ module.title }} - Teacher Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark teacher-nav">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('teacher_dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>Teacher Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('teacher_dashboard') }}"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('teacher_assignments') }}"><i class="bi bi-journal-text me-1"></i>Assignments</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('teacher_submissions') }}"><i class="bi bi-inbox me-1"></i>Submissions</a></li>
                <li class="nav-item"><a class="nav-link active" href="{{ url_for('teacher_modules') }}"><i class="bi bi-diagram-3 me-1"></i>Modules</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('teacher_messages') }}"><i class="bi bi-chat-dots me-1"></i>Messages</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('teacher_settings') }}"><i class="bi bi-gear me-1"></i>Settings</a></li>
            </ul>
            <div class="navbar-nav">
                <span class="navbar-text me-3"><i class="bi bi-person-workspace me-1"></i>{{ session.teacher_name }}</span>
                <a class="nav-link" href="{{ url_for('teacher_logout') }}"><i class="bi bi-box-arrow-right me-1"></i>Logout</a>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{{ url_for('teacher_modules') }}" class="btn btn-outline-secondary btn-sm mb-2">
                <i class="bi bi-arrow-left me-1"></i>Back to Modules
            </a>
            <h1><i class="bi {{ module.icon or 'bi-diagram-3' }} me-2" style="color: {{ module.color or '#667eea' }};"></i>{{ module.title }}</h1>
            <p class="text-muted mb-0">{{ module.subject }} â€¢ {{ module.year_level }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('module_class_mastery', module_id=module.module_id) }}" class="btn btn-outline-success">
                <i class="bi bi-graph-up me-1"></i>Class Mastery
            </a>
            {% if module.status != 'published' %}
            <button type="button" class="btn btn-primary" id="publish-btn">
                <i class="bi bi-send me-1"></i>Publish for Students
            </button>
            {% else %}
            <span class="badge bg-success align-self-center">Published</span>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div id="module-3d-container" class="module-3d-container" style="height: 500px;"></div>
        </div>
    </div>

    <p class="text-muted small mt-2">Click any node to edit its prompt and add materials. Drag to rotate the view.</p>
</div>

<!-- Node Editor Sidebar -->
<div class="node-editor-sidebar" id="nodeEditor" style="display: none;">
    <div class="node-editor-header d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
        <h5 class="mb-0">Edit Module Node</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="closeNodeEditor"><i class="bi bi-x-lg"></i></button>
    </div>
    <form id="nodeEditorForm">
        <input type="hidden" id="editNodeId" name="node_id">
        <div class="mb-3">
            <label class="form-label small text-muted">Module Title</label>
            <input type="text" class="form-control form-control-sm" id="editTitle" name="title" required>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted">Description</label>
            <textarea class="form-control form-control-sm" id="editDescription" name="description" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted">Learning Objectives (one per line)</label>
            <textarea class="form-control form-control-sm" id="editLearningObjectives" name="learning_objectives" rows="3" placeholder="One objective per line"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted">Custom prompt for AI tutor</label>
            <textarea class="form-control form-control-sm" id="editCustomPrompt" name="custom_prompt" rows="4" placeholder="Optional: instructions for the AI when students learn this module (e.g. focus on examples, use simpler language)"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted d-flex justify-content-between align-items-center">
                Resources
                <span class="badge bg-primary" id="resourceCount">0</span>
            </label>
            <div id="resourceList" class="resource-list mb-2"></div>
            <div class="add-resource-area">
                <button type="button" class="btn btn-sm btn-outline-primary w-100" id="addResourceBtn"><i class="bi bi-plus-circle me-1"></i>Add Resource</button>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm flex-grow-1"><i class="bi bi-check me-1"></i>Save Changes</button>
        </div>
    </form>
</div>

<!-- Add Resource Modal -->
<div class="modal fade" id="addResourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label small">Type</label>
                    <select class="form-select form-select-sm" id="resType">
                        <option value="youtube">YouTube / Video</option>
                        <option value="link">Link</option>
                        <option value="pdf">PDF (link)</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label small">Title</label>
                    <input type="text" class="form-control form-control-sm" id="resTitle" placeholder="e.g. Introduction Video">
                </div>
                <div class="mb-2">
                    <label class="form-label small">URL</label>
                    <input type="url" class="form-control form-control-sm" id="resUrl" placeholder="https://...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="saveResourceBtn"><i class="bi bi-plus me-1"></i>Add</button>
            </div>
        </div>
    </div>
</div>

<style>
.node-editor-sidebar { position: fixed; right: 0; top: 56px; width: 360px; max-height: calc(100vh - 56px); overflow-y: auto; background: white; border-left: 1px solid #e2e8f0; padding: 1.25rem; z-index: 1050; box-shadow: -4px 0 12px rgba(0,0,0,0.08); }
.resource-list .resource-item { display: flex; align-items: center; padding: 0.5rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.5rem; }
.resource-list .resource-item .resource-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; font-size: 1rem; }
.resource-list .resource-item .resource-icon.youtube { background: rgba(255,0,0,0.1); color: #f00; }
.resource-list .resource-item .resource-icon.pdf { background: rgba(239,68,68,0.1); color: #ef4444; }
.resource-list .resource-item .resource-icon.link { background: rgba(6,182,212,0.1); color: #06b6d4; }
.resource-list .resource-item .flex-grow-1 { min-width: 0; }
.resource-list .resource-item .btn-link { padding: 0 0.25rem; font-size: 0.9rem; }
</style>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.0/examples/js/controls/OrbitControls.js"></script>
<script>
(function() {
    const moduleTree = {{ modules_json|safe }};
    const container = document.getElementById('module-3d-container');
    if (!container || !moduleTree) return;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf8fafc);
    const width = container.clientWidth;
    const height = container.clientHeight;
    const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 2000);
    camera.position.set(0, 200, 400);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.maxDistance = 800;
    controls.minDistance = 100;

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(100, 200, 100);
    scene.add(dirLight);

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const meshes = [];

    function addNode(node, parentPos, depth, siblingIndex, siblingCount) {
        const baseDist = 80 + depth * 30;
        const angle = (siblingIndex / Math.max(siblingCount, 1)) * Math.PI * 2 + Math.PI / 4;
        const x = (parentPos ? parentPos.x : 0) + Math.cos(angle) * baseDist;
        const z = (parentPos ? parentPos.z : 0) + Math.sin(angle) * baseDist;
        const y = depth * 20;
        const position = new THREE.Vector3(x, y, z);

        const radius = Math.max(20 - depth * 3, 8);
        const geometry = new THREE.SphereGeometry(radius, 32, 32);
        const color = (node.color && node.color.startsWith('#')) ? parseInt(node.color.slice(1), 16) : 0x667eea;
        const material = new THREE.MeshPhongMaterial({ color: color, shininess: 50 });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.copy(position);
        mesh.userData = { moduleId: node.module_id, nodeId: node.module_id, title: node.title, isLeaf: node.is_leaf };
        scene.add(mesh);
        meshes.push(mesh);

        const children = node.children || [];
        children.forEach(function(child, i) { addNode(child, position, depth + 1, i, children.length); });
    }
    addNode(moduleTree, null, 0, 0, 1);

    const rootModuleId = '{{ module.module_id }}';
    const nodeEditor = document.getElementById('nodeEditor');
    const closeNodeEditor = document.getElementById('closeNodeEditor');
    const nodeEditorForm = document.getElementById('nodeEditorForm');
    const editNodeId = document.getElementById('editNodeId');
    const editTitle = document.getElementById('editTitle');
    const editDescription = document.getElementById('editDescription');
    const editLearningObjectives = document.getElementById('editLearningObjectives');
    const editCustomPrompt = document.getElementById('editCustomPrompt');
    const resourceList = document.getElementById('resourceList');
    const resourceCount = document.getElementById('resourceCount');
    const addResourceBtn = document.getElementById('addResourceBtn');
    const addResourceModal = document.getElementById('addResourceModal');
    const saveResourceBtn = document.getElementById('saveResourceBtn');

    function findNode(tree, id) {
        if (tree.module_id === id) return tree;
        for (const c of (tree.children || [])) {
            const found = findNode(c, id);
            if (found) return found;
        }
        return null;
    }

    function openNodeEditor(nodeData) {
        editNodeId.value = nodeData.module_id;
        editTitle.value = nodeData.title || '';
        editDescription.value = nodeData.description || '';
        editLearningObjectives.value = Array.isArray(nodeData.learning_objectives) ? nodeData.learning_objectives.join('\n') : (nodeData.learning_objectives || '');
        editCustomPrompt.value = nodeData.custom_prompt || '';
        nodeEditor.style.display = 'block';
        loadResources(nodeData.module_id);
    }

    async function loadResources(nodeId) {
        try {
            const res = await fetch('{{ url_for("manage_module_resources", module_id=module.module_id, node_id="__NODE__") }}'.replace('__NODE__', encodeURIComponent(nodeId)));
            const data = await res.json();
            const list = (data.resources || []);
            resourceCount.textContent = list.length;
            resourceList.innerHTML = list.map(function(r) {
                const icon = r.type === 'youtube' ? 'bi-youtube' : (r.type === 'pdf' ? 'bi-file-pdf' : 'bi-link-45deg');
                const iconCls = r.type === 'youtube' ? 'youtube' : (r.type === 'pdf' ? 'pdf' : 'link');
                return '<div class="resource-item"><div class="resource-icon ' + iconCls + '"><i class="bi ' + icon + '"></i></div><div class="flex-grow-1 small text-truncate" title="' + (r.title || '') + '">' + (r.title || 'Resource') + '</div><button type="button" class="btn btn-link text-danger p-0 delete-resource" data-resource-id="' + (r.resource_id || '') + '"><i class="bi bi-trash"></i></button></div>';
            }).join('');
            resourceList.querySelectorAll('.delete-resource').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const rid = this.getAttribute('data-resource-id');
                    if (!rid || !confirm('Remove this resource?')) return;
                    fetch('{{ url_for("delete_module_resource", module_id=module.module_id, node_id="__NODE__", resource_id="__RID__") }}'.replace('__NODE__', encodeURIComponent(nodeId)).replace('__RID__', encodeURIComponent(rid)), { method: 'DELETE' })
                        .then(function(r) { return r.json(); })
                        .then(function(d) { if (d.success) loadResources(nodeId); });
                });
            });
        } catch (e) { resourceList.innerHTML = '<div class="small text-muted">Could not load resources.</div>'; resourceCount.textContent = '0'; }
    }

    function onMouseClick(event) {
        const rect = container.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObjects(meshes);
        if (hits.length > 0) {
            const nodeId = hits[0].object.userData.nodeId;
            const nodeData = findNode(moduleTree, nodeId);
            if (nodeData) openNodeEditor(nodeData);
        }
    }
    container.addEventListener('click', onMouseClick);

    closeNodeEditor && closeNodeEditor.addEventListener('click', function() { nodeEditor.style.display = 'none'; });

    nodeEditorForm && nodeEditorForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const nodeId = editNodeId.value;
        const objectivesText = editLearningObjectives.value.trim();
        const objectives = objectivesText ? objectivesText.split(/\n/).map(function(s) { return s.trim(); }).filter(Boolean) : [];
        try {
            const res = await fetch('{{ url_for("update_module_node", module_id=module.module_id, node_id="__NODE__") }}'.replace('__NODE__', encodeURIComponent(nodeId)), {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: editTitle.value.trim(),
                    description: editDescription.value.trim(),
                    learning_objectives: objectives,
                    custom_prompt: editCustomPrompt.value.trim(),
                }),
            });
            const data = await res.json();
            if (data.success) {
                var nd = findNode(moduleTree, nodeId);
                if (nd) { nd.title = editTitle.value.trim(); nd.description = editDescription.value.trim(); nd.learning_objectives = objectives; nd.custom_prompt = editCustomPrompt.value.trim(); }
                alert('Saved.');
            } else alert(data.error || 'Save failed');
        } catch (err) { alert('Save failed'); }
    });

    addResourceBtn && addResourceBtn.addEventListener('click', function() {
        document.getElementById('resTitle').value = '';
        document.getElementById('resUrl').value = '';
        addResourceModal.setAttribute('data-edit-node-id', editNodeId.value);
        new bootstrap.Modal(addResourceModal).show();
    });
    saveResourceBtn && saveResourceBtn.addEventListener('click', function() {
        const nodeId = addResourceModal.getAttribute('data-edit-node-id');
        const type = document.getElementById('resType').value;
        const title = document.getElementById('resTitle').value.trim();
        const url = document.getElementById('resUrl').value.trim();
        if (!title || !url) { alert('Title and URL required'); return; }
        const formData = new FormData();
        formData.append('type', type);
        formData.append('title', title);
        formData.append('url', url);
        fetch('{{ url_for("manage_module_resources", module_id=module.module_id, node_id="__NODE__") }}'.replace('__NODE__', encodeURIComponent(nodeId)), { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (d.success) { bootstrap.Modal.getInstance(addResourceModal).hide(); loadResources(nodeId); }
                else alert(d.error || 'Failed to add');
            });
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', function() {
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
    });

    document.getElementById('publish-btn') && document.getElementById('publish-btn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        try {
            const res = await fetch('{{ url_for("publish_module", module_id=module.module_id) }}', { method: 'POST' });
            const data = await res.json();
            if (data.success) window.location.reload();
        } finally { btn.disabled = false; }
    });
})();
</script>
{% endblock %}
