{% extends "base.html" %}

{% block title %}{{ module.title }} - Teacher Portal{% endblock %}

{% block navbar %}
{% set active_nav = 'learning_tools' %}
{% include 'partials/teacher_navbar.html' %}
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{{ url_for('teacher_modules') }}" class="btn btn-outline-secondary btn-sm mb-2">
                <i class="bi bi-arrow-left me-1"></i>Back to Modules
            </a>
            <h1><i class="bi {{ module.icon or 'bi-diagram-3' }} me-2" style="color: {{ module.color or '#667eea' }};"></i>{{ module.title }}</h1>
            <p class="text-muted mb-0">{{ module.subject }} • {{ module.year_level }}</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <a href="{{ url_for('module_class_mastery', module_id=module.module_id) }}" class="btn btn-outline-success">
                <i class="bi bi-graph-up me-1"></i>Class Mastery
            </a>
            {% if module.status != 'published' %}
            <button type="button" class="btn btn-primary" id="publish-btn">
                <i class="bi bi-send me-1"></i>Publish for Students
            </button>
            {% else %}
            <span class="badge bg-success align-self-center">Published</span>
            {% endif %}
            <button type="button" class="btn btn-outline-danger" id="delete-module-tree-btn" title="Delete this module tree">
                <i class="bi bi-trash me-1"></i>Delete
            </button>
        </div>
    </div>

    <div class="teacher-flat-map-wrapper">
        <div class="flat-map-container teacher-flat-map" id="teacherMapContainer">
            <div class="flat-map-controls">
                <button type="button" class="flat-control-btn" title="Zoom In" id="teacherZoomIn"><i class="bi bi-zoom-in"></i></button>
                <button type="button" class="flat-control-btn" title="Zoom Out" id="teacherZoomOut"><i class="bi bi-zoom-out"></i></button>
                <button type="button" class="flat-control-btn" title="Reset" id="teacherResetView"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>
            <div class="flat-pan-zoom" id="teacherPanZoom">
                <div class="flat-pan-zoom-content" id="teacherPanZoomContent">
                    <div class="flat-modules-layer" id="teacherModulesLayer"></div>
                    <svg class="flat-connections-svg" id="teacherConnectionsSvg"></svg>
                </div>
            </div>
        </div>
    </div>
    <p class="text-muted small mt-2">Click any node to edit; right-click to expand or collapse branches. Drag to pan, use buttons to zoom.</p>

    <!-- Textbook RAG: store entire textbook for this module tree -->
    <div class="card mt-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-journal-book me-2"></i>Textbook (RAG)</span>
            <small class="text-muted">AI tutor can use this to answer from your textbook</small>
        </div>
        <div class="card-body">
            <div id="textbook-status" class="mb-3">
                <span class="text-muted">Loading…</span>
            </div>
            <div id="textbook-upload-area">
                <form id="textbook-upload-form" enctype="multipart/form-data">
                    <div class="mb-2">
                        <label class="form-label small">Title (optional)</label>
                        <input type="text" class="form-control form-control-sm" id="textbook-title" name="title" placeholder="e.g. Chapter 1 or Mathematics Year 3">
                    </div>
                    <div class="mb-2">
                        <input type="file" class="form-control form-control-sm" id="textbook-file" name="textbook_file" accept=".pdf" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm" id="textbook-upload-btn">
                        <i class="bi bi-upload me-1"></i>Add PDF (chapter or full book)
                    </button>
                </form>
                <p class="form-text small mb-0">Upload as many PDFs as you like—each upload is added to the RAG (e.g. chapter by chapter). Requires OPENAI_API_KEY.</p>
            </div>
            <div id="textbook-delete-area" style="display: none;">
                <button type="button" class="btn btn-outline-danger btn-sm" id="textbook-delete-btn">
                    <i class="bi bi-trash me-1"></i>Remove textbook
                </button>
            </div>
            <div id="textbook-message" class="alert d-none mt-2"></div>
        </div>
    </div>
</div>

<div class="flat-context-menu" id="teacherContextMenu">
    <button type="button" id="teacherExpandBtn"><i class="bi bi-chevron-down me-1"></i>Expand branch</button>
    <button type="button" id="teacherCollapseBtn"><i class="bi bi-chevron-up me-1"></i>Collapse branch</button>
</div>

<!-- Node Editor Sidebar -->
<div class="node-editor-sidebar" id="nodeEditor" style="display: none;">
    <div class="node-editor-header d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
        <h5 class="mb-0">Edit Module Node</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="closeNodeEditor"><i class="bi bi-x-lg"></i></button>
    </div>
    <form id="nodeEditorForm">
        <input type="hidden" id="editNodeId" name="node_id">
        <div class="mb-3">
            <label class="form-label small text-muted">Module Title</label>
            <input type="text" class="form-control form-control-sm" id="editTitle" name="title" required>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted">Description</label>
            <textarea class="form-control form-control-sm" id="editDescription" name="description" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted">Learning Objectives (one per line)</label>
            <textarea class="form-control form-control-sm" id="editLearningObjectives" name="learning_objectives" rows="3" placeholder="One objective per line"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted">Custom prompt for AI tutor</label>
            <textarea class="form-control form-control-sm" id="editCustomPrompt" name="custom_prompt" rows="4" placeholder="Optional: instructions for the AI when students learn this module (e.g. focus on examples, use simpler language)"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label small text-muted d-flex justify-content-between align-items-center">
                Resources
                <span class="badge bg-primary" id="resourceCount">0</span>
            </label>
            <div id="resourceList" class="resource-list mb-2"></div>
            <div class="add-resource-area">
                <button type="button" class="btn btn-sm btn-outline-primary w-100" id="addResourceBtn"><i class="bi bi-plus-circle me-1"></i>Add Resource</button>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm flex-grow-1"><i class="bi bi-check me-1"></i>Save Changes</button>
        </div>
    </form>
</div>

<!-- Add Resource Modal -->
<div class="modal fade" id="addResourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label small">Type</label>
                    <select class="form-select form-select-sm" id="resType">
                        <option value="youtube">YouTube / Video</option>
                        <option value="pdf">PDF (link or upload)</option>
                        <option value="link">Website / Link</option>
                        <option value="slides">Google Slides</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label small">Title</label>
                    <input type="text" class="form-control form-control-sm" id="resTitle" placeholder="e.g. Introduction Video">
                </div>
                <div class="mb-2" id="resUrlWrap">
                    <label class="form-label small">URL</label>
                    <input type="url" class="form-control form-control-sm" id="resUrl" placeholder="https://...">
                </div>
                <div class="mb-2 d-none" id="resPdfUploadWrap">
                    <label class="form-label small">Or upload PDF</label>
                    <input type="file" class="form-control form-control-sm" id="resPdfFile" accept="application/pdf">
                    <p class="form-text small mb-0">Max 10 MB. Leave URL empty to use upload only.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="saveResourceBtn"><i class="bi bi-plus me-1"></i>Add</button>
            </div>
        </div>
    </div>
</div>

<style>
.teacher-flat-map-wrapper { height: 560px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.flat-map-container.teacher-flat-map { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); height: 100%; }
.flat-modules-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
.flat-modules-layer .flat-module-node { pointer-events: auto; }
.flat-connections-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
.flat-connection-line { stroke: rgba(255,255,255,0.3); stroke-width: 2; fill: none; }
.flat-module-node { position: absolute; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; z-index: 10; }
.flat-module-node:hover { transform: scale(1.1); z-index: 20; }
.flat-module-node.selected { transform: scale(1.15); z-index: 30; box-shadow: 0 0 0 4px rgba(255,255,255,0.5); }
.flat-module-circle { border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 3px solid rgba(255,255,255,0.2); position: relative; overflow: hidden; }
.flat-module-circle::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 40%; background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent); border-radius: 50% 50% 0 0; }
.flat-module-label { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; color: white; font-size: 0.7rem; font-weight: 500; text-align: center; white-space: normal; overflow-wrap: break-word; word-break: normal; max-width: 180px; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
.flat-module-node.dragging { cursor: grabbing; }
.flat-module-node.dragging .flat-module-circle { cursor: grabbing; }
.flat-module-icon { color: white; font-size: 1.5rem; position: relative; z-index: 1; }
.flat-map-controls { position: absolute; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 100; }
.flat-control-btn { width: 40px; height: 40px; border-radius: 10px; border: none; background: rgba(255,255,255,0.95); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: #1e293b; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.flat-control-btn:hover { background: #667eea; color: white; }
.flat-pan-zoom { width: 100%; height: 100%; cursor: grab; }
.flat-pan-zoom:active { cursor: grabbing; }
.flat-pan-zoom-content { position: relative; width: 1400px; height: 900px; transform-origin: center center; }
.node-editor-sidebar { position: fixed; right: 0; top: 56px; bottom: 0; width: 360px; height: calc(100vh - 56px); overflow-y: auto; background: #fff; border-left: 1px solid #e2e8f0; padding: 1.25rem; z-index: 1050; box-shadow: -4px 0 12px rgba(0,0,0,0.08); }
.resource-list .resource-item { display: flex; align-items: center; padding: 0.5rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.5rem; }
.resource-list .resource-item .resource-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; font-size: 1rem; }
.resource-list .resource-item .resource-icon.youtube { background: rgba(255,0,0,0.1); color: #f00; }
.resource-list .resource-item .resource-icon.pdf { background: rgba(239,68,68,0.1); color: #ef4444; }
.resource-list .resource-item .resource-icon.link { background: rgba(6,182,212,0.1); color: #06b6d4; }
.resource-list .resource-item .resource-icon.slides { background: rgba(234,88,12,0.1); color: #ea580c; }
.resource-list .resource-item .flex-grow-1 { min-width: 0; }
.resource-list .resource-item .btn-link { padding: 0 0.25rem; font-size: 0.9rem; }
.flat-context-menu { position: fixed; z-index: 200; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); padding: 0.25rem 0; min-width: 140px; display: none; }
.flat-context-menu.show { display: block; }
.flat-context-menu button { display: block; width: 100%; text-align: left; border: none; background: none; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; }
.flat-context-menu button:hover { background: #f1f5f9; }
.flat-context-menu button:disabled { opacity: 0.5; cursor: default; }
</style>

<script>
(function() {
    const moduleTree = {{ modules_json|safe }};
    const mapContainer = document.getElementById('teacherMapContainer');
    const panZoomContent = document.getElementById('teacherPanZoomContent');
    const connectionsSvg = document.getElementById('teacherConnectionsSvg');
    const modulesLayer = document.getElementById('teacherModulesLayer');
    if (!moduleTree || !modulesLayer) return;

    const CANVAS_W = 1400, CANVAS_H = 900;
    const rootX = 700, rootY = 400;
    const nodesWithPos = [];
    const nodePositions = {};

    function layoutNode(node, cx, cy, depth, siblingIndex, siblingCount, pathTitles) {
        const children = node.children || [];
        const isRoot = depth === 0;
        const radius = isRoot ? 70 : (depth === 1 ? 50 : (depth === 2 ? 35 : 25));
        nodePositions[node.module_id] = { x: cx, y: cy, radius, depth };
        nodesWithPos.push({ node, cx, cy, radius, depth, pathTitles: pathTitles.slice() });
        const n = children.length;
        for (let i = 0; i < n; i++) {
            const angle = (i / Math.max(n, 1)) * Math.PI * 1.8 + Math.PI * 0.1;
            const dist = (isRoot ? 220 : 120) + depth * 60;
            const child = children[i];
            const nx = cx + Math.cos(angle) * dist;
            const ny = cy + Math.sin(angle) * dist;
            layoutNode(child, nx, ny, depth + 1, i, n, pathTitles.concat([child.title]));
        }
    }
    layoutNode(moduleTree, rootX, rootY, 0, 0, 1, [moduleTree.title]);

    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }
    function screenToContent(clientX, clientY) {
        const rect = mapContainer.getBoundingClientRect();
        return { x: (clientX - rect.left - panX) / scale, y: (clientY - rect.top - panY) / scale };
    }
    function updateConnectionLines() {
        const visibleIds = getVisibleIds();
        let pathD = '';
        nodesWithPos.forEach(function(item) {
            if (!visibleIds.has(item.node.module_id)) return;
            (item.node.children || []).forEach(function(c) {
                if (!visibleIds.has(c.module_id)) return;
                const from = nodePositions[item.node.module_id];
                const to = nodePositions[c.module_id];
                if (from && to) pathD += '<line class="flat-connection-line" x1="' + from.x + '" y1="' + from.y + '" x2="' + to.x + '" y2="' + to.y + '"/>';
            });
        });
        connectionsSvg.innerHTML = pathD;
    }

    const expandedIds = new Set();
    function getVisibleIds() {
        const vis = new Set();
        vis.add(moduleTree.module_id);
        function addChildren(n) {
            if (!expandedIds.has(n.module_id)) return;
            (n.children || []).forEach(function(c) {
                vis.add(c.module_id);
                addChildren(c);
            });
        }
        addChildren(moduleTree);
        return vis;
    }

    function redraw() {
        const visibleIds = getVisibleIds();
        let pathD = '';
        nodesWithPos.forEach(function(item) {
            if (!visibleIds.has(item.node.module_id)) return;
            (item.node.children || []).forEach(function(c) {
                if (!visibleIds.has(c.module_id)) return;
                const from = nodePositions[item.node.module_id];
                const to = nodePositions[c.module_id];
                if (from && to) pathD += '<line class="flat-connection-line" x1="' + from.x + '" y1="' + from.y + '" x2="' + to.x + '" y2="' + to.y + '"/>';
            });
        });
        connectionsSvg.innerHTML = pathD;
        connectionsSvg.setAttribute('viewBox', '0 0 ' + CANVAS_W + ' ' + CANVAS_H);
        connectionsSvg.setAttribute('width', '100%');
        connectionsSvg.setAttribute('height', '100%');

        modulesLayer.innerHTML = '';
        nodesWithPos.forEach(function(item) {
            if (!visibleIds.has(item.node.module_id)) return;
            const n = item.node;
            const levelClass = item.depth === 0 ? 'flat-module-root' : (item.depth === 1 ? 'flat-module-l1' : (item.depth === 2 ? 'flat-module-l2' : 'flat-module-l3'));
            const left = item.cx - item.radius;
            const top = item.cy - item.radius;
            const colorStyle = (n.color && n.color.indexOf('#') === 0) ? ('background: linear-gradient(135deg, ' + n.color + ', ' + n.color + 'dd);') : 'background: linear-gradient(135deg, #667eea, #764ba2);';
            const div = document.createElement('div');
            div.className = 'flat-module-node ' + levelClass;
            div.setAttribute('data-node-id', n.module_id);
            div.style.left = left + 'px';
            div.style.top = top + 'px';
            div.innerHTML = '<div class="flat-module-circle" style="' + colorStyle + ' width:' + (item.radius*2) + 'px; height:' + (item.radius*2) + 'px;"><i class="bi ' + (n.icon || 'bi-book') + ' flat-module-icon"></i></div><span class="flat-module-label">' + escapeHtml(n.title) + '</span>';
            div.onclick = function(e) { if (!dragNodeId) { e.stopPropagation(); openNodeEditor(n); } };
            div.oncontextmenu = function(e) { e.preventDefault(); showContextMenu(e, n); };
            div.onmousedown = function(e) { if (e.button === 0) startDrag(e, n, item); };
            modulesLayer.appendChild(div);
        });
    }

    let dragNodeId = null, dragOffsetX = 0, dragOffsetY = 0;
    function startDrag(e, node, item) {
        e.preventDefault();
        e.stopPropagation();
        const pos = screenToContent(e.clientX, e.clientY);
        dragNodeId = node.module_id;
        dragOffsetX = pos.x - item.cx;
        dragOffsetY = pos.y - item.cy;
        document.body.classList.add('flat-dragging');
        const div = modulesLayer.querySelector('[data-node-id="' + node.module_id + '"]');
        if (div) div.classList.add('dragging');
    }
    function onDragMove(e) {
        if (!dragNodeId) return;
        const pos = screenToContent(e.clientX, e.clientY);
        const nx = pos.x - dragOffsetX;
        const ny = pos.y - dragOffsetY;
        const item = nodesWithPos.find(function(p) { return p.node.module_id === dragNodeId; });
        if (!item) return;
        item.cx = nx;
        item.cy = ny;
        nodePositions[dragNodeId].x = nx;
        nodePositions[dragNodeId].y = ny;
        const div = modulesLayer.querySelector('[data-node-id="' + dragNodeId + '"]');
        if (div) { div.style.left = (nx - item.radius) + 'px'; div.style.top = (ny - item.radius) + 'px'; }
        updateConnectionLines();
    }
    function endDrag() {
        if (dragNodeId) {
            const div = modulesLayer.querySelector('[data-node-id="' + dragNodeId + '"]');
            if (div) div.classList.remove('dragging');
            dragNodeId = null;
        }
        document.body.classList.remove('flat-dragging');
    }
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('mouseleave', endDrag);

    let contextNode = null;
    const teacherContextMenu = document.getElementById('teacherContextMenu');
    const teacherExpandBtn = document.getElementById('teacherExpandBtn');
    const teacherCollapseBtn = document.getElementById('teacherCollapseBtn');
    function showContextMenu(e, node) {
        contextNode = node;
        teacherContextMenu.classList.add('show');
        teacherContextMenu.style.left = e.clientX + 'px';
        teacherContextMenu.style.top = e.clientY + 'px';
        const hasChildren = (node.children || []).length > 0;
        teacherExpandBtn.disabled = !hasChildren || expandedIds.has(node.module_id);
        teacherCollapseBtn.disabled = !expandedIds.has(node.module_id);
    }
    function hideContextMenu() {
        teacherContextMenu.classList.remove('show');
        contextNode = null;
    }
    teacherExpandBtn.onclick = function() {
        if (contextNode) expandedIds.add(contextNode.module_id);
        redraw();
        hideContextMenu();
    };
    teacherCollapseBtn.onclick = function() {
        if (contextNode) expandedIds.delete(contextNode.module_id);
        redraw();
        hideContextMenu();
    };
    document.addEventListener('click', hideContextMenu);
    document.addEventListener('scroll', hideContextMenu, true);

    redraw();

    const nodeEditor = document.getElementById('nodeEditor');
    const closeNodeEditor = document.getElementById('closeNodeEditor');
    const nodeEditorForm = document.getElementById('nodeEditorForm');
    const editNodeId = document.getElementById('editNodeId');
    const editTitle = document.getElementById('editTitle');
    const editDescription = document.getElementById('editDescription');
    const editLearningObjectives = document.getElementById('editLearningObjectives');
    const editCustomPrompt = document.getElementById('editCustomPrompt');
    const resourceList = document.getElementById('resourceList');
    const resourceCount = document.getElementById('resourceCount');
    const addResourceBtn = document.getElementById('addResourceBtn');
    const addResourceModal = document.getElementById('addResourceModal');
    const saveResourceBtn = document.getElementById('saveResourceBtn');

    function findNode(tree, id) {
        if (tree.module_id === id) return tree;
        for (const c of (tree.children || [])) {
            const found = findNode(c, id);
            if (found) return found;
        }
        return null;
    }

    function openNodeEditor(nodeData) {
        document.querySelectorAll('#teacherModulesLayer .flat-module-node.selected').forEach(function(el) { el.classList.remove('selected'); });
        const el = document.querySelector('[data-node-id="' + nodeData.module_id + '"]');
        if (el) el.classList.add('selected');
        editNodeId.value = nodeData.module_id;
        editTitle.value = nodeData.title || '';
        editDescription.value = nodeData.description || '';
        editLearningObjectives.value = Array.isArray(nodeData.learning_objectives) ? nodeData.learning_objectives.join('\n') : (nodeData.learning_objectives || '');
        editCustomPrompt.value = nodeData.custom_prompt || '';
        nodeEditor.style.display = 'block';
        loadResources(nodeData.module_id);
    }

    async function loadResources(nodeId) {
        try {
            const res = await fetch('{{ url_for("manage_module_resources", module_id=module.module_id, node_id="__NODE__") }}'.replace('__NODE__', encodeURIComponent(nodeId)));
            const data = await res.json();
            const list = (data.resources || []);
            resourceCount.textContent = list.length;
            resourceList.innerHTML = list.map(function(r) {
                const icons = { youtube: 'bi-youtube', pdf: 'bi-file-pdf', slides: 'bi-file-earmark-slides', link: 'bi-link-45deg' };
                const icon = icons[r.type] || 'bi-link-45deg';
                const iconCls = r.type === 'youtube' ? 'youtube' : (r.type === 'pdf' ? 'pdf' : (r.type === 'slides' ? 'slides' : 'link'));
                return '<div class="resource-item"><div class="resource-icon ' + iconCls + '"><i class="bi ' + icon + '"></i></div><div class="flex-grow-1 small text-truncate" title="' + (r.title || '') + '">' + (r.title || 'Resource') + '</div><button type="button" class="btn btn-link text-danger p-0 delete-resource" data-resource-id="' + (r.resource_id || '') + '"><i class="bi bi-trash"></i></button></div>';
            }).join('');
            resourceList.querySelectorAll('.delete-resource').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const rid = this.getAttribute('data-resource-id');
                    if (!rid || !confirm('Remove this resource?')) return;
                    fetch('{{ url_for("delete_module_resource", module_id=module.module_id, node_id="__NODE__", resource_id="__RID__") }}'.replace('__NODE__', encodeURIComponent(nodeId)).replace('__RID__', encodeURIComponent(rid)), { method: 'DELETE' })
                        .then(function(r) { return r.json(); })
                        .then(function(d) { if (d.success) loadResources(nodeId); });
                });
            });
        } catch (e) { resourceList.innerHTML = '<div class="small text-muted">Could not load resources.</div>'; resourceCount.textContent = '0'; }
    }

    let scale = 1, panX = 0, panY = 0, isPan = false, startX, startY;
    function updateTransform() {
        panZoomContent.style.transform = 'translate(' + panX + 'px, ' + panY + 'px) scale(' + scale + ')';
    }
    function centerContent() {
        if (!mapContainer) return;
        const rect = mapContainer.getBoundingClientRect();
        panX = (rect.width - CANVAS_W * scale) / 2;
        panY = (rect.height - CANVAS_H * scale) / 2;
        updateTransform();
    }
    document.getElementById('teacherZoomIn').onclick = function() { scale = Math.min(scale * 1.2, 2); updateTransform(); };
    document.getElementById('teacherZoomOut').onclick = function() { scale = Math.max(scale / 1.2, 0.4); updateTransform(); };
    document.getElementById('teacherResetView').onclick = function() { scale = 1; centerContent(); };
    document.getElementById('teacherPanZoom').addEventListener('mousedown', function(e) {
        if (e.target.closest('.flat-module-node')) return;
        isPan = true; startX = e.clientX - panX; startY = e.clientY - panY;
        document.getElementById('teacherPanZoom').style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', function(e) {
        if (!isPan) return;
        panX = e.clientX - startX; panY = e.clientY - startY;
        updateTransform();
    });
    document.addEventListener('mouseup', function() {
        isPan = false;
        var pz = document.getElementById('teacherPanZoom');
        if (pz) pz.style.cursor = 'grab';
    });
    document.getElementById('teacherPanZoom').addEventListener('wheel', function(e) {
        e.preventDefault();
        scale = Math.max(0.4, Math.min(2, scale * (e.deltaY > 0 ? 0.9 : 1.1)));
        updateTransform();
    }, { passive: false });
    window.addEventListener('load', centerContent);
    window.addEventListener('resize', centerContent);

    closeNodeEditor && closeNodeEditor.addEventListener('click', function() { nodeEditor.style.display = 'none'; });

    nodeEditorForm && nodeEditorForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const nodeId = editNodeId.value;
        const objectivesText = editLearningObjectives.value.trim();
        const objectives = objectivesText ? objectivesText.split(/\n/).map(function(s) { return s.trim(); }).filter(Boolean) : [];
        try {
            const res = await fetch('{{ url_for("update_module_node", module_id=module.module_id, node_id="__NODE__") }}'.replace('__NODE__', encodeURIComponent(nodeId)), {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: editTitle.value.trim(),
                    description: editDescription.value.trim(),
                    learning_objectives: objectives,
                    custom_prompt: editCustomPrompt.value.trim(),
                }),
            });
            const data = await res.json();
            if (data.success) {
                var nd = findNode(moduleTree, nodeId);
                if (nd) { nd.title = editTitle.value.trim(); nd.description = editDescription.value.trim(); nd.learning_objectives = objectives; nd.custom_prompt = editCustomPrompt.value.trim(); }
                var sel = document.querySelector('[data-node-id="' + nodeId + '"] .flat-module-label');
                if (sel) sel.textContent = editTitle.value.trim().length > 12 ? editTitle.value.trim().slice(0,11) + '…' : editTitle.value.trim();
                alert('Saved.');
            } else alert(data.error || 'Save failed');
        } catch (err) { alert('Save failed'); }
    });

    document.getElementById('resType').addEventListener('change', function() {
        const wrap = document.getElementById('resPdfUploadWrap');
        if (wrap) wrap.classList.toggle('d-none', this.value !== 'pdf');
    });
    addResourceBtn && addResourceBtn.addEventListener('click', function() {
        document.getElementById('resTitle').value = '';
        document.getElementById('resUrl').value = '';
        const pdfInput = document.getElementById('resPdfFile');
        if (pdfInput) { pdfInput.value = ''; }
        document.getElementById('resPdfUploadWrap').classList.toggle('d-none', document.getElementById('resType').value !== 'pdf');
        addResourceModal.setAttribute('data-edit-node-id', editNodeId.value);
        new bootstrap.Modal(addResourceModal).show();
    });
    saveResourceBtn && saveResourceBtn.addEventListener('click', function() {
        const nodeId = addResourceModal.getAttribute('data-edit-node-id');
        const type = document.getElementById('resType').value;
        const title = document.getElementById('resTitle').value.trim();
        const url = document.getElementById('resUrl').value.trim();
        const pdfFile = document.getElementById('resPdfFile').files[0];
        const MAX_PDF_MB = 10;
        if (!title) { alert('Title required'); return; }
        if (type === 'pdf') {
            if (!url && !pdfFile) { alert('Provide a PDF link (URL) or upload a PDF file'); return; }
            if (pdfFile && pdfFile.size > MAX_PDF_MB * 1024 * 1024) { alert('PDF must be ' + MAX_PDF_MB + ' MB or smaller'); return; }
        } else if (!url) { alert('URL required'); return; }
        const formData = new FormData();
        formData.append('type', type);
        formData.append('title', title);
        formData.append('url', url || '');
        if (pdfFile) formData.append('file', pdfFile);
        fetch('{{ url_for("manage_module_resources", module_id=module.module_id, node_id="__NODE__") }}'.replace('__NODE__', encodeURIComponent(nodeId)), { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (d.success) { bootstrap.Modal.getInstance(addResourceModal).hide(); loadResources(nodeId); }
                else alert(d.error || 'Failed to add');
            });
    });

    document.getElementById('publish-btn') && document.getElementById('publish-btn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        try {
            const res = await fetch('{{ url_for("publish_module", module_id=module.module_id) }}', { method: 'POST' });
            const data = await res.json();
            if (data.success) window.location.reload();
        } finally { btn.disabled = false; }
    });

    document.getElementById('delete-module-tree-btn') && document.getElementById('delete-module-tree-btn').addEventListener('click', function() {
        if (!confirm('Delete this entire module tree? All nodes, resources, and student progress will be removed. This cannot be undone.')) return;
        const btn = this;
        btn.disabled = true;
        fetch('{{ url_for("delete_module_tree", module_id=module.module_id) }}', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) window.location.href = '{{ url_for("teacher_modules") }}';
                else { alert(data.error || 'Delete failed'); btn.disabled = false; }
            })
            .catch(function() { alert('Delete failed'); btn.disabled = false; });
    });

    // Textbook RAG
    const moduleId = '{{ module.module_id }}';
    const textbookStatus = document.getElementById('textbook-status');
    const textbookUploadArea = document.getElementById('textbook-upload-area');
    const textbookDeleteArea = document.getElementById('textbook-delete-area');
    const textbookMessage = document.getElementById('textbook-message');

    function showTextbookMessage(msg, isError) {
        textbookMessage.textContent = msg;
        textbookMessage.className = 'alert alert-' + (isError ? 'danger' : 'success') + ' mt-2';
        textbookMessage.classList.remove('d-none');
    }
    function hideTextbookMessage() { textbookMessage.classList.add('d-none'); }

    function loadTextbookStatus() {
        textbookStatus.innerHTML = '<span class="text-muted">Loading…</span>';
        fetch('/teacher/modules/' + encodeURIComponent(moduleId) + '/textbook')
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (d.has_textbook) {
                    textbookStatus.innerHTML = '<i class="bi bi-journal-check text-success me-1"></i><strong>' + (d.name || 'Textbook') + '</strong>';
                    if (d.chunk_count) textbookStatus.innerHTML += ' <span class="text-muted">(' + d.chunk_count + ' chunks';
                    if (d.upload_count > 0) textbookStatus.innerHTML += ' · ' + d.upload_count + ' upload' + (d.upload_count === 1 ? '' : 's');
                    if (d.chunk_count) textbookStatus.innerHTML += ')</span>';
                    textbookUploadArea.style.display = 'block';
                    textbookDeleteArea.style.display = 'block';
                } else {
                    textbookStatus.innerHTML = '<span class="text-muted">No content yet. Upload a PDF (or add chapters one at a time) so the AI tutor can answer from it.</span>';
                    textbookUploadArea.style.display = 'block';
                    textbookDeleteArea.style.display = 'none';
                }
            })
            .catch(function() { textbookStatus.innerHTML = '<span class="text-danger">Could not load status</span>'; textbookUploadArea.style.display = 'block'; });
    }
    loadTextbookStatus();

    document.getElementById('textbook-upload-form') && document.getElementById('textbook-upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const file = document.getElementById('textbook-file').files[0];
        if (!file) { showTextbookMessage('Please select a PDF file', true); return; }
        const formData = new FormData();
        formData.append('textbook_file', file);
        formData.append('title', document.getElementById('textbook-title').value.trim());
        const btn = document.getElementById('textbook-upload-btn');
        btn.disabled = true;
        hideTextbookMessage();
        fetch('/teacher/modules/' + encodeURIComponent(moduleId) + '/textbook', { method: 'POST', body: formData })
            .then(function(r) { return r.json().catch(function() { return {}; }); })
            .then(function(d) {
                if (d.success) {
                    var msg = d.total_chunk_count != null
                        ? 'Added ' + (d.chunk_count || 0) + ' chunks; total ' + d.total_chunk_count + ' chunks.'
                        : 'Uploaded: ' + (d.chunk_count || 0) + ' chunks indexed.';
                    showTextbookMessage(msg);
                    loadTextbookStatus();
                    document.getElementById('textbook-file').value = '';
                }
                else showTextbookMessage(d.error || 'Upload failed', true);
            })
            .catch(function() { showTextbookMessage('Network error', true); })
            .finally(function() { btn.disabled = false; });
    });

    document.getElementById('textbook-delete-btn') && document.getElementById('textbook-delete-btn').addEventListener('click', function() {
        if (!confirm('Remove the textbook from this module? The AI will no longer use it for answers.')) return;
        fetch('/teacher/modules/' + encodeURIComponent(moduleId) + '/textbook', { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(d) { if (d.success) { loadTextbookStatus(); hideTextbookMessage(); } else showTextbookMessage(d.error || 'Delete failed', true); })
            .catch(function() { showTextbookMessage('Network error', true); });
    });
})();
</script>
{% endblock %}
